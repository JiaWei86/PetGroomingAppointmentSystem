@{
    ViewData["Title"] = "Book an Appointment";
}

<link rel="stylesheet" href="~/Customer/css/appointment.css"/>

<!-- bradcam_area_start -->
<div class="bradcam_area breadcam_bg">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="bradcam_text text-center wow fadeInUp" data-wow-delay="0.2s">
                    <h3>Schedule Your Pet's Appointment</h3>
                </div>
            </div>
        </div>
    </div>
</div>


        <div class="appt-bg">
            <div class="appt-row">
                <!-- Calendar card -->
                <div class="card calendar-card" role="region" aria-label="appointments calendar">
                    <div class="cal-head">
                        <div class="cal-title" id="monthTitle">Month Year</div>
                        <div class="nav">
                            <button id="prevBtn" class="nav-btn" aria-label="Previous month">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <button id="nextBtn" class="nav-btn" aria-label="Next month">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="weekdays" aria-hidden="true">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>

                    <div class="days" id="daysGrid"></div>

                    <div class="calendar-footer">
                        <button type="button" id="todayBtn" class="today-btn">Today</button>
                    </div>

                    <div class="legend" aria-hidden="true">
                        <div class="legend-row">
                            <div class="legend-item"><span class="legend-color rateus"></span><span class="muted">Rate Us</span></div>
                            <div class="legend-item"><span class="legend-color visited"></span><span class="muted">Visited</span></div>
                            <div class="legend-item"><span class="legend-color confirmed"></span><span class="muted">Confirmed</span></div>
                        </div>
                        <div class="legend-row">
                            <div class="legend-item"><span class="legend-color noshow"></span><span class="muted">No Show</span></div>
                            <div class="legend-item"><span class="legend-color pending"></span><span class="muted">Pending</span></div>
                            <div class="legend-item"><span class="legend-color unavailable"></span><span class="muted">Unavailable</span></div>
                        </div>
                    </div>
                </div>

                <!-- Form card -->
                <div class="card form-card" id="formPanel" aria-live="polite">
                    <div id="formPlaceholder" class="muted">Select a date (today or a future date) to show the booking form.</div>

                    <form id="apptForm" style="display:none;" onsubmit="return false;" class="appt-form">
                        <fieldset>
                            <legend>Booking Details</legend>

                            <div class="form-group">
                                <label class="form-label">Selected Date</label>
                                <input id="selectedDateText" type="text" readonly class="form-control date-display" />
                            </div>

                            <div class="form-group">
                                <label for="categorySelect" class="form-label">Pet Category <span class="required">*</span></label>
                                <input id="categorySelect" type="text" readonly class="form-control" />
                                <!-- Hidden input to store the value -->
                                <input id="categoryValue" type="hidden" />
                            </div>

                            <div class="form-group pet-grid">
                                <label class="form-label">Choose Pet(s) <span class="required">*</span></label>
                                <div id="petCards" class="pet-cards" aria-live="polite"></div>
                                <div class="form-hint">Select one or more pets for the appointment</div>

                                <div class="pet-actions">
                                    <button type="button" id="showAddNewBtn" class="btn btn-secondary btn-sm">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Add New Pet
                                    </button>
                                </div>

                                <div id="newPetBlock" class="new-pet-block">
                                    <h4>Add New Pet</h4>
                                    <div class="form-group">
                                        <label for="newPetName" class="form-label">Pet Name <span class="required">*</span></label>
                                        <input id="newPetName" type="text" placeholder="e.g., Buddy" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="newPetType" class="form-label">Pet Type</label>
                                        <input id="newPetType" type="text" readonly class="form-control" disabled />
                                    </div>
                                    <div class="form-group">
                                        <label for="newPetPhoto" class="form-label">Photo (Optional)</label>
                                        <div class="file-upload">
                                            <input id="newPetPhoto" type="file" accept="image/*" class="file-input" />
                                            <label for="newPetPhoto" class="file-label">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                    <polyline points="21 15 16 10 5 21"></polyline>
                                                </svg>
                                                Choose photo
                                            </label>
                                        </div>
                                        <div class="newpet-preview" id="newPetPreview">
                                            <img id="newPetPreviewImg" src="" alt="Preview" />
                                        </div>
                                        <small class="form-hint">JPG, PNG up to 5MB</small>
                                    </div>

                                    <div class="form-actions">
                                        <button type="button" id="savePetBtn" class="btn btn-primary btn-sm">Save Pet</button>
                                        <button type="button" id="cancelNewPetBtn" class="btn btn-outline btn-sm">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend>Service Details</legend>

                            <div class="form-group" id="serviceDetailsSection" style="display:none;">
                                <label class="form-label">Select Service <span class="required">*</span></label>
                                <div id="serviceDetailsList" class="service-details-list"></div>
                                <small class="form-hint">Select the service you want to book</small>
                            </div>

                            <div class="form-group">
                                <label for="timeSelect" class="form-label">Preferred Time <span class="required">*</span></label>
                                <select id="timeSelect" required class="form-control">
                                    <option value="" disabled selected>-- Select time --</option>
                                </select>
                                <small class="form-hint">Available 9:00 AM - 4:30 PM</small>
                            </div>

                            <div class="form-group">
                                <label for="groomerSelect" class="form-label">Preferred Groomer</label>
                                <select id="groomerSelect" class="form-control">
                                    <option value="any">Any Available</option>
                                    <option value="alice">👩‍💼 Alice</option>
                                    <option value="ben">👨‍💼 Ben</option>
                                    <option value="cara">👩‍💼 Cara</option>
                                </select>
                                <small class="form-hint">Leave blank for automatic assignment</small>
                            </div>

                            <div class="form-group">
                                <label for="notes" class="form-label">Special Requests</label>
                                <textarea id="notes" placeholder="Allergies, behavior notes, special instructions..." class="form-control" rows="4"></textarea>
                                <small class="form-hint" id="charCount">0 / 500 characters</small>
                            </div>
                        </fieldset>

                        <div class="form-actions-main">
                            <button id="submitBtn" type="button" class="btn btn-primary btn-lg">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Submit Appointment Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Success toast -->
        <div id="apptSuccessToast" class="appt-toast appt-toast--success" aria-live="polite" role="status" style="display:none;">
            <div class="toast-content">
                <div class="toast-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="toast-body">
                    <div class="toast-title">Appointment Request Submitted!</div>
                    <div class="toast-message">We'll confirm your booking shortly</div>
                </div>
                <button class="toast-close" id="apptSuccessClose" aria-label="Close notification">&times;</button>
            </div>
        </div>

        <!-- Error toast -->
        <div id="apptErrorToast" class="appt-toast appt-toast--error" aria-live="polite" role="alert" style="display:none;">
            <div class="toast-content">
                <div class="toast-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                </div>
                <div class="toast-body">
                    <div class="toast-title">Error</div>
                    <div class="toast-message" id="errorToastMsg">Please fill in all required fields</div>
                </div>
                <button class="toast-close" id="apptErrorClose" aria-label="Close notification">&times;</button>
            </div>
        </div>
    </div>
</section>

<script>
    (function(){
        // Configuration
        const CONFIG = {
            PLACEHOLDER_IMG: '/mnt/data/dbc0ff5e-4bb2-4648-ab38-94af11a53bb9.png',
            TIME_START: 9,
            TIME_END: 16,
            TIME_INTERVAL: 30,
            TOAST_DURATION: 3500,
            MAX_NOTES_LENGTH: 500,
            CLOSED_DAYS: [1] // Monday
        };

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const initialPetType = urlParams.get('petType');
        const selectedServiceId = urlParams.get('serviceId');
        const selectedServiceName = urlParams.get('serviceName') ? decodeURIComponent(urlParams.get('serviceName')) : null;
        const selectedServiceDescription = urlParams.get('description') ? decodeURIComponent(urlParams.get('description')) : null;
        const selectedServicePrice = urlParams.get('price');
        const selectedServiceDuration = urlParams.get('duration');

        // Initial user pets - will be loaded from database
        let userPets = [];

        // Available services by category - will be populated from database
        const servicesByCategory = {
            'dog': [],
            'cat': []
        };

        // DOM Elements
        const elements = {
            daysGrid: document.getElementById('daysGrid'),
            monthTitle: document.getElementById('monthTitle'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            todayBtn: document.getElementById('todayBtn'),
            formPlaceholder: document.getElementById('formPlaceholder'),
            apptForm: document.getElementById('apptForm'),
            selectedDateText: document.getElementById('selectedDateText'),
            categorySelect: document.getElementById('categorySelect'),
            petCards: document.getElementById('petCards'),
            showAddNewBtn: document.getElementById('showAddNewBtn'),
            newPetBlock: document.getElementById('newPetBlock'),
            newPetName: document.getElementById('newPetName'),
            newPetType: document.getElementById('newPetType'),
            newPetPhoto: document.getElementById('newPetPhoto'),
            newPetPreview: document.getElementById('newPetPreview'),
            newPetPreviewImg: document.getElementById('newPetPreviewImg'),
            savePetBtn: document.getElementById('savePetBtn'),
            cancelNewPetBtn: document.getElementById('cancelNewPetBtn'),
            timeSelect: document.getElementById('timeSelect'),
            groomerSelect: document.getElementById('groomerSelect'),
            notes: document.getElementById('notes'),
            charCount: document.getElementById('charCount'),
            submitBtn: document.getElementById('submitBtn'),
            successToast: document.getElementById('apptSuccessToast'),
            errorToast: document.getElementById('apptErrorToast'),
            successClose: document.getElementById('apptSuccessClose'),
            errorClose: document.getElementById('apptErrorClose'),
            errorMsg: document.getElementById('errorToastMsg')
        };

        let calendarState = new Date();
        calendarState.setDate(1);

        // Utility Functions
        function pad(n) { return String(n).padStart(2, '0'); }
        function isAllowed(dateObj) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dateObj.getTime() >= today.getTime();
        }
        function isClosedDay(dateObj) {
            return CONFIG.CLOSED_DAYS.includes(dateObj.getDay());
        }

        function generateTimeSlots() {
            const slots = [];
            const start = CONFIG.TIME_START * 60;
            const end = CONFIG.TIME_END * 60 + CONFIG.TIME_INTERVAL;
            
            for (let t = start; t <= end; t += CONFIG.TIME_INTERVAL) {
                const hours = String(Math.floor(t / 60)).padStart(2, '0');
                const mins = String(t % 60).padStart(2, '0');
                slots.push(`${hours}:${mins}`);
            }
            return slots;
        }

        function populateTimeSlots() {
            elements.timeSelect.innerHTML = '<option value="" disabled selected>-- Select time --</option>';
            generateTimeSlots().forEach(slot => {
                const option = document.createElement('option');
                option.value = slot;
                option.textContent = slot;
                elements.timeSelect.appendChild(option);
            });
        }

        // Services Display - Shows services from database
        function renderServiceDetails() {
            const category = elements.categorySelect.value;
            const serviceDetailsSection = document.getElementById('serviceDetailsSection');
            const serviceDetailsList = document.getElementById('serviceDetailsList');

            if (!serviceDetailsSection) {
                console.warn('Service details section not found in HTML');
                return;
            }

            if (!category) {
                serviceDetailsSection.style.display = 'none';
                return;
            }

            const services = servicesByCategory[category] || [];
            serviceDetailsList.innerHTML = '';

            if (services.length === 0) {
                serviceDetailsSection.style.display = 'none';
                return;
            }

            services.forEach(service => {
                const label = document.createElement('label');
                label.className = 'service-item';

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'service';
                input.value = service.id;
                input.className = 'service-radio';
                
                // Auto-select if this was the service clicked from index page
                if (selectedServiceId && service.id === selectedServiceId) {
                    input.checked = true;
                }

                const details = document.createElement('div');
                details.className = 'service-details';

                const name = document.createElement('div');
                name.className = 'service-name';
                name.textContent = service.name;

                const meta = document.createElement('div');
                meta.className = 'service-meta';
                const price = service.price || 'N/A';
                const duration = service.duration || 'N/A';
                meta.textContent = `${price} • ${duration}`;

                details.appendChild(name);
                details.appendChild(meta);

                label.appendChild(input);
                label.appendChild(details);
                serviceDetailsList.appendChild(label);
            });

            serviceDetailsSection.style.display = 'block';
        }

        // Character counter
        elements.notes.addEventListener('input', function() {
            const count = this.value.length;
            elements.charCount.textContent = `${count} / ${CONFIG.MAX_NOTES_LENGTH} characters`;
            if (count > CONFIG.MAX_NOTES_LENGTH) {
                this.value = this.value.substring(0, CONFIG.MAX_NOTES_LENGTH);
            }
        });

        // Calendar Rendering
        function renderCalendar() {
            elements.daysGrid.innerHTML = '';
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            elements.monthTitle.textContent = `${monthNames[calendarState.getMonth()]} ${calendarState.getFullYear()}`;

            const year = calendarState.getFullYear();
            const month = calendarState.getMonth();
            const firstDay = new Date(year, month, 1);
            const startDay = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevDays = new Date(year, month, 0).getDate();
            const statuses = getMonthStatuses(calendarState);

            for (let i = 0; i < 42; i++) {
                const cell = document.createElement('div');
                cell.className = 'day';
                
                let dayNum, cellDate, isOutside = false;
                const index = i - startDay + 1;

                if (index <= 0) {
                    dayNum = prevDays + index;
                    isOutside = true;
                    cellDate = new Date(year, month - 1, dayNum);
                } else if (index > daysInMonth) {
                    dayNum = index - daysInMonth;
                    isOutside = true;
                    cellDate = new Date(year, month + 1, dayNum);
                } else {
                    dayNum = index;
                    cellDate = new Date(year, month, dayNum);
                }

                if (isOutside) cell.classList.add('day--outside');

                const isClosed = isClosedDay(cellDate);
                if (isClosed) {
                    cell.classList.add('day--closed');
                    cell.setAttribute('aria-disabled', 'true');
                }

                const numSpan = document.createElement('span');
                numSpan.className = 'day-num';
                numSpan.textContent = dayNum;
                cell.appendChild(numSpan);

                const y = cellDate.getFullYear();
                const m = pad(cellDate.getMonth() + 1);
                const d = pad(cellDate.getDate());
                const key = `${y}-${m}-${d}`;
                const status = statuses[key];

                if (status) {
                    cell.classList.add(`day--${status}`);
                    const dot = document.createElement('span');
                    dot.className = 'day-dot';
                    dot.setAttribute('aria-hidden', 'true');
                    cell.appendChild(dot);
                }

                if (!isOutside && isAllowed(cellDate) && !isClosed) {
                    cell.classList.add('day--selectable');
                    cell.addEventListener('click', () => selectDate(cellDate));
                } else {
                    cell.classList.add('day--disabled');
                }

                elements.daysGrid.appendChild(cell);
            }
        }

        function getMonthStatuses(dateObj) {
            const y = dateObj.getFullYear();
            const m = pad(dateObj.getMonth() + 1);
            return {
                [`${y}-${m}-05`]: 'visited',
                [`${y}-${m}-12`]: 'pending',
                [`${y}-${m}-18`]: 'noshow',
                [`${y}-${m}-24`]: 'confirmed',
                [`${y}-${m}-02`]: 'rateus',
                [`${y}-${m}-27`]: 'unavailable'
            };
        }

        function selectDate(dateObj) {
            if (isClosedDay(dateObj)) {
                showErrorToast('Sorry, we are closed on Mondays. Please select another date.');
                return;
            }

            const previousSelected = elements.daysGrid.querySelector('.day--selected');
            if (previousSelected) previousSelected.classList.remove('day--selected');

            Array.from(elements.daysGrid.children).forEach(cell => {
                if (cell.textContent.trim() === String(dateObj.getDate())) {
                    cell.classList.add('day--selected');
                }
            });

            elements.selectedDateText.value = `${dateObj.getFullYear()}-${pad(dateObj.getMonth() + 1)}-${pad(dateObj.getDate())}`;
            populateTimeSlots();
            elements.apptForm.style.display = 'block';
            elements.formPlaceholder.style.display = 'none';
            elements.apptForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideForm() {
            elements.apptForm.style.display = 'none';
            elements.formPlaceholder.style.display = 'flex';
            const selected = elements.daysGrid.querySelector('.day--selected');
            if (selected) selected.classList.remove('day--selected');
        }

        // Pet Cards Rendering
        function renderPetCards() {
            const category = elements.categorySelect.value;
            elements.petCards.innerHTML = '';

            if (!category) {
                elements.petCards.innerHTML = '<div class="form-hint">Select a category to see pets</div>';
                return;
            }

            const filteredPets = userPets.filter(p => p.category === category);
            if (filteredPets.length === 0) {
                elements.petCards.innerHTML = '<div class="form-hint">No pets in this category. Add a new pet to get started.</div>';
                return;
            }

            filteredPets.forEach(pet => {
                const card = document.createElement('label');
                card.className = 'pet-card';
                card.setAttribute('data-id', pet.id);

                const img = document.createElement('img');
                img.src = pet.photo || CONFIG.PLACEHOLDER_IMG;
                img.alt = pet.name;
                img.className = 'pet-card-img';

                const info = document.createElement('div');
                info.className = 'pet-info';

                const name = document.createElement('div');
                name.className = 'pet-name';
                name.textContent = pet.name;

                const meta = document.createElement('div');
                meta.className = 'pet-meta';
                meta.textContent = pet.category === 'dog' ? 'Dog' : 'Cat';

                info.appendChild(name);
                info.appendChild(meta);

                const checkboxWrap = document.createElement('div');
                checkboxWrap.className = 'pet-checkbox-wrap';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = pet.id;
                checkbox.className = 'pet-checkbox';
                checkbox.setAttribute('aria-label', `Select ${pet.name}`);

                checkboxWrap.appendChild(checkbox);

                card.appendChild(img);
                card.appendChild(info);
                card.appendChild(checkboxWrap);

                card.addEventListener('click', (e) => {
                    if (e.target === checkbox) return;
                    checkbox.checked = !checkbox.checked;
                });

                elements.petCards.appendChild(card);
            });
        }

        // Add New Pet Flow
        function startAddNewPet() {
            if (!elements.categorySelect.value) {
                showErrorToast('Please select a pet category first');
                return;
            }
            elements.categorySelect.disabled = true;
            elements.newPetType.value = elements.categorySelect.value === 'dog' ? 'Dog' : 'Cat';
            elements.newPetBlock.style.display = 'block';
            elements.newPetPreview.style.display = 'none';
            elements.newPetName.focus();
        }

        function cancelAddNewPet() {
            elements.newPetBlock.style.display = 'none';
            elements.newPetName.value = '';
            elements.newPetType.value = '';
            elements.newPetPhoto.value = '';
            elements.newPetPreviewImg.src = '';
            elements.newPetPreview.style.display = 'none';
            elements.categorySelect.disabled = false;
            renderPetCards();
        }

        elements.newPetPhoto.addEventListener('change', function() {
            const file = this.files?.[0];
            if (!file) {
                elements.newPetPreviewImg.src = '';
                elements.newPetPreview.style.display = 'none';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                elements.newPetPreviewImg.src = e.target.result;
                elements.newPetPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        function saveNewPet() {
            const category = elements.categorySelect.value;
            const name = elements.newPetName.value.trim();

            if (!name) {
                showErrorToast('Please enter a pet name');
                elements.newPetName.focus();
                return;
            }

            const file = elements.newPetPhoto.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => pushNewPet(name, category, e.target.result);
                reader.readAsDataURL(file);
            } else {
                pushNewPet(name, category, CONFIG.PLACEHOLDER_IMG);
            }
        }

        function pushNewPet(name, category, imgSrc) {
            const id = 'p' + Date.now();
            userPets.push({ id, name, category, photo: imgSrc });
            elements.categorySelect.disabled = false;
            elements.newPetBlock.style.display = 'none';
            elements.newPetName.value = '';
            elements.newPetType.value = '';
            elements.newPetPhoto.value = '';
            elements.newPetPreviewImg.src = '';
            elements.newPetPreview.style.display = 'none';
            renderPetCards();

            setTimeout(() => {
                const checkbox = elements.petCards.querySelector(`input[value="${id}"]`);
                if (checkbox) checkbox.checked = true;
            }, 50);
        }

        function getSelectedPets() {
            const checkboxes = Array.from(elements.petCards.querySelectorAll('input[type="checkbox"]:checked'));
            return checkboxes
                .map(cb => userPets.find(p => p.id === cb.value))
                .filter(Boolean);
        }

        // Toast Helpers
        function showToast(element, duration = CONFIG.TOAST_DURATION) {
            element.style.display = 'flex';
            void element.offsetWidth;
            element.classList.add('show');
            clearTimeout(element._hideTimer);
            element._hideTimer = setTimeout(() => hideToast(element), duration);
        }

        function hideToast(element) {
            element.classList.remove('show');
            clearTimeout(element._removeTimer);
            element._removeTimer = setTimeout(() => {
                element.style.display = 'none';
            }, 350);
        }

        function showSuccessToast() {
            showToast(elements.successToast);
        }

        function showErrorToast(message) {
            elements.errorMsg.textContent = message;
            showToast(elements.errorToast);
        }

        elements.successClose.addEventListener('click', () => hideToast(elements.successToast));
        elements.errorClose.addEventListener('click', () => hideToast(elements.errorToast));

        // Validation
        function validateForm() {
            if (!elements.selectedDateText.value) {
                showErrorToast('Please select a date');
                return false;
            }

            if (!elements.categorySelect.value) {
                showErrorToast('Please select a pet category');
                return false;
            }

            const selectedPets = getSelectedPets();
            if (selectedPets.length === 0) {
                showErrorToast('Please select at least one pet');
                return false;
            }

            if (!elements.timeSelect.value) {
                showErrorToast('Please select a time');
                return false;
            }

            const selectedService = document.querySelector('input[name="service"]:checked');
            if (!selectedService) {
                showErrorToast('Please select a service');
                return false;
            }

            return true;
        }

        // Event Listeners
        elements.prevBtn.addEventListener('click', () => {
            calendarState.setMonth(calendarState.getMonth() - 1);
            renderCalendar();
            hideForm();
        });

        elements.nextBtn.addEventListener('click', () => {
            calendarState.setMonth(calendarState.getMonth() + 1);
            renderCalendar();
            hideForm();
        });

        elements.todayBtn.addEventListener('click', () => {
            const today = new Date();
            if (isClosedDay(today)) {
                showErrorToast('Today is closed. Please select another date.');
                return;
            }
            calendarState = new Date();
            calendarState.setDate(1);
            renderCalendar();
            selectDate(today);
        });

        elements.categorySelect.addEventListener('change', () => {
            renderPetCards();
            renderServiceDetails();
        });

        elements.showAddNewBtn.addEventListener('click', startAddNewPet);
        elements.cancelNewPetBtn.addEventListener('click', cancelAddNewPet);
        elements.savePetBtn.addEventListener('click', saveNewPet);

        elements.submitBtn.addEventListener('click', async () => {
            if (!validateForm()) return;

            const selectedPets = getSelectedPets();
            const selectedService = document.querySelector('input[name="service"]:checked');
            
            const appointmentData = {
                date: elements.selectedDateText.value,
                time: elements.timeSelect.value,
                serviceId: selectedService.value,
                petIds: selectedPets.map(p => p.id),
                groomer: elements.groomerSelect.value || 'any',
                notes: elements.notes.value.trim()
            };

            try {
                // Disable submit button to prevent double submission
                elements.submitBtn.disabled = true;
                const originalText = elements.submitBtn.innerHTML;
                elements.submitBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Submitting...';

                const response = await fetch('/Customer/Home/SaveAppointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessToast();
                    
                    // Clear form after successful submission
                    setTimeout(() => {
                        hideForm();
                        elements.apptForm.reset();
                        elements.notes.dispatchEvent(new Event('input'));
                        renderCalendar();
                        renderPetCards();
                        
                        // Reset button state
                        elements.submitBtn.disabled = false;
                        elements.submitBtn.innerHTML = originalText;
                    }, 1500);
                } else {
                    showErrorToast(result.message || 'Failed to save appointment');
                    elements.submitBtn.disabled = false;
                    elements.submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorToast('An error occurred while saving the appointment');
                elements.submitBtn.disabled = false;
                elements.submitBtn.innerHTML = originalText;
            }
        });

        // Fetch services and pets from backend
        async function loadServices() {
            try {
                const response = await fetch('/Customer/Home/GetServices');
                const data = await response.json();
                
                if (data && data.dogServices) {
                    servicesByCategory['dog'] = data.dogServices.map(s => ({
                        id: s.serviceId,
                        name: s.name,
                        price: s.price ? `$${s.price}` : 'N/A',
                        duration: s.durationTime ? `${s.durationTime} min` : 'N/A'
                    }));
                }
                
                if (data && data.catServices) {
                    servicesByCategory['cat'] = data.catServices.map(s => ({
                        id: s.serviceId,
                        name: s.name,
                        price: s.price ? `$${s.price}` : 'N/A',
                        duration: s.durationTime ? `${s.durationTime} min` : 'N/A'
                    }));
                }
                
                // After services are loaded, initialize
                initializeForm();
            } catch (error) {
                console.error('Error loading services:', error);
                // Fallback to empty services
                initializeForm();
            }
        }

        function initializeForm() {
            // Initialize - set pet type from URL parameter
            if (initialPetType && (initialPetType === 'dog' || initialPetType === 'cat')) {
                elements.categorySelect.value = initialPetType === 'dog' ? 'Dog' : 'Cat';
                document.getElementById('categoryValue').value = initialPetType;
                elements.categorySelect.disabled = true; // Make it read-only
                renderPetCards();
                renderServiceDetails();
            } else {
                // Fallback: enable category selection if no petType parameter
                elements.categorySelect.disabled = false;
                renderPetCards();
            }

            populateTimeSlots();
            renderCalendar();
        }

        // Load services on page load
        loadServices();
    })();
</script>
