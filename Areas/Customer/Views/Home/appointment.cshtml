@{
    ViewData["Title"] = "Book an Appointment";
}

<link rel="stylesheet" href="~/Customer/css/appointment.css"/>

<!-- bradcam_area_start -->
<div class="bradcam_area breadcam_bg">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="bradcam_text text-center wow fadeInUp" data-wow-delay="0.2s">
                    <h3>Schedule Your Pet's Appointment</h3>
                </div>
            </div>
        </div>
    </div>
</div>

        <div class="appt-bg">
            <div class="appt-row">
                <!-- Calendar card -->
                <div class="card calendar-card" role="region" aria-label="appointments calendar">
                    <div class="cal-head">
                        <div class="cal-title" id="monthTitle">Month Year</div>
                        <div class="nav">
                            <button id="prevBtn" class="nav-btn" aria-label="Previous month">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                            <button id="nextBtn" class="nav-btn" aria-label="Next month">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="weekdays" aria-hidden="true">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>

                    <div class="days" id="daysGrid"></div>

                    <div class="calendar-footer">
                        <button type="button" id="todayBtn" class="today-btn">Today</button>
                    </div>

                    <div class="legend" aria-hidden="true">
                        <div class="legend-row">
                            <div class="legend-item"><span class="legend-color rateus"></span><span class="muted">Rate Us</span></div>
                            <div class="legend-item"><span class="legend-color visited"></span><span class="muted">Visited</span></div>
                            <div class="legend-item"><span class="legend-color confirmed"></span><span class="muted">Confirmed</span></div>
                        </div>
                        <div class="legend-row">
                            <div class="legend-item"><span class="legend-color noshow"></span><span class="muted">No Show</span></div>
                            <div class="legend-item"><span class="legend-color pending"></span><span class="muted">Pending</span></div>
                            <div class="legend-item"><span class="legend-color unavailable"></span><span class="muted">Unavailable</span></div>
                        </div>
                    </div>
                </div>

                <!-- Form card -->
                <div class="card form-card" id="formPanel" aria-live="polite">
                    <div id="formPlaceholder" class="muted">Select a date (today or a future date) to show the booking form.</div>

                    <form id="apptForm" style="display:none;" onsubmit="return false;" class="appt-form">
                        <fieldset>
                            <legend>Booking Details</legend>

                            <div class="form-group">
                                <label class="form-label">Selected Date</label>
                                <input id="selectedDateText" type="text" readonly class="form-control date-display" />
                            </div>

                            <div class="form-group">
                                <label for="categorySelect" class="form-label">Pet Category <span class="required">*</span></label>
                                <input id="categorySelect" type="text" readonly class="form-control" />
                                <!-- Hidden input to store the value -->
                                <input id="categoryValue" type="hidden" />
                            </div>

                            <div class="form-group pet-grid">
                                <label class="form-label">Choose Pet(s) <span class="required">*</span></label>
                                <div id="petCards" class="pet-cards" aria-live="polite"></div>
                                <div class="form-hint">Select one or more pets for the appointment</div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend>Service Details</legend>

                            <div class="form-group" id="serviceDetailsSection" style="display:none;">
                                <label class="form-label">Select Service <span class="required">*</span></label>
                                <div id="serviceDetailsList" class="service-details-list"></div>
                                <small class="form-hint">Select the service you want to book</small>
                            </div>

                            <div class="form-group">
                                <label for="timeSelect" class="form-label">Preferred Time <span class="required">*</span></label>
                                <select id="timeSelect" required class="form-control">
                                    <option value="" disabled selected>-- Select time --</option>
                                </select>
                                <small class="form-hint">Available 9:00 AM - 4:30 PM</small>
                            </div>

                            <div class="form-group">
                                <label for="groomerSelect" class="form-label">Preferred Groomer</label>
                                <select id="groomerSelect" class="form-control">
                                    <option value="">Any Available</option>
                                </select>
                                <small class="form-hint">Leave blank for automatic assignment</small>
                            </div>

                            <div class="form-group">
                                <label for="notes" class="form-label">Special Requests</label>
                                <textarea id="notes" placeholder="Allergies, behavior notes, special instructions..." class="form-control" rows="4"></textarea>
                                <small class="form-hint" id="charCount">0 / 500 characters</small>
                            </div>
                        </fieldset>

                        <div class="form-actions-main">
                            <button id="submitBtn" type="button" class="btn btn-primary btn-lg">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                Submit Appointment Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Success toast -->
        <div id="apptSuccessToast" class="appt-toast appt-toast--success" aria-live="polite" role="status" style="display:none;">
            <div class="toast-content">
                <div class="toast-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="toast-body">
                    <div class="toast-title">Appointment Request Submitted!</div>
                    <div class="toast-message">We'll confirm your booking shortly</div>
                </div>
                <button class="toast-close" id="apptSuccessClose" aria-label="Close notification">&times;</button>
            </div>
        </div>

        <!-- Error toast -->
        <div id="apptErrorToast" class="appt-toast appt-toast--error" aria-live="polite" role="alert" style="display:none;">
            <div class="toast-content">
                <div class="toast-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                </div>
                <div class="toast-body">
                    <div class="toast-title">Error</div>
                    <div class="toast-message" id="errorToastMsg">Please fill in all required fields</div>
                    <div id="loginPrompt" style="margin-top: 10px; display:none;">
                        <a href="/Auth/Login" class="btn btn-sm btn-primary" style="text-decoration: none; display: inline-block;">Go to Login</a>
                    </div>
                </div>
                <button class="toast-close" id="apptErrorClose" aria-label="Close notification">&times;</button>
            </div>
        </div>
</section>

<script>
    (function(){
        // Configuration
        const CONFIG = {
            PLACEHOLDER_IMG: '/mnt/data/dbc0ff5e-4bb2-4648-ab38-94af11a53bb9.png',
            TIME_START: 9,
            TIME_END: 16,
            TIME_INTERVAL: 30,
            TOAST_DURATION: 5000,
            MAX_NOTES_LENGTH: 500,
            CLOSED_DAYS: [1] // Monday
        };

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const initialPetType = urlParams.get('petType');
        const selectedServiceId = urlParams.get('serviceId');

        // Initial user pets - will be loaded from database
        let userPets = [];

        // Available services by category - will be populated from database
        const servicesByCategory = {
            'dog': [],
            'cat': []
        };

        // DOM Elements
        const elements = {
            daysGrid: document.getElementById('daysGrid'),
            monthTitle: document.getElementById('monthTitle'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            todayBtn: document.getElementById('todayBtn'),
            formPlaceholder: document.getElementById('formPlaceholder'),
            apptForm: document.getElementById('apptForm'),
            selectedDateText: document.getElementById('selectedDateText'),
            categorySelect: document.getElementById('categorySelect'),
            petCards: document.getElementById('petCards'),
            timeSelect: document.getElementById('timeSelect'),
            groomerSelect: document.getElementById('groomerSelect'),
            notes: document.getElementById('notes'),
            charCount: document.getElementById('charCount'),
            submitBtn: document.getElementById('submitBtn'),
            successToast: document.getElementById('apptSuccessToast'),
            errorToast: document.getElementById('apptErrorToast'),
            successClose: document.getElementById('apptSuccessClose'),
            errorClose: document.getElementById('apptErrorClose'),
            errorMsg: document.getElementById('errorToastMsg')
        };

        let calendarState = new Date();
        calendarState.setDate(1);

        // Utility Functions
        function pad(n) { return String(n).padStart(2, '0'); }
        function isAllowed(dateObj) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dateObj.getTime() >= today.getTime();
        }
        function isClosedDay(dateObj) {
            return CONFIG.CLOSED_DAYS.includes(dateObj.getDay());
        }

        function generateTimeSlots() {
            const slots = [];
            const start = CONFIG.TIME_START * 60;
            const end = CONFIG.TIME_END * 60 + CONFIG.TIME_INTERVAL;
            
            for (let t = start; t <= end; t += CONFIG.TIME_INTERVAL) {
                const hours = String(Math.floor(t / 60)).padStart(2, '0');
                const mins = String(t % 60).padStart(2, '0');
                slots.push(`${hours}:${mins}`);
            }
            return slots;
        }

        function populateTimeSlots() {
            elements.timeSelect.innerHTML = '<option value="" disabled selected>-- Select time --</option>';
            generateTimeSlots().forEach(slot => {
                const option = document.createElement('option');
                option.value = slot;
                option.textContent = slot;
                elements.timeSelect.appendChild(option);
            });
        }

        // Services Display - Shows services from database (Remove price, only show duration)
        function renderServiceDetails() {
            const category = elements.categorySelect.value;
            const serviceDetailsSection = document.getElementById('serviceDetailsSection');
            const serviceDetailsList = document.getElementById('serviceDetailsList');

            if (!serviceDetailsSection) {
                console.warn('Service details section not found in HTML');
                return;
            }

            if (!category) {
                serviceDetailsSection.style.display = 'none';
                return;
            }

            const services = servicesByCategory[category.toLowerCase()] || [];
            serviceDetailsList.innerHTML = '';

            if (services.length === 0) {
                serviceDetailsSection.style.display = 'none';
                return;
            }

            services.forEach(service => {
                const label = document.createElement('label');
                label.className = 'service-item';
                label.style.display = 'block';
                label.style.cursor = 'pointer';
                label.style.padding = '10px';
                label.style.border = '1px solid #ddd';
                label.style.borderRadius = '4px';
                label.style.marginBottom = '8px';

                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'service';
                input.value = service.id;
                input.className = 'service-radio';
                input.style.marginRight = '10px';
                input.style.cursor = 'pointer';
                
                if (selectedServiceId && service.id === selectedServiceId) {
                    input.checked = true;
                }

                const details = document.createElement('div');
                details.className = 'service-details';
                details.style.display = 'inline-block';

                const name = document.createElement('div');
                name.className = 'service-name';
                name.style.fontWeight = 'bold';
                name.textContent = service.name;

                const meta = document.createElement('div');
                meta.className = 'service-meta';
                meta.style.fontSize = '0.9em';
                meta.style.color = '#666';
                const duration = service.duration || 'N/A';
                meta.textContent = `${duration}`;

                details.appendChild(name);
                details.appendChild(meta);

                label.appendChild(input);
                label.appendChild(details);
                
                label.addEventListener('click', (e) => {
                    if (e.target !== input) {
                        input.checked = true;
                    }
                });

                serviceDetailsList.appendChild(label);
            });

            serviceDetailsSection.style.display = 'block';
        }

        // Character counter
        elements.notes.addEventListener('input', function() {
            const count = this.value.length;
            elements.charCount.textContent = `${count} / ${CONFIG.MAX_NOTES_LENGTH} characters`;
            if (count > CONFIG.MAX_NOTES_LENGTH) {
                this.value = this.value.substring(0, CONFIG.MAX_NOTES_LENGTH);
            }
        });

        // Calendar Rendering
        function renderCalendar() {
            elements.daysGrid.innerHTML = '';
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            elements.monthTitle.textContent = `${monthNames[calendarState.getMonth()]} ${calendarState.getFullYear()}`;

            const year = calendarState.getFullYear();
            const month = calendarState.getMonth();
            const firstDay = new Date(year, month, 1);
            const startDay = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevDays = new Date(year, month, 0).getDate();
            const statuses = getMonthStatuses(calendarState);

            for (let i = 0; i < 42; i++) {
                const cell = document.createElement('div');
                cell.className = 'day';
                
                let dayNum, cellDate, isOutside = false;
                const index = i - startDay + 1;

                if (index <= 0) {
                    dayNum = prevDays + index;
                    isOutside = true;
                    cellDate = new Date(year, month - 1, dayNum);
                } else if (index > daysInMonth) {
                    dayNum = index - daysInMonth;
                    isOutside = true;
                    cellDate = new Date(year, month + 1, dayNum);
                } else {
                    dayNum = index;
                    cellDate = new Date(year, month, dayNum);
                }

                if (isOutside) cell.classList.add('day--outside');

                const isClosed = isClosedDay(cellDate);
                if (isClosed) {
                    cell.classList.add('day--closed');
                    cell.setAttribute('aria-disabled', 'true');
                }

                const numSpan = document.createElement('span');
                numSpan.className = 'day-num';
                numSpan.textContent = dayNum;
                cell.appendChild(numSpan);

                const y = cellDate.getFullYear();
                const m = pad(cellDate.getMonth() + 1);
                const d = pad(cellDate.getDate());
                const key = `${y}-${m}-${d}`;
                const status = statuses[key];

                if (status) {
                    cell.classList.add(`day--${status}`);
                    const dot = document.createElement('span');
                    dot.className = 'day-dot';
                    dot.setAttribute('aria-hidden', 'true');
                    cell.appendChild(dot);
                }

                if (!isOutside && isAllowed(cellDate) && !isClosed) {
                    cell.classList.add('day--selectable');
                    cell.addEventListener('click', () => selectDate(cellDate));
                } else {
                    cell.classList.add('day--disabled');
                }

                elements.daysGrid.appendChild(cell);
            }
        }

        function getMonthStatuses(dateObj) {
            const y = dateObj.getFullYear();
            const m = pad(dateObj.getMonth() + 1);
            return {
                [`${y}-${m}-05`]: 'visited',
                [`${y}-${m}-12`]: 'pending',
                [`${y}-${m}-18`]: 'noshow',
                [`${y}-${m}-24`]: 'confirmed',
                [`${y}-${m}-02`]: 'rateus',
                [`${y}-${m}-27`]: 'unavailable'
            };
        }

        function selectDate(dateObj) {
            if (isClosedDay(dateObj)) {
                showErrorToast('Sorry, we are closed on Mondays. Please select another date.');
                return;
            }

            const previousSelected = elements.daysGrid.querySelector('.day--selected');
            if (previousSelected) previousSelected.classList.remove('day--selected');

            Array.from(elements.daysGrid.children).forEach(cell => {
                if (cell.textContent.trim() === String(dateObj.getDate())) {
                    cell.classList.add('day--selected');
                }
            });

            elements.selectedDateText.value = `${dateObj.getFullYear()}-${pad(dateObj.getMonth() + 1)}-${pad(dateObj.getDate())}`;
            populateTimeSlots();
            elements.apptForm.style.display = 'block';
            elements.formPlaceholder.style.display = 'none';
            elements.apptForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideForm() {
            elements.apptForm.style.display = 'none';
            elements.formPlaceholder.style.display = 'flex';
            const selected = elements.daysGrid.querySelector('.day--selected');
            if (selected) selected.classList.remove('day--selected');
        }

        // Pet Cards Rendering - Filter by selected service category
        function renderPetCards() {
            const category = elements.categorySelect.value.toLowerCase();
            elements.petCards.innerHTML = '';

            if (!category) {
                elements.petCards.innerHTML = '<div class="form-hint">Select a category to see pets</div>';
                return;
            }

            // Filter pets by the selected service category (dog/cat)
            const filteredPets = userPets.filter(p => p.category === category);
            
            if (filteredPets.length === 0) {
                elements.petCards.innerHTML = `<div class="form-hint">No ${category} pets available. Please add a ${category} to your profile first.</div>`;
                return;
            }

            filteredPets.forEach(pet => {
                const card = document.createElement('label');
                card.className = 'pet-card';
                card.setAttribute('data-id', pet.id);

                const img = document.createElement('img');
                img.src = pet.photo || CONFIG.PLACEHOLDER_IMG;
                img.alt = pet.name;
                img.className = 'pet-card-img';

                const info = document.createElement('div');
                info.className = 'pet-info';

                const name = document.createElement('div');
                name.className = 'pet-name';
                name.textContent = pet.name;

                const meta = document.createElement('div');
                meta.className = 'pet-meta';
                meta.textContent = pet.category === 'dog' ? 'Dog' : 'Cat';

                info.appendChild(name);
                info.appendChild(meta);

                const checkboxWrap = document.createElement('div');
                checkboxWrap.className = 'pet-checkbox-wrap';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = pet.id;
                checkbox.className = 'pet-checkbox';
                checkbox.setAttribute('aria-label', `Select ${pet.name}`);

                checkboxWrap.appendChild(checkbox);

                card.appendChild(img);
                card.appendChild(info);
                card.appendChild(checkboxWrap);

                card.addEventListener('click', (e) => {
                    if (e.target === checkbox) return;
                    checkbox.checked = !checkbox.checked;
                });

                elements.petCards.appendChild(card);
            });
        }

        function getSelectedPets() {
            const checkboxes = Array.from(elements.petCards.querySelectorAll('input[type="checkbox"]:checked'));
            return checkboxes
                .map(cb => userPets.find(p => p.id === cb.value))
                .filter(Boolean);
        }

        // Toast Helpers
        function showToast(element, duration = CONFIG.TOAST_DURATION) {
            element.style.display = 'flex';
            void element.offsetWidth;
            element.classList.add('show');
            clearTimeout(element._hideTimer);
            element._hideTimer = setTimeout(() => hideToast(element), duration);
        }

        function hideToast(element) {
            element.classList.remove('show');
            clearTimeout(element._removeTimer);
            element._removeTimer = setTimeout(() => {
                element.style.display = 'none';
            }, 350);
        }

        function showSuccessToast() {
            showToast(elements.successToast);
        }

        function showErrorToast(message, isLoginError = false) {
            elements.errorMsg.textContent = message;
            const loginPrompt = document.getElementById('loginPrompt');
            
            if (isLoginError) {
                loginPrompt.style.display = 'block';
                CONFIG.TOAST_DURATION = 6000;
            } else {
                loginPrompt.style.display = 'none';
                CONFIG.TOAST_DURATION = 3500;
            }
            
            showToast(elements.errorToast, isLoginError ? 6000 : 3500);
        }

        elements.successClose.addEventListener('click', () => hideToast(elements.successToast));
        elements.errorClose.addEventListener('click', () => hideToast(elements.errorToast));

        // Validation
        function validateForm() {
            if (!elements.selectedDateText.value) {
                showErrorToast('Please select a date');
                return false;
            }

            if (!elements.categorySelect.value) {
                showErrorToast('Please select a pet category');
                return false;
            }

            const selectedPets = getSelectedPets();
            if (selectedPets.length === 0) {
                showErrorToast('Please select at least one pet');
                return false;
            }

            if (!elements.timeSelect.value) {
                showErrorToast('Please select a time');
                return false;
            }

            const selectedService = document.querySelector('input[name="service"]:checked');
            if (!selectedService) {
                showErrorToast('Please select a service');
                return false;
            }

            return true;
        }

        // Event Listeners
        elements.prevBtn.addEventListener('click', () => {
            calendarState.setMonth(calendarState.getMonth() - 1);
            renderCalendar();
            hideForm();
        });

        elements.nextBtn.addEventListener('click', () => {
            calendarState.setMonth(calendarState.getMonth() + 1);
            renderCalendar();
            hideForm();
        });

        elements.todayBtn.addEventListener('click', () => {
            const today = new Date();
            if (isClosedDay(today)) {
                showErrorToast('Today is closed. Please select another date.');
                return;
            }
            calendarState = new Date();
            calendarState.setDate(1);
            renderCalendar();
            selectDate(today);
        });

        elements.categorySelect.addEventListener('change', () => {
            console.log('Category changed to:', elements.categorySelect.value);
            renderPetCards();  // Re-render pets with new category filter
            renderServiceDetails();  // Show services for this category
        });

        elements.submitBtn.addEventListener('click', async () => {
            if (!validateForm()) return;

            const selectedPets = getSelectedPets();
            const selectedService = document.querySelector('input[name="service"]:checked');
            
            const appointmentData = {
                date: elements.selectedDateText.value,
                time: elements.timeSelect.value,
                serviceId: selectedService.value,
                petIds: selectedPets.map(p => p.id),
                groomer: elements.groomerSelect.value || 'any',
                notes: elements.notes.value.trim()
            };

            try {
                elements.submitBtn.disabled = true;
                const originalText = elements.submitBtn.innerHTML;
                elements.submitBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Submitting...';

                const response = await fetch('/Customer/Home/SaveAppointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessToast();
                    
                    setTimeout(() => {
                        // ✅ REDIRECT TO HISTORY PAGE AFTER SUCCESSFUL BOOKING
                        window.location.href = '@Url.Action("History", "Home", new { area = "Customer" })';
                    }, 1500);
                } else {
                    showErrorToast(result.message || 'Failed to save appointment');
                    elements.submitBtn.disabled = false;
                    elements.submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorToast('An error occurred while saving the appointment');
                elements.submitBtn.disabled = false;
                elements.submitBtn.innerHTML = originalText;
            }
        });

        // Load available groomers
        async function loadGroomers() {
            try {
                const response = await fetch('/Customer/Home/GetAvailableGroomers');
                if (!response.ok) {
                    console.error('Failed to fetch groomers');
                    return;
                }

                const data = await response.json();
                if (data.success && data.groomers && data.groomers.length > 0) {
                    const groomerSelect = document.getElementById('groomerSelect');
                    
                    data.groomers.forEach(groomer => {
                        const option = document.createElement('option');
                        option.value = groomer.id;  // S001, S002, etc.
                        option.textContent = `${groomer.name} (${groomer.position || 'Groomer'})`;
                        groomerSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading groomers:', error);
            }
        }

        // Call this function when the page loads or when the form initializes
        // Add to your initialization code:
        loadGroomers();

        // ✅ LOAD SERVICES FROM BACKEND - FILTER BY SELECTED SERVICE IF PROVIDED
        async function loadServices() {
            try {
                console.log('Loading services...');
                const response = await fetch('/Customer/Home/GetServices');
                const data = await response.json();
                
                console.log('Services response:', data);
                
                if (data.success) {
                    if (data.dogServices) {
                        let dogServices = data.dogServices.map(s => ({
                            id: s.serviceId,
                            name: s.name,
                            duration: s.durationTime ? `${s.durationTime} min` : 'N/A'
                        }));
                        
                        // ✅ FILTER: If a specific service was selected from index, show only that service
                        if (selectedServiceId) {
                            dogServices = dogServices.filter(s => s.id === selectedServiceId);
                        }
                        
                        servicesByCategory['dog'] = dogServices;
                        console.log('Dog services loaded:', servicesByCategory['dog']);
                    }
                    
                    if (data.catServices) {
                        let catServices = data.catServices.map(s => ({
                            id: s.serviceId,
                            name: s.name,
                            duration: s.durationTime ? `${s.durationTime} min` : 'N/A'
                        }));
                        
                        // ✅ FILTER: If a specific service was selected from index, show only that service
                        if (selectedServiceId) {
                            catServices = catServices.filter(s => s.id === selectedServiceId);
                        }
                        
                        servicesByCategory['cat'] = catServices;
                        console.log('Cat services loaded:', servicesByCategory['cat']);
                    }
                }
                
                // Initialize form AFTER services are loaded
                initializeForm();
            } catch (error) {
                console.error('Error loading services:', error);
                initializeForm();
            }
        }

        // ✅ START: Load services on page load
        console.log('Appointment page loaded');
        console.log('URL params - petType:', initialPetType, 'serviceId:', selectedServiceId);
        loadServices();
        
        // ✅ UPDATED: Set category FIRST, then load pets
        function initializeForm() {
            // Set category FIRST, then load pets
            if (initialPetType && (initialPetType === 'dog' || initialPetType === 'cat')) {
                // Set the category value BEFORE loading pets
                const categoryValue = initialPetType === 'dog' ? 'Dog' : 'Cat';
                elements.categorySelect.value = categoryValue;
                document.getElementById('categoryValue').value = initialPetType;
                elements.categorySelect.disabled = true;
                
                console.log('Initial pet type set to:', categoryValue);
                
                // NOW load pets (they will be filtered by the category above)
                loadPetsFromDatabase();
                
                // Then render services
                renderServiceDetails();
            } else {
                elements.categorySelect.disabled = false;
                loadPetsFromDatabase();
            }

            populateTimeSlots();
            renderCalendar();
        }

        // ✅ UPDATED: Ensure pets are loaded AND rendered correctly
        function loadPetsFromDatabase() {
            console.log('Starting to load pets...');
            console.log('Current category:', elements.categorySelect.value);
            
            fetch('/Customer/Home/GetCustomerPets')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Pets data received:', data);
                    
                    if (data.success && data.pets && data.pets.length > 0) {
                        userPets = data.pets.map(p => ({
                            id: p.id,
                            name: p.name,
                            category: p.type.toLowerCase(),  // 'dog' or 'cat'
                            photo: p.photo
                        }));
                        
                        console.log('Pets loaded successfully:', userPets);
                        console.log('Current category filter:', elements.categorySelect.value.toLowerCase());
                        
                        // Filter and display pets
                        renderPetCards();
                    } else {
                        console.warn('No pets found for this user or response not successful');
                        userPets = [];
                        renderPetCards();
                    }
                })
                .catch(error => {
                    console.error('Error loading pets:', error);
                    userPets = [];
                    renderPetCards();
                });
        }
    })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
