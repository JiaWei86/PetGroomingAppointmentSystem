@{
    ViewData["Title"] = "History";
}

<link rel="stylesheet" href="~/Customer/css/history.css"/>

<section class="history-section">
    <div class="history-wrap">
        <!-- Header with improved layout -->
        <div class="history-header">
            <div class="header-content">
                <h1 class="header-title">📋 Appointment & Redeem History</h1>
                <p class="header-subtitle">Track your grooming appointments and loyalty rewards</p>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <span class="stat-icon">✓</span>
                    <div>
                        <div class="stat-value" id="totalAppointments">0</div>
                        <div class="stat-label">Total Appointments</div>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">🎁</span>
                    <div>
                        <div class="stat-value" id="totalRedeemed">0</div>
                        <div class="stat-label">Redeemed Items</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced tabs with icons -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="appointments">
                <span class="tab-icon">📅</span>
                <span>Appointment History</span>
                <span class="tab-badge" id="apptBadge">0</span>
            </button>
            <button class="tab-btn" data-tab="redeem">
                <span class="tab-icon">🎁</span>
                <span>Redeem History</span>
                <span class="tab-badge" id="redeemBadge">0</span>
            </button>
        </div>

        <div class="tab-panels">
            <!-- APPOINTMENT HISTORY -->
            <div id="appointments" class="tab-panel active">
                <!-- Enhanced controls -->
                <div class="controls-section">
                    <div class="controls">
                        <div class="left">
                            <div class="filter-group">
                                <label for="apptStatusFilter">
                                    <span class="filter-label">Filter by Status</span>
                                </label>
                                <select id="apptStatusFilter" class="select-filter">
                                    <option value="all">All statuses</option>
                                    <option value="confirmed">✓ Confirmed</option>
                                    <option value="visited">✓ Visited</option>
                                    <option value="pending">⏳ Pending</option>
                                    <option value="noshow">✗ No Show</option>
                                    <option value="cancelled">✗ Cancelled</option>
                                </select>
                            </div>
                        </div>

                        <div class="right">
                            <div class="search-group">
                                <input id="apptSearch" class="search-input" placeholder="🔍 Search appointments..." />
                                <button class="search-clear-btn" id="apptClearSearch" title="Clear search">✕</button>
                            </div>
                        </div>
                    </div>
                    <div class="filter-info" id="apptFilterInfo"></div>
                </div>

                <!-- Table section -->
                <div class="table-section">
                    <div class="table-wrap">
                        <table id="apptTable" class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Pet(s)</th>
                                    <th>Groomer</th>
                                    <th>Service</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody><!-- injected --></tbody>
                        </table>
                    </div>
                    <div id="apptEmptyState" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">📭</div>
                        <h3>No appointments found</h3>
                        <p>Try adjusting your filters or create a new appointment</p>
                    </div>
                </div>

                <!-- Enhanced pagination -->
                <div class="pager-section">
                    <div class="pager">
                        <button id="apptPrev" class="pager-btn pager-btn-prev">← Previous</button>
                        <div class="pager-info">
                            <span id="apptPageInfo">Page 1 of 1</span>
                            <span class="pager-results" id="apptResultsInfo"></span>
                        </div>
                        <button id="apptNext" class="pager-btn pager-btn-next">Next →</button>
                    </div>
                </div>
            </div>

            <!-- REDEEM HISTORY -->
            <div id="redeem" class="tab-panel">
                <!-- Enhanced controls -->
                <div class="controls-section">
                    <div class="controls">
                        <div class="left">
                            <div class="filter-group">
                                <label for="redeemStatusFilter">
                                    <span class="filter-label">Filter by Status</span>
                                </label>
                                <select id="redeemStatusFilter" class="select-filter">
                                    <option value="all">All statuses</option>
                                    <option value="used">✓ Used</option>
                                    <option value="available">◯ Available</option>
                                    <option value="expired">✗ Expired</option>
                                </select>
                            </div>
                        </div>

                        <div class="right">
                            <div class="search-group">
                                <input id="redeemSearch" class="search-input" placeholder="🔍 Search rewards..." />
                                <button class="search-clear-btn" id="redeemClearSearch" title="Clear search">✕</button>
                            </div>
                        </div>
                    </div>
                    <div class="filter-info" id="redeemFilterInfo"></div>
                </div>

                <!-- Table section -->
                <div class="table-section">
                    <div class="table-wrap">
                        <table id="redeemTable" class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Item</th>
                                    <th>Points</th>
                                    <th>Redeemed By</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody><!-- injected --></tbody>
                        </table>
                    </div>
                    <div id="redeemEmptyState" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">🎁</div>
                        <h3>No redeemed items found</h3>
                        <p>Earn points on your appointments to redeem rewards</p>
                    </div>
                </div>

                <!-- Enhanced pagination -->
                <div class="pager-section">
                    <div class="pager">
                        <button id="redeemPrev" class="pager-btn pager-btn-prev">← Previous</button>
                        <div class="pager-info">
                            <span id="redeemPageInfo">Page 1 of 1</span>
                            <span class="pager-results" id="redeemResultsInfo"></span>
                        </div>
                        <button id="redeemNext" class="pager-btn pager-btn-next">Next →</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal for details -->
<div id="detailModal" class="modal" style="display:none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <button class="modal-close">&times;</button>
        <div id="modalBody"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    LoadHistorySummary();
    LoadAppointmentHistory();
    LoadRedeemHistory();

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');
        });
    });

    // Modal close handlers
    const modal = document.getElementById('detailModal');
    const closeBtn = document.querySelector('.modal-close');
    const overlay = document.querySelector('.modal-overlay');
    
    if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');
    if (overlay) overlay.addEventListener('click', () => modal.style.display = 'none');
});

function LoadHistorySummary() {
    fetch('/Customer/Home/GetHistorySummary')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalAppointments').textContent = data.totalAppointments;
                document.getElementById('totalRedeemed').textContent = data.totalRedeemed;
                document.getElementById('apptBadge').textContent = data.totalAppointments;
                document.getElementById('redeemBadge').textContent = data.totalRedeemed;
            }
        })
        .catch(e => console.error('Error loading summary:', e));
}

function LoadAppointmentHistory() {
    fetch('/Customer/Home/GetAppointmentHistory')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                const tbody = document.querySelector('#apptTable tbody');
                tbody.innerHTML = data.data.map(a => `
                    <tr>
                        <td>${a.date}</td>
                        <td><span class="time-icon">🕐</span> ${a.time}</td>
                        <td>${a.petName || 'N/A'}</td>
                        <td>${a.groomerName}</td>
                        <td>${a.serviceName}</td>
                        <td class="text-center"><span class="status-badge status-${a.status.toLowerCase()}">${a.status}</span></td>
                        <td class="text-center"><button class="view-btn" onclick="ViewAppointment('${a.appointmentId}')">View</button></td>
                    </tr>
                `).join('');
                document.getElementById('apptEmptyState').style.display = 'none';
            } else {
                document.getElementById('apptEmptyState').style.display = 'block';
            }
        })
        .catch(e => console.error('Error loading appointments:', e));
}

function LoadRedeemHistory() {
    fetch('/Customer/Home/GetRedeemHistory')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                const tbody = document.querySelector('#redeemTable tbody');
                tbody.innerHTML = data.data.map(r => `
                    <tr>
                        <td>${r.date}</td>
                        <td><strong>${r.itemName}</strong></td>
                        <td><span class="points-badge">⭐ ${r.pointsUsed}</span></td>
                        <td>${r.redeemedBy}</td>
                        <td class="text-center"><span class="status-badge status-${r.status.toLowerCase()}">${r.status}</span></td>
                        <td class="text-center"><button class="view-btn" onclick="ViewRedeem('${r.crgId}')">View</button></td>
                    </tr>
                `).join('');
                document.getElementById('redeemEmptyState').style.display = 'none';
            } else {
                document.getElementById('redeemEmptyState').style.display = 'block';
            }
        })
        .catch(e => console.error('Error loading redeem history:', e));
}

function ViewAppointment(appointmentId) {
    fetch(`/Customer/Home/GetAppointmentDetails?appointmentId=${appointmentId}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const a = data.data;
                const modal = document.getElementById('detailModal');
                const modalBody = document.getElementById('modalBody');
                
                modalBody.innerHTML = `
                    <div class="modal-header">
                        <h2>Appointment Details</h2>
                    </div>
                    <div class="modal-details">
                        <div class="details-row">
                            <div class="detail-col">
                                <label>DATE</label>
                                <p>${a.date}</p>
                            </div>
                            <div class="detail-col">
                                <label>TIME</label>
                                <p>${a.time}</p>
                            </div>
                        </div>
                        <div class="details-row">
                            <div class="detail-col">
                                <label>PET(S)</label>
                                <p>${a.petNames || 'N/A'}</p>
                            </div>
                            <div class="detail-col">
                                <label>GROOMER</label>
                                <p>${a.groomerName}</p>
                            </div>
                        </div>
                        <div class="details-row">
                            <div class="detail-col">
                                <label>SERVICE</label>
                                <p>${a.serviceName}</p>
                            </div>
                            <div class="detail-col">
                                <label>AMOUNT</label>
                                <p>$${parseFloat(a.amount).toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="details-row">
                            <div class="detail-col">
                                <label>STATUS</label>
                                <p><span class="status-badge status-${a.status.toLowerCase()}">${a.status}</span></p>
                            </div>
                            <div class="detail-col">
                                <label>DURATION</label>
                                <p>${a.durationTime} mins</p>
                            </div>
                        </div>
                        ${a.notes ? `<div class="details-row">
                            <div class="detail-col full-width">
                                <label>NOTES</label>
                                <p>${a.notes}</p>
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="RescheduleAppointment('${a.appointmentId}')">
                            <span>📅</span> Reschedule
                        </button>
                        <div class="download-group">
                            <button class="btn btn-secondary" onclick="DownloadReceipt('${a.appointmentId}', 'txt')">
                                📄 TXT
                            </button>
                            <button class="btn btn-secondary" onclick="DownloadReceipt('${a.appointmentId}', 'pdf')">
                                📕 PDF
                            </button>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
            }
        })
        .catch(e => console.error('Error:', e));
}

function RescheduleAppointment(appointmentId) {
    fetch(`/Customer/Home/RescheduleAppointment`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ appointmentId: appointmentId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirectUrl;
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(e => console.error('Error:', e));
}

function DownloadReceipt(appointmentId, format) {
    const url = format === 'pdf' 
        ? `/Customer/Home/DownloadReceiptPdf?appointmentId=${appointmentId}`
        : `/Customer/Home/DownloadReceiptTxt?appointmentId=${appointmentId}`;
    
    const link = document.createElement('a');
    link.href = url;
    link.click();
}

function ViewRedeem(crgId) {
    // Implement redeem details view similar to ViewAppointment
    console.log('View redeem:', crgId);
}
</script>
