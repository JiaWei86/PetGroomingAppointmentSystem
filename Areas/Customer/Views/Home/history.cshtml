@{
    ViewData["Title"] = "History";
}

<link rel="stylesheet" href="~/Customer/css/history.css"/>

<section class="history-section">
    <div class="history-wrap">
        <!-- Header with improved layout -->
        <div class="history-header">
            <div class="header-content">
                <h1 class="header-title">📋 Appointment & Redeem History</h1>
                <p class="header-subtitle">Track your grooming appointments and loyalty rewards</p>
            </div>
            <div class="header-stats">
                <div class="stat-card">
                    <span class="stat-icon">✓</span>
                    <div>
                        <div class="stat-value" id="totalAppointments">0</div>
                        <div class="stat-label">Total Appointments</div>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">🎁</span>
                    <div>
                        <div class="stat-value" id="totalRedeemed">0</div>
                        <div class="stat-label">Redeemed Items</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced tabs with icons -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="appointments">
                <span class="tab-icon">📅</span>
                <span>Appointment History</span>
                <span class="tab-badge" id="apptBadge">0</span>
            </button>
            <button class="tab-btn" data-tab="redeem">
                <span class="tab-icon">🎁</span>
                <span>Redeem History</span>
                <span class="tab-badge" id="redeemBadge">0</span>
            </button>
        </div>

        <div class="tab-panels">
            <!-- APPOINTMENT HISTORY -->
            <div id="appointments" class="tab-panel active">
                <!-- Enhanced controls -->
                <div class="controls-section">
                    <div class="controls">
                        <div class="left">
                            <div class="filter-group">
                                <label for="apptStatusFilter">
                                    <span class="filter-label">Filter by Status</span>
                                </label>
                                <select id="apptStatusFilter" class="select-filter">
                                    <option value="all">All statuses</option>
                                    <option value="confirmed">✓ Confirmed</option>
                                    <option value="complete">✓ Complete</option>
                                    <option value="cancelled">✗ Cancelled</option>
                                </select>
                            </div>
                        </div>

                        <div class="right">
                            <div class="search-group">
                                <input id="apptSearch" class="search-input" placeholder="🔍 Search appointments..." />
                                <button class="search-clear-btn" id="apptClearSearch" title="Clear search">✕</button>
                            </div>
                        </div>
                    </div>
                    <div class="filter-info" id="apptFilterInfo"></div>
                </div>

                <!-- Table section -->
                <div class="table-section">
                    <div class="table-wrap">
                        <table id="apptTable" class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Pet(s)</th>
                                    <th>Groomer</th>
                                    <th>Service</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody><!-- injected --></tbody>
                        </table>
                    </div>
                    <div id="apptEmptyState" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">📭</div>
                        <h3>No appointments found</h3>
                        <p>Try adjusting your filters or create a new appointment</p>
                    </div>
                </div>

                <!-- Enhanced pagination -->
                <div class="pager-section">
                    <div class="pager">
                        <button id="apptPrev" class="pager-btn pager-btn-prev">← Previous</button>
                        <div class="pager-info">
                            <span id="apptPageInfo">Page 1 of 1</span>
                            <span class="pager-results" id="apptResultsInfo"></span>
                        </div>
                        <button id="apptNext" class="pager-btn pager-btn-next">Next →</button>
                    </div>
                </div>
            </div>

            <!-- REDEEM HISTORY -->
            <div id="redeem" class="tab-panel">
                <!-- Enhanced controls -->
                <div class="controls-section">
                    <div class="controls">
                        <div class="left">
                            <div class="filter-group">
                                <label for="redeemStatusFilter">
                                    <span class="filter-label">Filter by Status</span>
                                </label>
                                <select id="redeemStatusFilter" class="select-filter">
                                    <option value="all">All statuses</option>
                                    <option value="used">✓ Used</option>
                                </select>
                            </div>
                        </div>

                        <div class="right">
                            <div class="search-group">
                                <input id="redeemSearch" class="search-input" placeholder="🔍 Search rewards..." />
                                <button class="search-clear-btn" id="redeemClearSearch" title="Clear search">✕</button>
                            </div>
                        </div>
                    </div>
                    <div class="filter-info" id="redeemFilterInfo"></div>
                </div>

                <!-- Table section -->
                <div class="table-section">
                    <div class="table-wrap">
                        <table id="redeemTable" class="history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Item</th>
                                    <th>Points</th>
                                    <th>Redeemed By</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody><!-- injected --></tbody>
                        </table>
                    </div>
                    <div id="redeemEmptyState" class="empty-state" style="display:none;">
                        <div class="empty-state-icon">🎁</div>
                        <h3>No redeemed items found</h3>
                        <p>Earn points on your appointments to redeem rewards</p>
                    </div>
                </div>

                <!-- Enhanced pagination -->
                <div class="pager-section">
                    <div class="pager">
                        <button id="redeemPrev" class="pager-btn pager-btn-prev">← Previous</button>
                        <div class="pager-info">
                            <span id="redeemPageInfo">Page 1 of 1</span>
                            <span class="pager-results" id="redeemResultsInfo"></span>
                        </div>
                        <button id="redeemNext" class="pager-btn pager-btn-next">Next →</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal for details -->
<div id="detailModal" class="modal" style="display:none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <button class="modal-close">&times;</button>
        <div id="modalBody"></div>
    </div>
</div>

<!-- Modal for Reschedule -->
<div id="rescheduleModal" class="modal" style="display:none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <button class="modal-close" onclick="CloseRescheduleModal()">&times;</button>
        <div class="modal-header">
            <h2>📅 Reschedule Appointment</h2>
        </div>
        <form id="rescheduleForm">
            <div class="form-group">
                <label for="newDate">New Date</label>
                <input type="date" id="newDate" required style="padding:8px;border:1px solid #ddd;border-radius:4px;width:100%;"/>
            </div>
            <div class="form-group">
                <label for="newTime">New Time</label>
                <input type="time" id="newTime" required style="padding:8px;border:1px solid #ddd;border-radius:4px;width:100%;"/>
            </div>
            <div class="form-actions" style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                <button type="button" class="btn btn-secondary" onclick="CloseRescheduleModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="SubmitReschedule()">Reschedule</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for Confirmation -->
<div id="confirmModal" class="modal" style="display:none;">
    <div class="modal-overlay" onclick="CloseConfirmModal()"></div>
    <div class="modal-content confirm-modal">
        <div class="confirm-header">
            <div class="confirm-icon">⚠️</div>
            <h2 id="confirmTitle">Cancel Appointment?</h2>
        </div>
        
        <div class="confirm-body">
            <p id="confirmMessage">Are you sure you want to cancel this appointment? This action cannot be undone.</p>
        </div>
        
        <div class="confirm-footer">
            <button type="button" class="btn btn-outline" onclick="CloseConfirmModal()">
                <span class="btn-icon">✕</span>
                No, Keep It
            </button>
            <button type="button" class="btn btn-danger" id="confirmActionBtn" onclick="ConfirmCancelAppointment()">
                <span class="btn-icon">✓</span>
                Yes, Cancel It
            </button>
        </div>
    </div>
</div>

<style>
.action-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
}

.view-btn, .cancel-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    background: white;
}

.view-btn {
    color: #2196F3;
    border-color: #2196F3;
}

.view-btn:hover {
    background: #2196F3;
    color: white;
}

.cancel-btn {
    color: #f44336;
    border-color: #f44336;
}

.cancel-btn:hover:not(:disabled) {
    background: #f44336;
    color: white;
}

.cancel-btn:disabled {
    color: #ccc;
    border-color: #ccc;
    cursor: not-allowed;
}

.cancel-btn[title] {
    cursor: help;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #333;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #2196F3;
    color: white;
}

.btn-primary:hover {
    background: #1976D2;
}

.btn-secondary {
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
}

.btn-secondary:hover {
    background: #e0e0e0;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-danger:hover {
    background: #d32f2f;
}

.confirm-modal {
    max-width: 450px;
    width: 90%;
}

.confirm-actions {
    flex-direction: row;
    gap: 15px;
}

.confirm-actions .btn {
    flex: 1;
    padding: 12px 20px;
}
</style>

<script>
let currentRescheduleId = null;
let pendingCancelId = null;
let isModalOpen = false;

// ===== PAGINATION & DATA MANAGEMENT =====
const appointmentState = {
    allData: [],
    filteredData: [],
    currentPage: 1,
    pageSize: 5,
    searchTerm: '',
    statusFilter: 'all'
};

const redeemState = {
    allData: [],
    filteredData: [],
    currentPage: 1,
    pageSize: 5,
    searchTerm: '',
    statusFilter: 'all'
};

document.addEventListener('DOMContentLoaded', function() {
    LoadHistorySummary();
    LoadAppointmentHistory();
    LoadRedeemHistory();

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');
        });
    });

    // Appointment Search & Filter
    document.getElementById('apptSearch').addEventListener('input', (e) => {
        appointmentState.searchTerm = e.target.value.toLowerCase();
        appointmentState.currentPage = 1;
        FilterAndDisplayAppointments();
    });

    document.getElementById('apptStatusFilter').addEventListener('change', (e) => {
        appointmentState.statusFilter = e.target.value;
        appointmentState.currentPage = 1;
        FilterAndDisplayAppointments();
    });

    document.getElementById('apptClearSearch').addEventListener('click', () => {
        document.getElementById('apptSearch').value = '';
        appointmentState.searchTerm = '';
        appointmentState.currentPage = 1;
        FilterAndDisplayAppointments();
    });

    // Appointment Pagination
    document.getElementById('apptPrev').addEventListener('click', () => {
        if (appointmentState.currentPage > 1) {
            appointmentState.currentPage--;
            DisplayAppointmentPage();
        }
    });

    document.getElementById('apptNext').addEventListener('click', () => {
        const totalPages = Math.ceil(appointmentState.filteredData.length / appointmentState.pageSize);
        if (appointmentState.currentPage < totalPages) {
            appointmentState.currentPage++;
            DisplayAppointmentPage();
        }
    });

    // Redeem Search & Filter
    document.getElementById('redeemSearch').addEventListener('input', (e) => {
        redeemState.searchTerm = e.target.value.toLowerCase();
        redeemState.currentPage = 1;
        FilterAndDisplayRedeem();
    });

    document.getElementById('redeemStatusFilter').addEventListener('change', (e) => {
        redeemState.statusFilter = e.target.value;
        redeemState.currentPage = 1;
        FilterAndDisplayRedeem();
    });

    document.getElementById('redeemClearSearch').addEventListener('click', () => {
        document.getElementById('redeemSearch').value = '';
        redeemState.searchTerm = '';
        redeemState.currentPage = 1;
        FilterAndDisplayRedeem();
    });

    // Redeem Pagination
    document.getElementById('redeemPrev').addEventListener('click', () => {
        if (redeemState.currentPage > 1) {
            redeemState.currentPage--;
            DisplayRedeemPage();
        }
    });

    document.getElementById('redeemNext').addEventListener('click', () => {
        const totalPages = Math.ceil(redeemState.filteredData.length / redeemState.pageSize);
        if (redeemState.currentPage < totalPages) {
            redeemState.currentPage++;
            DisplayRedeemPage();
        }
    });

    // Modal close handlers
    const modal = document.getElementById('detailModal');
    const closeBtn = document.querySelector('.modal-close');
    const overlay = document.querySelector('.modal-overlay');
    
    if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');
    if (overlay) overlay.addEventListener('click', () => modal.style.display = 'none');

    // Reschedule modal handlers
    const rescheduleModal = document.getElementById('rescheduleModal');
    const rescheduleOverlay = rescheduleModal.querySelector('.modal-overlay');
    if (rescheduleOverlay) rescheduleOverlay.addEventListener('click', CloseRescheduleModal);

    // Confirmation modal handlers
    const confirmModal = document.getElementById('confirmModal');
    if (confirmModal) {
        const confirmOverlay = confirmModal.querySelector('.modal-overlay');
        if (confirmOverlay) {
            confirmOverlay.addEventListener('click', CloseConfirmModal);
        }
    }
});

function LoadHistorySummary() {
    fetch('/Customer/Home/GetHistorySummary')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalAppointments').textContent = data.totalAppointments;
                document.getElementById('totalRedeemed').textContent = data.totalRedeemed;
                document.getElementById('apptBadge').textContent = data.totalAppointments;
                document.getElementById('redeemBadge').textContent = data.totalRedeemed;
            }
        })
        .catch(e => console.error('Error loading summary:', e));
}

function LoadAppointmentHistory() {
    fetch('/Customer/Home/GetAppointmentHistory')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                appointmentState.allData = data.data;
                appointmentState.currentPage = 1;
                FilterAndDisplayAppointments();
            } else {
                appointmentState.allData = [];
                document.getElementById('apptEmptyState').style.display = 'block';
                document.querySelector('#apptTable tbody').innerHTML = '';
            }
        })
        .catch(e => console.error('Error loading appointments:', e));
}

function LoadRedeemHistory() {
    fetch('/Customer/Home/GetRedeemHistory')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data.length > 0) {
                redeemState.allData = data.data;
                redeemState.currentPage = 1;
                FilterAndDisplayRedeem();
            } else {
                redeemState.allData = [];
                document.getElementById('redeemEmptyState').style.display = 'block';
                document.querySelector('#redeemTable tbody').innerHTML = '';
            }
        })
        .catch(e => console.error('Error loading redeem history:', e));
}

// ===== APPOINTMENT FILTERING & DISPLAY =====
function FilterAndDisplayAppointments() {
    appointmentState.filteredData = appointmentState.allData.filter(a => {
        const matchesSearch = 
            a.petName.toLowerCase().includes(appointmentState.searchTerm) ||
            a.groomerName.toLowerCase().includes(appointmentState.searchTerm) ||
            a.serviceName.toLowerCase().includes(appointmentState.searchTerm) ||
            a.date.toLowerCase().includes(appointmentState.searchTerm);
        
        const matchesStatus = appointmentState.statusFilter === 'all' || 
            a.status.toLowerCase() === appointmentState.statusFilter;
        
        return matchesSearch && matchesStatus;
    });

    UpdateAppointmentFilterInfo();
    DisplayAppointmentPage();
}

function UpdateAppointmentFilterInfo() {
    const info = document.getElementById('apptFilterInfo');
    const activeFilters = [];
    
    if (appointmentState.searchTerm) {
        activeFilters.push(`Search: "${appointmentState.searchTerm}"`);
    }
    if (appointmentState.statusFilter !== 'all') {
        activeFilters.push(`Status: ${appointmentState.statusFilter}`);
    }
    
    if (activeFilters.length > 0) {
        info.innerHTML = `<span>Active filters: ${activeFilters.join(' • ')}</span>`;
        info.style.display = 'block';
    } else {
        info.style.display = 'none';
    }
}

function DisplayAppointmentPage() {
    const start = (appointmentState.currentPage - 1) * appointmentState.pageSize;
    const end = start + appointmentState.pageSize;
    const pageData = appointmentState.filteredData.slice(start, end);
    
    const tbody = document.querySelector('#apptTable tbody');
    
    if (pageData.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('apptEmptyState').style.display = 'block';
        document.getElementById('apptPageInfo').textContent = 'Page 1 of 1';
        document.getElementById('apptResultsInfo').textContent = '';
        return;
    }
    
    document.getElementById('apptEmptyState').style.display = 'none';
    
    tbody.innerHTML = pageData.map(a => {
        // Check if appointment can be cancelled (more than 24 hours away and confirmed status)
        const appointmentDate = new Date(a.date + ' ' + a.time);
        const now = new Date();
        const hoursUntilAppointment = (appointmentDate - now) / (1000 * 60 * 60);
        const canCancel = a.status.toLowerCase() === 'confirmed' && hoursUntilAppointment >= 24;
        const cancelTooltip = hoursUntilAppointment < 24 ? 'Cannot cancel within 24 hours' : 'Cancel this appointment';
        
        return `
            <tr>
                <td>${a.date}</td>
                <td><span class="time-icon">🕐</span> ${a.time}</td>
                <td>${a.petName || 'N/A'}</td>
                <td>${a.groomerName}</td>
                <td>${a.serviceName}</td>
                <td class="text-center"><span class="status-badge status-${a.status.toLowerCase()}">${a.status}</span></td>
                <td class="text-center">
                    <div class="action-buttons">
                        <button class="view-btn" onclick="ViewAppointment('${a.appointmentId}')">View</button>
                        <button class="cancel-btn" onclick="QuickCancelAppointment('${a.appointmentId}')" 
                                ${!canCancel ? 'disabled' : ''} title="${cancelTooltip}">Cancel</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    const totalPages = Math.ceil(appointmentState.filteredData.length / appointmentState.pageSize);
    document.getElementById('apptPageInfo').textContent = `Page ${appointmentState.currentPage} of ${totalPages}`;
    document.getElementById('apptResultsInfo').textContent = `Showing ${start + 1}-${Math.min(end, appointmentState.filteredData.length)} of ${appointmentState.filteredData.length}`;
    
    // Update pagination buttons
    document.getElementById('apptPrev').disabled = appointmentState.currentPage === 1;
    document.getElementById('apptNext').disabled = appointmentState.currentPage === totalPages;
}

// ===== REDEEM FILTERING & DISPLAY =====
function FilterAndDisplayRedeem() {
    redeemState.filteredData = redeemState.allData.filter(r => {
        const matchesSearch = 
            r.itemName.toLowerCase().includes(redeemState.searchTerm) ||
            r.redeemedBy.toLowerCase().includes(redeemState.searchTerm);
        
        const matchesStatus = redeemState.statusFilter === 'all' || 
            r.status.toLowerCase() === redeemState.statusFilter;
        
        return matchesSearch && matchesStatus;
    });

    UpdateRedeemFilterInfo();
    DisplayRedeemPage();
}

function UpdateRedeemFilterInfo() {
    const info = document.getElementById('redeemFilterInfo');
    const activeFilters = [];
    
    if (redeemState.searchTerm) {
        activeFilters.push(`Search: "${redeemState.searchTerm}"`);
    }
    if (redeemState.statusFilter !== 'all') {
        activeFilters.push(`Status: ${redeemState.statusFilter}`);
    }
    
    if (activeFilters.length > 0) {
        info.innerHTML = `<span>Active filters: ${activeFilters.join(' • ')}</span>`;
        info.style.display = 'block';
    } else {
        info.style.display = 'none';
    }
}

function DisplayRedeemPage() {
    const start = (redeemState.currentPage - 1) * redeemState.pageSize;
    const end = start + redeemState.pageSize;
    const pageData = redeemState.filteredData.slice(start, end);
    
    const tbody = document.querySelector('#redeemTable tbody');
    
    if (pageData.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('redeemEmptyState').style.display = 'block';
        document.getElementById('redeemPageInfo').textContent = 'Page 1 of 1';
        document.getElementById('redeemResultsInfo').textContent = '';
        return;
    }
    
    document.getElementById('redeemEmptyState').style.display = 'none';
    
    tbody.innerHTML = pageData.map(r => `
        <tr>
            <td>${r.date}</td>
            <td><strong>${r.itemName}</strong></td>
            <td><span class="points-badge">⭐ ${r.pointsUsed}</span></td>
            <td>${r.redeemedBy}</td>
            <td class="text-center"><span class="status-badge status-${r.status.toLowerCase()}">${r.status}</span></td>
            <td class="text-center"><button class="view-btn" onclick="ViewRedeem('${r.crgId}')">View</button></td>
        </tr>
    `).join('');
    
    const totalPages = Math.ceil(redeemState.filteredData.length / redeemState.pageSize);
    document.getElementById('redeemPageInfo').textContent = `Page ${redeemState.currentPage} of ${totalPages}`;
    document.getElementById('redeemResultsInfo').textContent = `Showing ${start + 1}-${Math.min(end, redeemState.filteredData.length)} of ${redeemState.filteredData.length}`;
    
    // Update pagination buttons
    document.getElementById('redeemPrev').disabled = redeemState.currentPage === 1;
    document.getElementById('redeemNext').disabled = redeemState.currentPage === totalPages;
}

// ===== VIEW & ACTION FUNCTIONS =====
function ViewAppointment(appointmentId) {
    fetch(`/Customer/Home/GetAppointmentDetails?appointmentId=${appointmentId}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const a = data.data;
                const modal = document.getElementById('detailModal');
                const modalBody = document.getElementById('modalBody');
                
                // Determine available actions based on status
                let actionButtons = '';
                if (a.status.toLowerCase() === 'confirmed') {
                    actionButtons = `
                        <button class="btn btn-primary" onclick="OpenRescheduleModal('${a.appointmentId}')">
                            <span>📅</span> Reschedule
                        </button>
                        <button class="btn btn-danger" onclick="CancelAppointment('${a.appointmentId}')">
                            <span>✕</span> Cancel
                        </button>
                    `;
                }
                
                modalBody.innerHTML = `
                    <div class="modal-header">
                        <h2>Appointment Details</h2>
                    </div>
                    <div class="modal-details">
                        <div class="details-row">
                            <div class="detail-col">
                                <label>DATE</label>
                                <p>${a.date}</p>
                            </div>
                            <div class="detail-col">
                                <label>TIME</label>
                                <p>${a.time}</p>
                            </div>
                        </div>
                        <div class="details-row">
                            <div class="detail-col">
                                <label>PET(S)</label>
                                <p>${a.petNames || 'N/A'}</p>
                            </div>
                            <div class="detail-col">
                                <label>GROOMER</label>
                                <p>${a.groomerName}</p>
                            </div>
                        </div>
                        <div class="details-row">
                            <div class="detail-col">
                                <label>SERVICE</label>
                                <p>${a.serviceName}</p>
                            </div>
                            <div class="detail-col">
                                <label>DURATION</label>
                                <p>${a.durationTime} mins</p>
                            </div>
                        </div>
                        <div class="details-row">
                            <div class="detail-col">
                                <label>STATUS</label>
                                <p><span class="status-badge status-${a.status.toLowerCase()}">${a.status}</span></p>
                            </div>
                        </div>
                        ${a.notes ? `<div class="details-row">
                            <div class="detail-col full-width">
                                <label>NOTES</label>
                                <p>${a.notes}</p>
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="modal-actions">
                        ${actionButtons}
                        <div class="download-group">
                            <button class="btn btn-secondary" onclick="DownloadReceipt('${a.appointmentId}', 'txt')">
                                📄 TXT
                            </button>
                            <button class="btn btn-secondary" onclick="DownloadReceipt('${a.appointmentId}', 'pdf')">
                                📕 PDF
                            </button>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
            }
        })
        .catch(e => console.error('Error:', e));
}

// Quick Cancel from Table
function QuickCancelAppointment(appointmentId) {
    pendingCancelId = appointmentId;
    ShowConfirmModal(
        '❌ Cancel Appointment?',
        'Are you sure you want to cancel this appointment? This action cannot be undone.',
        'Yes, Cancel It',
        ConfirmCancelAppointment
    );
}

// Cancel from Modal
function CancelAppointment(appointmentId) {
    pendingCancelId = appointmentId;
    isModalOpen = true;
    DisableViewButtons();
    ShowConfirmModal(
        '❌ Cancel Appointment?',
        'Are you sure you want to cancel this appointment? This action cannot be undone.',
        'Yes, Cancel It',
        ConfirmCancelAppointment
    );
}

// Show Confirmation Modal
function ShowConfirmModal(title, message, confirmBtnText, callback) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    const confirmBtn = document.getElementById('confirmActionBtn');
    confirmBtn.textContent = confirmBtnText;
    document.getElementById('confirmModal').style.display = 'flex';
}

// Close Confirmation Modal
function CloseConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingCancelId = null;
    isModalOpen = false;
    EnableViewButtons();
}

// ✅ Disable View Buttons
function DisableViewButtons() {
    const viewBtns = document.querySelectorAll('.view-btn');
    viewBtns.forEach(btn => {
        btn.disabled = true;
        btn.title = 'Please close the cancel confirmation first';
    });
}

// ✅ Enable View Buttons
function EnableViewButtons() {
    const viewBtns = document.querySelectorAll('.view-btn');
    viewBtns.forEach(btn => {
        btn.disabled = false;
        btn.title = '';
    });
}

// Confirm Cancel Action
function ConfirmCancelAppointment() {
    if (!pendingCancelId) return;

    fetch('/Customer/Home/CancelAppointment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ appointmentId: pendingCancelId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showSuccessToast(data.message);
            CloseConfirmModal();
            setTimeout(() => {
                // Close detail modal if open
                const detailModal = document.getElementById('detailModal');
                if (detailModal && detailModal.style.display !== 'none') {
                    detailModal.style.display = 'none';
                }
                LoadAppointmentHistory();
            }, 1500);
        } else {
            showErrorToast(data.message);
        }
    })
    .catch(e => {
        console.error('Error:', e);
        showErrorToast('Failed to cancel appointment');
    });
}

// Reschedule Modal Functions
function OpenRescheduleModal(appointmentId) {
    currentRescheduleId = appointmentId;
    document.getElementById('newDate').value = '';
    document.getElementById('newTime').value = '';
    document.getElementById('rescheduleModal').style.display = 'flex';
}

function CloseRescheduleModal() {
    document.getElementById('rescheduleModal').style.display = 'none';
    currentRescheduleId = null;
}

function SubmitReschedule() {
    const newDate = document.getElementById('newDate').value;
    const newTime = document.getElementById('newTime').value;

    if (!newDate || !newTime) {
        showErrorToast('Please fill in both date and time');
        return;
    }

    fetch('/Customer/Home/RescheduleAppointment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            appointmentId: currentRescheduleId,
            request: { newDate: newDate, newTime: newTime }
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showSuccessToast(data.message);
            CloseRescheduleModal();
            setTimeout(() => {
                document.getElementById('detailModal').style.display = 'none';
                LoadAppointmentHistory();
            }, 1500);
        } else {
            showErrorToast(data.message);
        }
    })
    .catch(e => {
        console.error('Error:', e);
        showErrorToast('Failed to reschedule appointment');
    });
}

function ViewRedeem(crgId) {
    const redeem = redeemState.allData.find(r => r.crgId === crgId);
    if (!redeem) return;

    const modal = document.getElementById('detailModal');
    const modalBody = document.getElementById('modalBody');
    
    modalBody.innerHTML = `
        <div class="modal-header">
            <h2>Redeem Details</h2>
        </div>
        <div class="modal-details">
            <div class="details-row">
                <div class="detail-col">
                    <label>DATE</label>
                    <p>${redeem.date}</p>
                </div>
                <div class="detail-col">
                    <label>ITEM</label>
                    <p>${redeem.itemName}</p>
                </div>
            </div>
            <div class="details-row">
                <div class="detail-col">
                    <label>POINTS USED</label>
                    <p>⭐ ${redeem.pointsUsed}</p>
                </div>
                <div class="detail-col">
                    <label>QUANTITY</label>
                    <p>${redeem.quantity}</p>
                </div>
            </div>
            <div class="details-row">
                <div class="detail-col">
                    <label>REDEEMED BY</label>
                    <p>${redeem.redeemedBy}</p>
                </div>
                <div class="detail-col">
                    <label>STATUS</label>
                    <p><span class="status-badge status-${redeem.status.toLowerCase()}">${redeem.status}</span></p>
                </div>
            </div>
        </div>
    `;
    
    modal.style.display = 'flex';
}

function DownloadReceipt(appointmentId, format) {
    const url = format === 'pdf' 
        ? `/Customer/Home/DownloadReceiptPdf?appointmentId=${appointmentId}`
        : `/Customer/Home/DownloadReceiptTxt?appointmentId=${appointmentId}`;
    
    const link = document.createElement('a');
    link.href = url;
    link.click();
}

// Helper toast functions - 改进版本（在中间偏上显示）
function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-success';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 25%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        padding: 20px 40px;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        font-weight: 600;
        font-size: 15px;
        letter-spacing: 0.3px;
        text-align: center;
        min-width: 300px;
        animation: toastSlideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'toastSlideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showErrorToast(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-danger';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 25%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        padding: 20px 40px;
        background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        font-weight: 600;
        font-size: 15px;
        letter-spacing: 0.3px;
        text-align: center;
        min-width: 300px;
        animation: toastSlideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'toastSlideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
