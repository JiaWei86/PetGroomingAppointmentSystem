@{
    ViewData["Title"] = "My Profile";
    var customer = ViewBag.Customer as PetGroomingAppointmentSystem.Models.Customer;
    var pets = ViewBag.Pets as List<PetGroomingAppointmentSystem.Models.Pet> ?? new List<PetGroomingAppointmentSystem.Models.Pet>();
    
    // Parse multiple photos from comma-separated string
    var photoList = new List<string>();
    if (!string.IsNullOrEmpty(customer?.Photo))
    {
        photoList = customer.Photo.Split(',', StringSplitOptions.RemoveEmptyEntries).ToList();
    }
    if (!photoList.Any())
    {
        photoList.Add("/Customer/img/default-avatar.png");
    }
    var hasMultiplePhotos = photoList.Count > 1 || (photoList.Count == 1 && photoList[0] != "/Customer/img/default-avatar.png");
    
    // Status control variables
    var customerStatus = customer?.Status?.ToLower() ?? "active";
    var isBlocked = customerStatus == "blocked";
    var isInactive = customerStatus == "inactive";
    var isActive = customerStatus == "active" || string.IsNullOrEmpty(customer?.Status);
}

<!-- Link to external CSS -->
<link rel="stylesheet" href="~/Customer/css/multi-avatar.css" />
<link rel="stylesheet" href="~/Customer/css/status-control.css" />

@* ========== BLOCKED ACCOUNT OVERLAY ========== *@
@if (isBlocked)
{
    <div class="blocked-overlay" id="blockedOverlay">
        <div class="blocked-notice">
            <div class="blocked-notice-icon">
                <i class="fa fa-ban"></i>
            </div>
            <h3>Account Blocked</h3>
            <p>
                Your account has been blocked by the administrator. 
                You can view your profile information, but all account operations have been disabled.
            </p>
            <div class="blocked-notice-contact">
                <p>
                    If you believe this is a mistake, please contact our support team at
                    <a href="mailto:support@petgrooming.com">support@petgrooming.com</a> or call 
                    <a href="tel:+601145892563">+6011 4589 2563</a>
                </p>
            </div>
            <a href="/Customer/Auth/Logout" class="btn-logout">
                <i class="fa fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>
}

@* Add a hidden form to generate the Anti-Forgery Token for AJAX requests *@
<form id="antiForgeryForm" style="display:none;">
    @Html.AntiForgeryToken()
</form>


<div class="bradcam_area breadcam_bg">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="bradcam_text text-center wow fadeInUp" data-wow-delay="0.2s">
                    <h3>Profile</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="profile-page-wrapper @(isBlocked ? "profile-blocked" : "")">
    <div class="container py-4">
        
        @* ========== INACTIVE STATUS WARNING BANNER ========== *@
        @if (isInactive)
        {
            <div class="inactive-warning-banner">
                <i class="fa fa-exclamation-triangle"></i>
                <div class="warning-content">
                    <h5>Account Inactive</h5>
                    <p>Your account is currently inactive. Some features like redeeming gifts are restricted. Please contact support if you need assistance.</p>
                </div>
            </div>
        }
        
        <div class="row">
            <!-- Left column: profile card -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm profile-card-main">
                    <div class="card-body text-center">

                        <!-- Animated Avatar -->
                        <div class="animated-avatar-container" id="animatedAvatarContainer">
                            @for (int i = 0; i < photoList.Count; i++)
                            {
                                <img src="@photoList[i]" 
                                     alt="avatar @(i + 1)"
                                     class="avatar-photo @(i == 0 ? "active" : "")"
                                     data-index="@i" />
                            }
                            @if (photoList.Count > 1)
                            {
                                <span class="photo-count-badge">@photoList.Count photos</span>
                            }
                        </div>
                        
                        <!-- Photo Indicators -->
                        @if (photoList.Count > 1)
                        {
                            <div class="avatar-indicators" id="avatarIndicators">
                                @for (int i = 0; i < photoList.Count; i++)
                                {
                                    <button type="button" 
                                            class="avatar-indicator @(i == 0 ? "active" : "")" 
                                            data-index="@i"
                                            onclick="goToPhoto(@i)"></button>
                                }
                            </div>
                        }

                        <h4 class="card-title mb-0 mt-3" id="profileName">@customer?.Name</h4>
                        <div class="text-muted mb-2" id="profilePhone">@customer?.Phone</div>
                        <p class="small text-muted" id="profileEmail">@customer?.Email</p>

                        <div class="d-grid gap-2">
                            @if (!isBlocked)
                            {
                                <button type="button" class="btn btn-orange-primary" onclick="openEditModal()">
                                    <i class="fa fa-edit"></i> Edit Profile
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-blocked" disabled title="Account blocked">
                                    <i class="fa fa-lock"></i> Edit Profile
                                </button>
                            }
                            <a href="/Customer/Home/History" class="btn btn-orange-outline">
                                <i class="fa fa-history"></i> View History
                            </a>
                        </div>
                    </div>

                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>Member since:</strong>
                            <span class="float-right">@customer?.RegisteredDate?.ToString("MMM yyyy")</span>
                        </li>
                        <li class="list-group-item">
                            <strong>Status:</strong>
                            <span class="float-right">
                                @{
                                    var statusClass = customerStatus switch
                                    {
                                        "blocked" => "status-badge-blocked",
                                        "inactive" => "status-badge-inactive",
                                        _ => "status-badge-active"
                                    };
                                    var statusText = customerStatus switch
                                    {
                                        "blocked" => "BLOCKED",
                                        "inactive" => "INACTIVE",
                                        _ => "ACTIVE"
                                    };
                                }
                                <span class="status-badge @statusClass">@statusText</span>
                                @if (isInactive)
                                {
                                    <span class="status-info-tooltip">
                                        <i class="fa fa-info-circle"></i>
                                        <span class="tooltip-text">Gift redemption is restricted</span>
                                    </span>
                                }
                                @if (isBlocked)
                                {
                                    <span class="status-info-tooltip">
                                        <i class="fa fa-info-circle"></i>
                                        <span class="tooltip-text">Account operations disabled</span>
                                    </span>
                                }
                            </span>
                        </li>
                        <li class="list-group-item">
                            <strong>Loyalty Points:</strong>
                            <span class="float-right text-warning font-weight-bold">@customer?.LoyaltyPoint</span>
                        </li>
                    </ul>
                </div>

                <!-- Quick Actions -->
                <div class="card mt-3 quick-actions-card">
                    <div class="card-body">
                        <h6 class="card-title">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            @if (!isBlocked)
                            {
                                <button onclick="openAddPetModal()" class="btn btn-orange-primary btn-sm">
                                    <i class="fa fa-plus"></i> Add Pet
                                </button>
                                <a href="/Customer/Home/Appointment" class="btn btn-orange-outline btn-sm">
                                    <i class="fa fa-calendar"></i> Book Service
                                </a>
                            }
                            else
                            {
                                <button class="btn btn-blocked btn-sm" disabled>
                                    <i class="fa fa-lock"></i> Add Pet
                                </button>
                                <button class="btn btn-blocked btn-sm" disabled>
                                    <i class="fa fa-lock"></i> Book Service
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right column: tabs -->
            <div class="col-lg-8">
                <div class="card profile-card-main">
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-tabs-orange" id="profileTab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#pets">Pets (@pets.Count)</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#loyalty">Loyalty & Rewards</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#tips">Pet Care Tips</a>
                            </li>
                        </ul>

                        <div class="tab-content pt-3">
                            <!-- Pets Tab -->
                            <div class="tab-pane fade show active" id="pets">
                                <div class="row gy-3">
                                    @if (pets.Any())
                                    {
                                        @foreach (var pet in pets)
                                        {
                                            <div class="col-md-6">
                                                <div class="card h-100 pet-card">
                                                    <div class="row no-gutters align-items-center">
                                                        <div class="col-4 text-center p-3">
                                                            <img src="@(string.IsNullOrEmpty(pet.Photo) ? "/Customer/img/default-pet.png" : pet.Photo)" 
                                                                 alt="@pet.Name" class="rounded-circle" 
                                                                 style="width:72px;height:72px;object-fit:cover;border:2px solid #ff9500;" />
                                                        </div>
                                                        <div class="col-8">
                                                            <div class="card-body py-2">
                                                                <h6 class="card-title mb-1">@pet.Name</h6>
                                                                <p class="small text-muted mb-1">@pet.Type - @pet.Breed</p>
                                                                <p class="small text-muted mb-1">Age: @pet.Age years</p>
                                                                @if (!isBlocked)
                                                                {
                                                                    <div class="d-flex gap-2">
                                                                        <button class="btn btn-sm btn-orange-outline" onclick="openEditPetModal('@pet.PetId')">Edit</button>
                                                                        <button class="btn btn-sm btn-danger" onclick="deletePet('@pet.PetId', '@pet.Name')">Delete</button>
                                                                    </div>
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="col-12 text-center text-muted">
                                            <p>No pets yet. Add your first pet!</p>
                                        </div>
                                    }
                                </div>
                                @if (!isBlocked)
                                {
                                    <div class="mt-3 text-center">
                                        <button onclick="openAddPetModal()" class="btn btn-sm btn-orange-primary">
                                            <i class="fa fa-plus"></i> Add New Pet
                                        </button>
                                    </div>
                                }
                            </div>

                            <!-- Loyalty Tab -->
                            <div class="tab-pane fade" id="loyalty">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="loyalty-section">
                                            <h6>Points Balance</h6>
                                            <div class="loyalty-points-display">@customer?.LoyaltyPoint pts</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="loyalty-section">
                                            <h6>Tier Status</h6>
                                            @if (isBlocked)
                                            {
                                                <button class="btn btn-sm btn-blocked" disabled title="Account blocked">
                                                    <i class="fa fa-lock"></i> Redeem Rewards
                                                </button>
                                            }
                                            else if (isInactive)
                                            {
                                                <div class="redeem-restricted">
                                                    <button class="btn btn-sm btn-orange-primary" disabled>
                                                        <i class="fa fa-gift"></i> Redeem Rewards
                                                    </button>
                                                </div>
                                                <p class="inactive-restriction-msg">
                                                    <i class="fa fa-exclamation-triangle"></i> 
                                                    Gift redemption is restricted for inactive accounts.
                                                </p>
                                            }
                                            else
                                            {
                                                <a href="/Customer/Home/Index#redeem_gift_area_start" class="btn btn-sm btn-orange-primary">
                                                    <i class="fa fa-gift"></i> Redeem Rewards
                                                </a>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tips Tab -->
                            <div class="tab-pane fade" id="tips">
                                <div class="list-group list-group-flush">
                                    <div class="list-group-item tips-item">
                                        <h6 class="mb-1">Grooming tip: Brushing</h6>
                                        <p class="small text-muted mb-0">Brush your pet twice a week.</p>
                                    </div>
                                    <div class="list-group-item tips-item">
                                        <h6 class="mb-1">Health tip: Vaccination</h6>
                                        <p class="small text-muted mb-0">Keep vaccinations up to date.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileOverlay" class="custom-modal-overlay">
    <div class="custom-modal-dialog" style="max-width: 600px;">
        <div class="custom-modal-content edit-profile-modal">
            <div class="custom-modal-header edit-profile-header">
                <h5 class="custom-modal-title"><i class="fa fa-user-edit"></i> Edit Profile</h5>
                <button type="button" class="custom-close-btn" onclick="closeEditModal()"><span>&times;</span></button>
            </div>

            <div class="custom-modal-body edit-profile-body">
                <!-- Tab Navigation for Profile Edit -->
                <ul class="nav nav-tabs nav-tabs-orange mb-3" id="editProfileTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="profile-info-tab" data-toggle="tab" href="#profileInfoTab" role="tab">
                            <i class="fa fa-user"></i> Profile Info
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="change-password-tab" data-toggle="tab" href="#changePasswordTab" role="tab">
                            <i class="fa fa-lock"></i> Change Password
                        </a>
                    </li>
                </ul>

                <div class="tab-content" id="editProfileTabContent">
                    <!-- Profile Info Tab -->
                    <div class="tab-pane fade show active" id="profileInfoTab" role="tabpanel">
                        <form id="editProfileForm" enctype="multipart/form-data" onsubmit="submitEditProfile(event)">
                            
                            <!-- Multi-Photo Upload Section -->
                            <div class="multi-photo-section text-center">
                                <h6><i class="fa fa-images"></i> Profile Photos</h6>
                                <p class="section-subtitle">Upload multiple photos - they will animate on your profile!</p>
                                
                                <!-- Drag & Drop Zone -->
                                <div class="drop-zone" id="dropZone" onclick="document.getElementById('multiFileInput').click()">
                                    <i class="fa fa-cloud-upload-alt"></i>
                                    <p>Drag & drop photos here or click to browse</p>
                                    <p class="drop-zone-hint">Select multiple files at once!</p>
                                </div>
                                
                                <!-- Hidden Multi-File Input -->
                                <input type="file" id="multiFileInput" accept="image/*" multiple style="display:none;" onchange="handleMultiFileSelect(event)" />
                                
                                <!-- Photo Upload Buttons -->
                                <div class="photo-upload-buttons mt-3">
                                    <button type="button" class="btn btn-upload" onclick="document.getElementById('multiFileInput').click()">
                                        <i class="fa fa-images"></i> Select Photos
                                    </button>
                                    <button type="button" class="btn btn-webcam" onclick="openWebcamModal()">
                                        <i class="fa fa-camera"></i> Use Webcam
                                    </button>
                                    <button type="button" class="btn btn-clear" onclick="clearAllPhotos()" id="clearPhotosBtn" style="display:none;">
                                        <i class="fa fa-trash"></i> Clear All
                                    </button>
                                </div>
                                
                                <!-- Photo Thumbnails Preview -->
                                <div class="photo-thumbnails-grid" id="photoThumbnailsGrid">
                                    <div class="empty-message" id="emptyPhotosMessage">
                                        <i class="fa fa-image"></i>
                                        <span>No photos added yet</span>
                                    </div>
                                </div>
                                
                                <!-- Hidden input to store all photo data as JSON -->
                                <input type="hidden" id="allPhotosData" name="allPhotosData" />
                            </div>

                            <hr>

                            <!-- Form Fields -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><strong>Full Name</strong> <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="fullName" name="name" value="@customer?.Name" required />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><strong>IC Number</strong></label>
                                    <input type="text" class="form-control" id="icNumber" name="ic" value="@customer?.IC" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><strong>Email</strong> <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="email" value="@customer?.Email" required />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><strong>Phone</strong></label>
                                    <input type="tel" class="form-control" id="phone" name="phone" value="@customer?.Phone" />
                                </div>
                            </div>

                            <div id="successMessage" class="alert alert-success" style="display:none;"></div>
                            <div id="errorMessage" class="alert alert-danger" style="display:none;"></div>
                            
                            <div class="text-right mt-3">
                                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                                <button type="submit" class="btn btn-orange-primary">
                                    <i class="fa fa-save"></i> Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Change Password Tab -->
                    <div class="tab-pane fade" id="changePasswordTab" role="tabpanel">
                        <form id="changePasswordForm" onsubmit="submitChangePassword(event)">
                            <div class="text-center mb-4">
                                <div style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, #ff9500, #ff6b00); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa fa-key" style="font-size: 32px; color: white;"></i>
                                </div>
                                <h6 class="mt-3">Change Your Password</h6>
                                <p class="text-muted small">Enter your current password and choose a new one</p>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><strong>Current Password</strong> <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="currentPassword" name="currentPassword" required placeholder="Enter current password" />
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('currentPassword', this)">
                                        <i class="fa fa-eye"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><strong>New Password</strong> <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="newPassword" name="newPassword" required placeholder="Enter new password" minlength="8" oninput="checkPasswordStrength()" />
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('newPassword', this)">
                                        <i class="fa fa-eye"></i>
                                    </button>
                                </div>
                                <!-- Password Strength Indicator -->
                                <div class="password-strength mt-2" id="passwordStrengthContainer" style="display:none;">
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" id="passwordStrengthBar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="passwordStrengthText" class="text-muted"></small>
                                </div>
                                <small class="text-muted">Password must be at least 8 characters</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><strong>Confirm New Password</strong> <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required placeholder="Confirm new password" minlength="8" oninput="checkPasswordMatch()" />
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('confirmPassword', this)">
                                        <i class="fa fa-eye"></i>
                                    </button>
                                </div>
                                <small id="passwordMatchText" class="text-muted"></small>
                            </div>

                            <div id="passwordSuccessMessage" class="alert alert-success" style="display:none;"></div>
                            <div id="passwordErrorMessage" class="alert alert-danger" style="display:none;"></div>

                            <div class="text-right mt-4">
                                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                                <button type="submit" class="btn btn-orange-primary" id="changePasswordBtn">
                                    <i class="fa fa-lock"></i> Change Password
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Webcam Modal -->
<div id="webcamOverlay" class="custom-modal-overlay">
    <div class="custom-modal-dialog" style="max-width: 500px;">
        <div class="custom-modal-content">
            <div class="custom-modal-header" style="background: linear-gradient(90deg, #28a745 0%, #20c997 100%);">
                <h5 class="custom-modal-title" style="color: white;"><i class="fa fa-camera"></i> Take Photo</h5>
                <button type="button" class="custom-close-btn" onclick="closeWebcamModal()"><span>&times;</span></button>
            </div>
            <div class="custom-modal-body" style="padding: 20px; text-align: center;">
                <div class="webcam-video-container" id="webcamContainer">
                    <video id="webcamVideo" autoplay playsinline></video>
                    <div class="webcam-guide-circle"></div>
                </div>
                
                <div class="webcam-preview-container" id="capturedPreviewContainer" style="display:none;">
                    <img id="capturedPreview" />
                    <p>Preview</p>
                </div>
                
                <div id="webcamError" class="alert alert-danger" style="display:none;">
                    <i class="fa fa-exclamation-triangle"></i> <span id="webcamErrorText"></span>
                </div>
                
                <div class="webcam-controls" id="webcamControls">
                    <button type="button" class="btn-capture" onclick="capturePhoto()">
                        <i class="fa fa-camera"></i> Capture
                    </button>
                </div>
                
                <div class="webcam-controls" id="afterCaptureControls" style="display:none;">
                    <button type="button" class="btn-retake" onclick="retakePhoto()">
                        <i class="fa fa-redo"></i> Retake
                    </button>
                    <button type="button" class="btn-use" onclick="useWebcamPhoto()">
                        <i class="fa fa-check"></i> Add Photo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Pet Modal -->
<div id="addPetOverlay" class="custom-modal-overlay pet-modal-overlay">
    <div class="custom-modal-dialog pet-modal-dialog">
        <div class="custom-modal-content edit-pet-modal">
            <div class="custom-modal-header edit-pet-header">
                <h5 class="custom-modal-title"><i class="fa fa-paw"></i> <span id="petModalTitle">Add Pet</span></h5>
                <button type="button" class="custom-close-btn" onclick="closeAddPetModal()"><span>&times;</span></button>
            </div>
            <div class="custom-modal-body edit-pet-body">
                <form id="editPetForm" enctype="multipart/form-data" onsubmit="submitPetForm(event)">
                    <input type="hidden" id="petIdInput" name="petId" />
                    <div class="text-center mb-3">
                        <img id="petPhotoPreview" src="/Customer/img/default-pet.png" class="rounded-circle" style="width:100px;height:100px;object-fit:cover;border:3px solid #ff9500;" />
                        <input type="file" id="petPhotoInput" name="petPhotoFile" accept="image/*" class="form-control mt-2" onchange="previewPetPhoto(event)" />
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label><strong>Pet Name</strong> *</label>
                            <input type="text" class="form-control" id="petName" name="name" required />
                        </div>
                        <div class="col-6 mb-3">
                            <label><strong>Age</strong></label>
                            <input type="number" class="form-control" id="petAge" name="age" min="0" max="50" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label><strong>Type</strong> *</label>
                            <select class="form-control" id="petType" name="type" required>
                                <option value="">Select</option>
                                <option value="Dog">🐕 Dog</option>
                                <option value="Cat">🐱 Cat</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label><strong>Breed</strong></label>
                            <input type="text" class="form-control" id="petBreed" name="breed" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label><strong>Remarks</strong></label>
                        <textarea class="form-control" id="petRemark" name="remark" rows="2"></textarea>
                    </div>
                    <div id="petSuccessMessage" class="alert alert-success" style="display:none;"></div>
                    <div id="petErrorMessage" class="alert alert-danger" style="display:none;"></div>
                </form>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddPetModal()">Cancel</button>
                <button type="submit" class="btn btn-orange-primary" form="editPetForm"><i class="fa fa-save"></i> Save</button>
            </div>
        </div>
    </div>
</div>

<canvas id="webcamCanvas" style="display:none;"></canvas>

@section Scripts {
<script>
    // ========== STATUS CONTROL VARIABLES ==========
    const customerStatus = '@customerStatus';
    const isBlocked = @(isBlocked.ToString().ToLower());
    const isInactive = @(isInactive.ToString().ToLower());
    const isActive = @(isActive.ToString().ToLower());

    // ========== PHOTO DATA STORAGE ==========
    let uploadedPhotos = [];
    
    // Initialize with existing photos
    @if (hasMultiplePhotos)
    {
        <text>
        uploadedPhotos = [
            @for (int i = 0; i < photoList.Count; i++)
            {
                if (photoList[i] != "/Customer/img/default-avatar.png")
                {
                    @:{ id: '@i', src: '@photoList[i]', isExisting: true },
                }
            }
        ];
        </text>
    }

    // ========== STATUS CHECK HELPER ==========
    function checkStatusBeforeAction(actionName) {
        if (isBlocked) {
            showBlockedToast('Action Blocked', 'Your account is blocked. You cannot ' + actionName + '.');
            return false;
        }
        return true;
    }

    function showBlockedToast(title, message) {
        // Remove existing toast if any
        const existingToast = document.querySelector('.action-blocked-toast');
        if (existingToast) existingToast.remove();

        const toast = document.createElement('div');
        toast.className = 'action-blocked-toast';
        toast.innerHTML = `
            <i class="fa fa-ban"></i>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
        `;
        document.body.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // ========== AVATAR ANIMATION ==========
    let currentPhotoIndex = 0;
    let avatarAnimationInterval = null;
    let isAnimationPaused = false;
    const ANIMATION_DELAY = 3000;

    function initAvatarAnimation() {
        const photos = document.querySelectorAll('.animated-avatar-container .avatar-photo');
        if (photos.length <= 1) return;
        
        avatarAnimationInterval = setInterval(() => {
            if (isAnimationPaused) return;
            
            photos[currentPhotoIndex].classList.remove('active');
            const indicators = document.querySelectorAll('.avatar-indicator');
            if (indicators[currentPhotoIndex]) indicators[currentPhotoIndex].classList.remove('active');
            
            currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
            
            photos[currentPhotoIndex].classList.add('active');
            if (indicators[currentPhotoIndex]) indicators[currentPhotoIndex].classList.add('active');
        }, ANIMATION_DELAY);
    }

    function goToPhoto(index) {
        const photos = document.querySelectorAll('.animated-avatar-container .avatar-photo');
        const indicators = document.querySelectorAll('.avatar-indicator');
        
        if (photos[currentPhotoIndex]) photos[currentPhotoIndex].classList.remove('active');
        if (indicators[currentPhotoIndex]) indicators[currentPhotoIndex].classList.remove('active');
        
        currentPhotoIndex = index;
        
        if (photos[currentPhotoIndex]) photos[currentPhotoIndex].classList.add('active');
        if (indicators[currentPhotoIndex]) indicators[currentPhotoIndex].classList.add('active');
    }

    // ========== MULTI-FILE UPLOAD ==========
    function handleMultiFileSelect(event) {
        if (!checkStatusBeforeAction('upload photos')) return;
        
        const files = event.target.files;
        if (!files.length) return;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (!file.type.startsWith('image/')) continue;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                addPhotoToGrid(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        event.target.value = '';
    }

    function addPhotoToGrid(imageSrc) {
        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        uploadedPhotos.push({ id: photoId, src: imageSrc, isExisting: false });
        renderPhotoGrid();
        updatePhotosInput();
    }

    function removePhoto(photoId) {
        uploadedPhotos = uploadedPhotos.filter(p => p.id !== photoId);
        renderPhotoGrid();
        updatePhotosInput();
    }

    function clearAllPhotos() {
        if (!confirm('Remove all photos?')) return;
        uploadedPhotos = [];
        renderPhotoGrid();
        updatePhotosInput();
    }

    function renderPhotoGrid() {
        const grid = document.getElementById('photoThumbnailsGrid');
        const emptyMsg = document.getElementById('emptyPhotosMessage');
        const clearBtn = document.getElementById('clearPhotosBtn');
        
        grid.querySelectorAll('.photo-thumbnail').forEach(el => el.remove());
        
        if (uploadedPhotos.length === 0) {
            emptyMsg.style.display = 'flex';
            clearBtn.style.display = 'none';
            grid.classList.remove('has-photos');
        } else {
            emptyMsg.style.display = 'none';
            clearBtn.style.display = 'inline-flex';
            grid.classList.add('has-photos');
            
            uploadedPhotos.forEach((photo, index) => {
                const thumb = document.createElement('div');
                thumb.className = 'photo-thumbnail';
                thumb.innerHTML = `
                    <img src="${photo.src}" alt="Photo ${index + 1}" />
                    <span class="photo-number">${index + 1}</span>
                    <button type="button" class="remove-btn" onclick="removePhoto('${photo.id}')">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                grid.appendChild(thumb);
            });
        }
    }

    function updatePhotosInput() {
        const photosData = uploadedPhotos.map(p => p.src);
        document.getElementById('allPhotosData').value = JSON.stringify(photosData);
    }

    // ========== DRAG & DROP ==========
    const dropZone = document.getElementById('dropZone');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone?.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone?.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone?.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
    });

    dropZone?.addEventListener('drop', function(e) {
        if (!checkStatusBeforeAction('upload photos')) return;
        
        const files = e.dataTransfer.files;
        for (let i = 0; i < files.length; i++) {
            if (!files[i].type.startsWith('image/')) continue;
            const reader = new FileReader();
            reader.onload = function(ev) {
                addPhotoToGrid(ev.target.result);
            };
            reader.readAsDataURL(files[i]);
        }
    }, false);

    // ========== WEBCAM ==========
    let webcamData = { stream: null, capturedImage: null };

    async function openWebcamModal() {
        if (!checkStatusBeforeAction('use webcam')) return;
        
        document.getElementById('webcamOverlay').classList.add('show');
        document.getElementById('webcamContainer').style.display = 'block';
        document.getElementById('capturedPreviewContainer').style.display = 'none';
        document.getElementById('webcamControls').style.display = 'flex';
        document.getElementById('afterCaptureControls').style.display = 'none';
        document.getElementById('webcamError').style.display = 'none';

        try {
            const video = document.getElementById('webcamVideo');
            webcamData.stream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' }
            });
            video.srcObject = webcamData.stream;
            await video.play();
        } catch (error) {
            document.getElementById('webcamErrorText').textContent = 'Unable to access webcam.';
            document.getElementById('webcamError').style.display = 'block';
            document.getElementById('webcamControls').style.display = 'none';
        }
    }

    function closeWebcamModal() {
        document.getElementById('webcamOverlay').classList.remove('show');
        if (webcamData.stream) {
            webcamData.stream.getTracks().forEach(track => track.stop());
            webcamData.stream = null;
        }
        document.getElementById('webcamVideo').srcObject = null;
    }

    function capturePhoto() {
        const video = document.getElementById('webcamVideo');
        const canvas = document.getElementById('webcamCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        webcamData.capturedImage = canvas.toDataURL('image/jpeg', 0.9);
        
        document.getElementById('capturedPreview').src = webcamData.capturedImage;
        document.getElementById('webcamContainer').style.display = 'none';
        document.getElementById('capturedPreviewContainer').style.display = 'block';
        document.getElementById('webcamControls').style.display = 'none';
        document.getElementById('afterCaptureControls').style.display = 'flex';
        video.pause();
    }

    function retakePhoto() {
        document.getElementById('webcamContainer').style.display = 'block';
        document.getElementById('capturedPreviewContainer').style.display = 'none';
        document.getElementById('webcamControls').style.display = 'flex';
        document.getElementById('afterCaptureControls').style.display = 'none';
        document.getElementById('webcamVideo').play();
    }

    function useWebcamPhoto() {
        if (!webcamData.capturedImage) return;
        addPhotoToGrid(webcamData.capturedImage);
        closeWebcamModal();
    }

    // ========== MODALS ==========
    function openEditModal() {
        if (!checkStatusBeforeAction('edit profile')) return;
        
        document.getElementById('editProfileOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
        renderPhotoGrid();
        updatePhotosInput();
        $('#editProfileTabs a[href="#profileInfoTab"]').tab('show');
        document.getElementById('changePasswordForm').reset();
        hidePasswordMessages();
    }

    function closeEditModal() {
        document.getElementById('editProfileOverlay').classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    // ========== FORM SUBMISSION ==========
    function submitEditProfile(event) {
        event.preventDefault();
        
        if (!checkStatusBeforeAction('update profile')) return;
        
        const formData = new FormData(document.getElementById('editProfileForm'));
        
        fetch('/Customer/Home/UpdateProfileMultiPhoto', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('successMessage').textContent = 'Profile updated!';
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(() => { closeEditModal(); location.reload(); }, 1500);
            } else {
                document.getElementById('errorMessage').textContent = data.message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        })
        .catch(error => {
            document.getElementById('errorMessage').textContent = 'Error updating profile';
            document.getElementById('errorMessage').style.display = 'block';
        });
    }

    // ========== CHANGE PASSWORD FUNCTIONS ==========
    function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function checkPasswordStrength() {
        const password = document.getElementById('newPassword').value;
        const container = document.getElementById('passwordStrengthContainer');
        const bar = document.getElementById('passwordStrengthBar');
        const text = document.getElementById('passwordStrengthText');
        
        if (password.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        let strength = 0;
        let feedback = '';
        
        if (password.length >= 8) strength += 25;
        if (password.length >= 12) strength += 10;
        if (/[A-Z]/.test(password)) strength += 20;
        if (/[a-z]/.test(password)) strength += 15;
        if (/[0-9]/.test(password)) strength += 15;
        if (/[^A-Za-z0-9]/.test(password)) strength += 15;
        
        bar.style.width = strength + '%';
        bar.classList.remove('bg-danger', 'bg-warning', 'bg-info', 'bg-success');
        
        if (strength < 30) {
            bar.classList.add('bg-danger');
            feedback = 'Weak';
        } else if (strength < 50) {
            bar.classList.add('bg-warning');
            feedback = 'Fair';
        } else if (strength < 75) {
            bar.classList.add('bg-info');
            feedback = 'Good';
        } else {
            bar.classList.add('bg-success');
            feedback = 'Strong';
        }
        
        text.textContent = feedback;
    }

    function checkPasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const matchText = document.getElementById('passwordMatchText');
        
        if (confirmPassword.length === 0) {
            matchText.textContent = '';
            matchText.classList.remove('text-success', 'text-danger');
            return;
        }
        
        if (newPassword === confirmPassword) {
            matchText.textContent = '✓ Passwords match';
            matchText.classList.remove('text-danger');
            matchText.classList.add('text-success');
        } else {
            matchText.textContent = '✗ Passwords do not match';
            matchText.classList.remove('text-success');
            matchText.classList.add('text-danger');
        }
    }

    function hidePasswordMessages() {
        document.getElementById('passwordSuccessMessage').style.display = 'none';
        document.getElementById('passwordErrorMessage').style.display = 'none';
        document.getElementById('passwordStrengthContainer').style.display = 'none';
        document.getElementById('passwordMatchText').textContent = '';
    }

    function submitChangePassword(event) {
        event.preventDefault();
        
        if (!checkStatusBeforeAction('change password')) return;
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        hidePasswordMessages();
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            document.getElementById('passwordErrorMessage').textContent = 'All fields are required.';
            document.getElementById('passwordErrorMessage').style.display = 'block';
            return;
        }
        
        if (newPassword.length < 8) {
            document.getElementById('passwordErrorMessage').textContent = 'New password must be at least 8 characters.';
            document.getElementById('passwordErrorMessage').style.display = 'block';
            return;
        }
        
        if (newPassword !== confirmPassword) {
            document.getElementById('passwordErrorMessage').textContent = 'New passwords do not match.';
            document.getElementById('passwordErrorMessage').style.display = 'block';
            return;
        }
        
        if (currentPassword === newPassword) {
            document.getElementById('passwordErrorMessage').textContent = 'New password must be different from current password.';
            document.getElementById('passwordErrorMessage').style.display = 'block';
            return;
        }
        
        const btn = document.getElementById('changePasswordBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
        
        const formData = new FormData();
        formData.append('currentPassword', currentPassword);
        formData.append('newPassword', newPassword);
        
        fetch('/Customer/Home/ChangePassword', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-lock"></i> Change Password';
            
            if (data.success) {
                document.getElementById('passwordSuccessMessage').textContent = data.message || 'Password changed successfully!';
                document.getElementById('passwordSuccessMessage').style.display = 'block';
                document.getElementById('changePasswordForm').reset();
                
                setTimeout(() => { closeEditModal(); }, 2000);
            } else {
                document.getElementById('passwordErrorMessage').textContent = data.message || 'Failed to change password.';
                document.getElementById('passwordErrorMessage').style.display = 'block';
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-lock"></i> Change Password';
            document.getElementById('passwordErrorMessage').textContent = 'An error occurred. Please try again.';
            document.getElementById('passwordErrorMessage').style.display = 'block';
        });
    }

    // ========== PET FUNCTIONS ==========
    function openAddPetModal() {
        if (!checkStatusBeforeAction('add pet')) return;
        
        document.getElementById('petIdInput').value = '';
        document.getElementById('petModalTitle').textContent = 'Add Pet';
        document.getElementById('editPetForm').reset();
        document.getElementById('petPhotoPreview').src = '/Customer/img/default-pet.png';
        document.getElementById('petSuccessMessage').style.display = 'none';
        document.getElementById('petErrorMessage').style.display = 'none';
        document.getElementById('addPetOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function openEditPetModal(petId) {
        if (!checkStatusBeforeAction('edit pet')) return;
        
        fetch(`/Customer/Home/GetPetById?petId=${petId}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const pet = data.data;
                document.getElementById('petIdInput').value = pet.petId;
                document.getElementById('petName').value = pet.name || '';
                document.getElementById('petAge').value = pet.age || '';
                document.getElementById('petType').value = pet.type || '';
                document.getElementById('petBreed').value = pet.breed || '';
                document.getElementById('petRemark').value = pet.remark || '';
                document.getElementById('petPhotoPreview').src = pet.photo || '/Customer/img/default-pet.png';
                document.getElementById('petModalTitle').textContent = 'Edit Pet';
                document.getElementById('petSuccessMessage').style.display = 'none';
                document.getElementById('petErrorMessage').style.display = 'none';
                document.getElementById('addPetOverlay').classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        });
    }

    function closeAddPetModal() {
        document.getElementById('addPetOverlay').classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    function submitPetForm(event) {
        event.preventDefault();
        
        if (!checkStatusBeforeAction('save pet')) return;
        
        const petId = document.getElementById('petIdInput').value;
        const formData = new FormData(document.getElementById('editPetForm'));
        const url = petId ? '/Customer/Home/UpdatePet' : '/Customer/Home/AddPet';

        fetch(url, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('petSuccessMessage').textContent = petId ? 'Pet updated!' : 'Pet added!';
                document.getElementById('petSuccessMessage').style.display = 'block';
                setTimeout(() => { closeAddPetModal(); location.reload(); }, 1000);
            } else {
                document.getElementById('petErrorMessage').textContent = data.message;
                document.getElementById('petErrorMessage').style.display = 'block';
            }
        })
        .catch(error => {
            document.getElementById('petErrorMessage').textContent = 'Error saving pet';
            document.getElementById('petErrorMessage').style.display = 'block';
        });
    }

    function deletePet(petId, petName) {
        if (!checkStatusBeforeAction('delete pet')) return;
        if (!confirm(`Delete ${petName}?`)) return;
        const formData = new FormData();
        formData.append('petId', petId);
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value);
        fetch('/Customer/Home/DeletePet', { method: 'POST', body: formData })
        .then(async response => {
            const text = await response.text();
            try {
                const data = JSON.parse(text);
                if (data.success) {
                    location.reload();
                } else {
                    console.error('DeletePet error response:', data);
                    alert(data.message || 'Delete failed');
                }
            } catch (err) {
                console.error('Failed to parse DeletePet response as JSON:', text, err);
                alert('Server error while deleting pet. See console for details.');
            }
        })
        .catch(err => {
            console.error('DeletePet request failed:', err);
            alert('Request failed. See console for details.');
        });
    }

    function previewPetPhoto(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById('petPhotoPreview').src = e.target.result;
            reader.readAsDataURL(file);
        }
    }

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', function() {
        initAvatarAnimation();
        
        // Close on overlay click
        document.querySelectorAll('.custom-modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                    document.body.style.overflow = 'auto';
                    if (overlay.id === 'webcamOverlay') closeWebcamModal();
                }
            });
        });
        
        // ESC to close
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closeEditModal();
                closeAddPetModal();
                closeWebcamModal();
            }
        });
    });
</script>
}
