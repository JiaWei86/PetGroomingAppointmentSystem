@{
    ViewData["Title"] = "My Profile";
    var customer = ViewBag.Customer as PetGroomingAppointmentSystem.Models.Customer;
    var pets = ViewBag.Pets as List<PetGroomingAppointmentSystem.Models.Pet> ?? new List<PetGroomingAppointmentSystem.Models.Pet>();
}

<div class="bradcam_area breadcam_bg">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="bradcam_text text-center wow fadeInUp" data-wow-delay="0.2s">
                    <h3>Profile</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="profile-page-wrapper">

    <div class="container py-4">
        <div class="row">
            <!-- Left column: profile card -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm profile-card-main">
                    <div class="card-body text-center">
                        <!-- Avatar -->
                        <img src="@(string.IsNullOrEmpty(customer?.Photo) ? "/Customer/img/default-avatar.png" : customer.Photo)"
                             alt="avatar"
                             class="rounded-circle mb-3 profile-avatar"
                             id="profileAvatarDisplay"
                             style="object-fit:cover;" />

                        <h4 class="card-title mb-0" id="profileName">@customer?.Name</h4>
                        <div class="text-muted mb-2" id="profilePhone">@customer?.Phone</div>

                        <p class="small text-muted" id="profileEmail">@customer?.Email</p>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-orange-primary" id="editProfileBtn" onclick="openEditModal()">Edit Profile</button>
                            <a href="/Customer/Home/History" class="btn btn-orange-outline">
                                <i class="fa fa-history"></i> View History
                            </a>
                        </div>
                    </div>

                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>Member since:</strong>
                            <span class="float-right">@customer?.RegisteredDate?.ToString("MMM yyyy")</span>
                        </li>

                        <li class="list-group-item">
                            <strong>Status:</strong>
                            <span class="badge-orange float-right">@(string.IsNullOrEmpty(customer?.Status) ? "ACTIVE" : customer.Status.ToUpper())</span>
                        </li>

                        <li class="list-group-item">
                            <strong>Loyalty Points:</strong>
                            <span class="float-right text-warning font-weight-bold" id="loyaltyPointsDisplay">@customer?.LoyaltyPoint</span>
                        </li>
                    </ul>
                </div>


                <!-- Quick Actions card -->
                <div class="card mt-3 quick-actions-card">
                    <div class="card-body">
                        <h6 class="card-title">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button onclick="openAddPetModal()" class="btn btn-orange-primary btn-sm">+ Add Pet</button>
                            <a href="/Customer/Home/Appointment" class="btn btn-orange-outline btn-sm">Book Service</a>
                            <a href="/Customer/Home/History" class="btn btn-orange-outline btn-sm">View History</a>
                        </div>
                    </div>
                </div>

                <!-- Suggested promotion / voucher -->
                <div class="card mt-3 promotion-card">
                    <div class="card-body">
                        <h6 class="card-title">Exclusive Offer</h6>
                        <p class="small mb-2">You have a <strong>10% discount</strong> available for your grooming service!</p>
                        <a href="/Customer/Home/Appointment" class="btn btn-redeem btn-sm">Book Now</a>
                    </div>
                </div>
            </div>

            <!-- Right column: tabs for Pets / Loyalty / Tips -->
            <div class="col-lg-8">
                <div class="card profile-card-main">
                    <div class="card-body">
                        <!-- Tabs -->
                        <ul class="nav nav-tabs nav-tabs-orange" id="profileTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link active" id="pets-tab" data-toggle="tab" href="#pets" role="tab" aria-controls="pets" aria-selected="true">Pets (@pets.Count)</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="loyalty-tab" data-toggle="tab" href="#loyalty" role="tab" aria-controls="loyalty" aria-selected="false">Loyalty & Rewards</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="tips-tab" data-toggle="tab" href="#tips" role="tab" aria-controls="tips" aria-selected="false">Pet Care Tips</a>
                            </li>
                        </ul>

                        <div class="tab-content pt-3" id="profileTabContent">
                            <!-- Pets tab -->
                            <div class="tab-pane fade show active" id="pets" role="tabpanel" aria-labelledby="pets-tab">
                                <div class="row gy-3" id="petsContainer">
                                    @if (pets.Any())
                                    {
                                        @foreach (var pet in pets)
                                        {
                                            <div class="col-md-6">
                                                <div class="card h-100 pet-card">
                                                    <div class="row no-gutters align-items-center">
                                                        <div class="col-4 text-center p-3">
                                                            <img src="@(string.IsNullOrEmpty(pet.Photo) ? "/Customer/img/default-pet.png" : pet.Photo)" 
                                                                 alt="@pet.Name"
                                                                 class="rounded-circle" 
                                                                 style="width:72px;height:72px;object-fit:cover;border:2px solid #ff9500;" />
                                                        </div>
                                                        <div class="col-8">
                                                            <div class="card-body py-2">
                                                                <h6 class="card-title mb-1">@pet.Name</h6>
                                                                <p class="small text-muted mb-1">@pet.Type - @pet.Breed</p>
                                                                <p class="small text-muted mb-1">Age: @pet.Age years</p>
                                                                <div class="d-flex gap-2">
                                                                    <button type="button" class="btn btn-sm btn-orange-outline" onclick="openEditPetModal('@pet.PetId')">Edit</button>
                                                                    <button type="button" class="btn btn-sm btn-danger" onclick="deletePet('@pet.PetId', '@pet.Name')">Delete</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="col-12">
                                            <p class="text-center text-muted">No pets yet. Add your first pet!</p>
                                        </div>
                                    }
                                </div>

                                <div class="mt-3 text-center">
                                    <button onclick="openAddPetModal()" class="btn btn-sm btn-orange-primary">+ Add New Pet</button>
                                </div>
                            </div>

                            <!-- Loyalty tab -->
                            <div class="tab-pane fade" id="loyalty" role="tabpanel" aria-labelledby="loyalty-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="loyalty-section">
                                            <h6 class="mb-3">Points Balance</h6>
                                            <div class="loyalty-points-display" id="loyaltyBalance">@customer?.LoyaltyPoint pts</div>
                                            <p class="small text-muted">Earn points for every booking. Redeem for rewards.</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="loyalty-section">
                                            <h6 class="mb-3">Tier Status</h6>
                                            <p class="small text-muted">You are a valued member!</p>
                                            <a href="/Customer/Home/Index#redeem_gift_area_start" class="btn btn-sm btn-orange-primary">
                                                <i class="fa fa-gift"></i> Redeem Rewards
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tips tab -->
                            <div class="tab-pane fade" id="tips" role="tabpanel" aria-labelledby="tips-tab">
                                <div class="list-group list-group-flush">
                                    <div class="list-group-item tips-item">
                                        <h6 class="mb-1">Grooming tip: Brushing</h6>
                                        <p class="small text-muted mb-0">Brush your pet twice a week to reduce shedding and mats.</p>
                                    </div>
                                    <div class="list-group-item tips-item">
                                        <h6 class="mb-1">Health tip: Vaccination</h6>
                                        <p class="small text-muted mb-0">Keep your pet vaccinations up to date. Contact us for reminders.</p>
                                    </div>
                                    <div class="list-group-item tips-item">
                                        <h6 class="mb-1">Seasonal: Cooling</h6>
                                        <p class="small text-muted mb-0">In hot weather, keep short walks and provide water breaks.</p>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- end tab content -->
                    </div> <!-- end card body -->
                </div> <!-- end card -->
                <!-- Recommended Services / Suggestions -->
                <div class="card profile-card-main mt-3">
                    <div class="card-body">
                        <h6 class="card-title mb-3">Recommended for your pets</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="service-box">
                                    <div class="mb-2"><strong>Full Groom</strong></div>
                                    <div class="small text-muted mb-2">Complete grooming package</div>
                                    <a href="/Customer/Home/Appointment" class="btn btn-sm btn-orange-primary">Book</a>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="service-box">
                                    <div class="mb-2"><strong>Nail Trim</strong></div>
                                    <div class="small text-muted mb-2">Quick & safe</div>
                                    <a href="/Customer/Home/Appointment" class="btn btn-sm btn-orange-primary">Book</a>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="service-box">
                                    <div class="mb-2"><strong>Bath & Brush</strong></div>
                                    <div class="small text-muted mb-2">Fresh & clean</div>
                                    <a href="/Customer/Home/Appointment" class="btn btn-sm btn-orange-primary">Book</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- end right column -->
        </div> <!-- end row -->
    </div>
</div>

<!-- Edit User Profile Modal -->
<div id="editProfileOverlay" class="custom-modal-overlay">
    <div class="custom-modal-dialog">
        <div class="custom-modal-content edit-profile-modal">
            <div class="custom-modal-header edit-profile-header">
                <h5 class="custom-modal-title">
                    <i class="fa fa-user-edit"></i> Account Settings
                </h5>
                <button type="button" class="custom-close-btn" onclick="closeEditModal()">
                    <span>&times;</span>
                </button>
            </div>

            <div class="custom-modal-body edit-profile-body">
                <!-- Tabs for Edit Profile and Change Password -->
                <ul class="nav nav-tabs nav-tabs-orange mb-3" id="accountSettingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="edit-profile-tab" data-toggle="tab" href="#edit-profile-content" role="tab" aria-controls="edit-profile-content" aria-selected="true">
                            <i class="fa fa-user"></i> Edit Profile
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="change-password-tab" data-toggle="tab" href="#change-password-content" role="tab" aria-controls="change-password-content" aria-selected="false">
                            <i class="fa fa-lock"></i> Change Password
                        </a>
                    </li>
                </ul>

                <div class="tab-content" id="accountSettingsTabContent">
                    <!-- Edit Profile Tab -->
                    <div class="tab-pane fade show active" id="edit-profile-content" role="tabpanel" aria-labelledby="edit-profile-tab">
                        <form id="editProfileForm" enctype="multipart/form-data" onsubmit="submitEditProfile(event)">
                            <!-- Photo Upload Section -->
                            <div class="photo-upload-section mb-4">
                                <div class="text-center">
                                    <!-- Image Preview -->
                                    <div class="photo-preview-wrapper mb-3" id="photoPreviewWrapper">
                                        <img id="photoPreview" 
                                             src="@(string.IsNullOrEmpty(customer?.Photo) ? "/Customer/img/default-avatar.png" : customer.Photo)"
                                             alt="Profile Photo"
                                             class="rounded-circle"
                                             style="width:120px;height:120px;object-fit:cover;border:3px solid #ff9500;cursor:pointer;" 
                                             onclick="openImageEditor()" />
                                        <small style="display: block; margin-top: 8px; color: #999;">Click to edit</small>
                                    </div>

                                    <!-- File Upload Input -->
                                    <div class="photo-upload-input mt-3">
                                        <input type="file" 
                                               id="photoInput" 
                                               name="photoFile" 
                                               accept="image/*" 
                                               class="form-control"
                                               onchange="previewPhoto(event)" />
                                        <small class="text-muted d-block mt-2">
                                            <i class="fa fa-info-circle"></i> Recommended: 300x300px, Max 5MB
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <!-- Form Fields -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fullName" class="form-label">
                                        <strong>Full Name</strong>
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control edit-profile-input" 
                                           id="fullName" 
                                           name="name"
                                           value="@customer?.Name"
                                           required />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="icNumber" class="form-label">
                                        <strong>IC Number</strong>
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control edit-profile-input" 
                                           id="icNumber" 
                                           name="ic"
                                           value="@customer?.IC"
                                           required />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">
                                        <strong>Email Address</strong>
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="email" 
                                           class="form-control edit-profile-input" 
                                           id="email" 
                                           name="email"
                                           value="@customer?.Email"
                                           required />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">
                                        <strong>Phone Number</strong>
                                    </label>
                                    <input type="tel" 
                                           class="form-control edit-profile-input" 
                                           id="phone" 
                                           name="phone"
                                           value="@customer?.Phone" />
                                </div>
                            </div>

                            <!-- Success Message -->
                            <div id="successMessage" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none;">
                                <i class="fa fa-check-circle"></i> Profile updated successfully!
                                <button type="button" class="close" onclick="this.parentElement.style.display='none';" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>

                            <!-- Error Message -->
                            <div id="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert" style="display:none;">
                                <i class="fa fa-exclamation-circle"></i> <span id="errorText"></span>
                                <button type="button" class="close" onclick="this.parentElement.style.display='none';" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Change Password Tab -->
                    <div class="tab-pane fade" id="change-password-content" role="tabpanel" aria-labelledby="change-password-tab">
                        <form id="changePasswordForm" onsubmit="submitChangePassword(event)">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">
                                    <strong>Current Password</strong>
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="password" 
                                       class="form-control edit-profile-input" 
                                       id="currentPassword" 
                                       name="currentPassword"
                                       required />
                            </div>

                            <div class="mb-3">
                                <label for="newPassword" class="form-label">
                                    <strong>New Password</strong>
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="password" 
                                       class="form-control edit-profile-input" 
                                       id="newPassword" 
                                       name="newPassword"
                                       required />
                                <small class="text-muted d-block mt-2">
                                    <i class="fa fa-info-circle"></i> Password must be at least 8 characters long
                                </small>
                            </div>

                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">
                                    <strong>Confirm New Password</strong>
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="password" 
                                       class="form-control edit-profile-input" 
                                       id="confirmPassword" 
                                       name="confirmPassword"
                                       required />
                            </div>

                            <div id="passwordSuccessMessage" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none;">
                                <i class="fa fa-check-circle"></i> Password changed successfully!
                                <button type="button" class="close" onclick="this.parentElement.style.display='none';" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>

                            <div id="passwordErrorMessage" class="alert alert-danger alert-dismissible fade show" role="alert" style="display:none;">
                                <i class="fa fa-exclamation-circle"></i> <span id="passwordErrorText"></span>
                                <button type="button" class="close" onclick="this.parentElement.style.display='none';" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="custom-modal-footer edit-profile-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-orange-primary" id="submitBtn" form="editProfileForm">
                    <i class="fa fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Pet Modal -->
<div id="addPetOverlay" class="custom-modal-overlay pet-modal-overlay">
    <div class="custom-modal-dialog pet-modal-dialog">
        <div class="custom-modal-content edit-pet-modal">
            <div class="custom-modal-header edit-pet-header">
                <div class="pet-header-content">
                    <h5 class="custom-modal-title">
                        <i class="fa fa-paw"></i> <span id="petModalTitle">Add New Pet</span>
                    </h5>
                    <p class="pet-header-subtitle mb-0">Create a new pet profile</p>
                </div>
                <button type="button" class="custom-close-btn" onclick="closeAddPetModal()">
                    <span>&times;</span>
                </button>
            </div>

            <div class="custom-modal-body edit-pet-body">
                <form id="editPetForm" enctype="multipart/form-data" onsubmit="submitPetForm(event)">
                    <input type="hidden" id="petIdInput" name="petId" value="" />

                    <div class="pet-photo-upload-section mb-4">
                        <div class="text-center">
                            <div class="pet-photo-preview-wrapper mb-3">
                                <img id="petPhotoPreview" 
                                     src="/Customer/img/default-pet.png"
                                     alt="Pet Photo"
                                     class="rounded-circle"
                                     style="width:130px;height:130px;object-fit:cover;border:4px dashed #ff9500;" />
                                <div class="pet-photo-overlay">
                                    <i class="fa fa-camera"></i>
                                </div>
                            </div>
                            <div class="pet-photo-upload-input">
                                <input type="file" 
                                       id="petPhotoInput" 
                                       name="petPhotoFile" 
                                       accept="image/*" 
                                       class="form-control"
                                       onchange="previewPetPhoto(event)" />
                                <small class="text-muted d-block mt-2">
                                    <i class="fa fa-upload"></i> Click to upload pet photo
                                </small>
                            </div>
                        </div>
                    </div>

                    <hr class="pet-divider">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="petName" class="form-label pet-form-label">
                                <i class="fa fa-tag"></i> <strong>Pet Name</strong>
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control edit-pet-input" 
                                   id="petName" 
                                   name="name"
                                   required />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="petAge" class="form-label pet-form-label">
                                <i class="fa fa-birthday-cake"></i> <strong>Age (Years)</strong>
                            </label>
                            <input type="number" 
                                   class="form-control edit-pet-input" 
                                   id="petAge" 
                                   name="age"
                                   min="0"
                                   max="50"
                                   step="0.5" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="petType" class="form-label pet-form-label">
                                <i class="fa fa-paw"></i> <strong>Pet Type</strong>
                                <span class="text-danger">*</span>
                            </label>
                            <select class="form-control edit-pet-input" id="petType" name="type" required>
                                <option value="">Select pet type</option>
                                <option value="Dog">🐕 Dog</option>
                                <option value="Cat">🐱 Cat</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="petBreed" class="form-label pet-form-label">
                                <i class="fa fa-paw"></i> <strong>Breed</strong>
                            </label>
                            <input type="text" 
                                   class="form-control edit-pet-input" 
                                   id="petBreed" 
                                   name="breed" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="petRemark" class="form-label pet-form-label">
                            <i class="fa fa-sticky-note"></i> <strong>Remarks / Special Notes</strong>
                        </label>
                        <textarea class="form-control edit-pet-input" 
                                  id="petRemark" 
                                  name="remark"
                                  rows="3"
                                  placeholder="Any allergies, behaviors, or special care requirements..."></textarea>
                    </div>

                    <div id="petSuccessMessage" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none;">
                        <i class="fa fa-check-circle"></i> <span id="petSuccessText">Pet added successfully!</span>
                        <button type="button" class="close" onclick="this.parentElement.style.display='none';" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div id="petErrorMessage" class="alert alert-danger alert-dismissible fade show" role="alert" style="display:none;">
                        <i class="fa fa-exclamation-circle"></i> <span id="petErrorText"></span>
                        <button type="button" class="close" onclick="this.parentElement.style.display='none';" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="custom-modal-footer edit-pet-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddPetModal()">
                    <i class="fa fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn btn-primary edit-pet-save-btn" form="editPetForm">
                    <i class="fa fa-heart"></i> Save Pet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Editor Modal -->
<div id="imageEditorOverlay" class="custom-modal-overlay">
    <div class="custom-modal-dialog">
        <div class="custom-modal-content">
            <div class="custom-modal-header" style="background: linear-gradient(90deg, #ff9500 0%, #ff6b35 100%);">
                <h5 class="custom-modal-title" style="color: white;">
                    <i class="fa fa-crop"></i> Edit Photo
                </h5>
                <button type="button" class="custom-close-btn" onclick="closeImageEditor()">
                    <span>&times;</span>
                </button>
            </div>
            <div class="custom-modal-body" style="padding: 20px; text-align: center;">
                <div id="imageEditorContainer">
                    <img id="editorImage" style="max-width: 100%; max-height: 400px; margin-bottom: 20px;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: center, flex-wrap: wrap; margin-bottom: 20px;">
                    <button type="button" class="btn btn-sm" style="background: #ff9500; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="rotateImage(90)">
                        <i class="fa fa-rotate-right"></i> Rotate
                    </button>
                    <button type="button" class="btn btn-sm" style="background: #ff9500; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="zoomImage(1.1)">
                        <i class="fa fa-search-plus"></i> Zoom In
                    </button>
                    <button type="button" class="btn btn-sm" style="background: #ff9500; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="zoomImage(0.9)">
                        <i class="fa fa-search-minus"></i> Zoom Out
                    </button>
                    <button type="button" class="btn btn-sm" style="background: #ff9500; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="resetImage()">
                        <i class="fa fa-undo"></i> Reset
                    </button>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" style="background: #e9ecef; color: #495057; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;" onclick="closeImageEditor()">
                        Cancel
                    </button>
                    <button type="button" class="btn" style="background: linear-gradient(90deg, #ff9500 0%, #ff6b35 100%); color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;" onclick="confirmImageEdit()">
                        <i class="fa fa-check"></i> Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<canvas id="webcamCanvas" style="display:none;"></canvas>

<script>
    let imageEditorData = {
        originalSrc: '',
        rotation: 0,
        scale: 1,
        targetElement: null,
        isWebcamImage: false
    };

    function openEditModal() {
        document.getElementById('editProfileOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        document.getElementById('editProfileOverlay').classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    function submitEditProfile(event) {
        event.preventDefault();
    
        const formData = new FormData(document.getElementById('editProfileForm'));
    
        fetch('/Customer/Home/UpdateProfile', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Profile updated successfully!');
                document.getElementById('profileName').textContent = formData.get('name');
                document.getElementById('profilePhone').textContent = formData.get('phone');
                document.getElementById('profileEmail').textContent = formData.get('email');
                setTimeout(() => closeEditModal(), 1500);
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            showError('Error updating profile');
            console.error('Error:', error);
        });
    }

    function submitChangePassword(event) {
        event.preventDefault();
    
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
    
        if (newPassword !== confirmPassword) {
            showPasswordError('Passwords do not match!');
            return;
        }
    
        const formData = new FormData(document.getElementById('changePasswordForm'));
    
        fetch('/Customer/Home/ChangePassword', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPasswordSuccess('Password changed successfully!');
                document.getElementById('changePasswordForm').reset();
                setTimeout(() => closeEditModal(), 1500);
            } else {
                showPasswordError(data.message);
            }
        })
        .catch(error => {
            showPasswordError('Error changing password');
            console.error('Error:', error);
        });
    }

    function openAddPetModal() {
        document.getElementById('petIdInput').value = '';
        document.getElementById('petModalTitle').textContent = 'Add New Pet';
        document.getElementById('editPetForm').reset();
        document.getElementById('petPhotoPreview').src = '/Customer/img/default-pet.png';
        document.getElementById('addPetOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function openEditPetModal(petId) {
        // Fetch pet data from server
        fetch(`/Customer/Home/GetPetById?petId=${encodeURIComponent(petId)}`, {
            method: 'GET'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const pet = data.data;
                
                // Populate form fields with pet data
                document.getElementById('petIdInput').value = pet.petId;
                document.getElementById('petName').value = pet.name || '';
                document.getElementById('petAge').value = pet.age || '';
                document.getElementById('petType').value = pet.type || '';
                document.getElementById('petBreed').value = pet.breed || '';
                document.getElementById('petRemark').value = pet.remark || '';
                
                // Set photo preview
                if (pet.photo) {
                    document.getElementById('petPhotoPreview').src = pet.photo;
                } else {
                    document.getElementById('petPhotoPreview').src = '/Customer/img/default-pet.png';
                }
                
                // Update modal title
                document.getElementById('petModalTitle').textContent = 'Edit Pet';
                
                // Show modal
                document.getElementById('addPetOverlay').classList.add('show');
                document.body.style.overflow = 'hidden';
            } else {
                showPetError(data.message || 'Failed to load pet data');
            }
        })
        .catch(error => {
            showPetError('Error loading pet data');
            console.error('Error:', error);
        });
    }

    function closeAddPetModal() {
        document.getElementById('addPetOverlay').classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    function submitPetForm(event) {
        event.preventDefault();
    
        const petId = document.getElementById('petIdInput').value;
        const formData = new FormData(document.getElementById('editPetForm'));
        const url = petId ? '/Customer/Home/UpdatePet' : '/Customer/Home/AddPet';
    
        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPetSuccess(petId ? 'Pet updated successfully!' : 'Pet added successfully!');
                setTimeout(() => {
                    closeAddPetModal();
                    location.reload();
                }, 1500);
            } else {
                showPetError(data.message);
            }
        })
        .catch(error => {
            showPetError('Error saving pet');
            console.error('Error:', error);
        });
    }

    function deletePet(petId, petName) {
        if (!confirm(`Are you sure you want to delete ${petName}?`)) {
            return;
        }

        // ✅ Use FormData instead of JSON
        const formData = new FormData();
        formData.append('petId', petId);

        fetch('/Customer/Home/DeletePet', {
            method: 'POST',
            body: formData  // ✅ Send as form data, not JSON
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Pet deleted successfully!');
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Error deleting pet');
            console.error('Error:', error);
        });
    }

    function openImageEditor() {
        const photoPreview = document.getElementById('photoPreview');
        imageEditorData.originalSrc = photoPreview.src;
        imageEditorData.targetElement = photoPreview;
        imageEditorData.rotation = 0;
        imageEditorData.scale = 1;
    
        document.getElementById('editorImage').src = imageEditorData.originalSrc;
        document.getElementById('imageEditorOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeImageEditor() {
        document.getElementById('imageEditorOverlay').classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    function rotateImage(angle) {
        imageEditorData.rotation += angle;
        updateImageTransform();
    }

    function zoomImage(scale) {
        imageEditorData.scale *= scale;
        if (imageEditorData.scale < 0.5) imageEditorData.scale = 0.5;
        if (imageEditorData.scale > 3) imageEditorData.scale = 3;
        updateImageTransform();
    }

    function resetImage() {
        imageEditorData.rotation = 0;
        imageEditorData.scale = 1;
        updateImageTransform();
    }

    function updateImageTransform() {
        const editorImage = document.getElementById('editorImage');
        editorImage.style.transform = `rotate(${imageEditorData.rotation}deg) scale(${imageEditorData.scale})`;
        editorImage.style.transition = 'transform 0.3s ease';
    }

    function confirmImageEdit() {
        const editorImage = document.getElementById('editorImage');
        const canvas = document.createElement('canvas');
    
        canvas.width = 300;
        canvas.height = 300;
    
        const ctx = canvas.getContext('2d');
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate((imageEditorData.rotation * Math.PI) / 180);
        ctx.scale(imageEditorData.scale, imageEditorData.scale);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);
    
        const img = new Image();
        img.onload = function() {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const editedImageSrc = canvas.toDataURL('image/jpeg', 0.9);
        
            if (imageEditorData.targetElement) {
                imageEditorData.targetElement.src = editedImageSrc;
            }
        
            closeImageEditor();
            showSuccess('Photo edited successfully!');
        };
        img.src = imageEditorData.originalSrc;
    }

    function previewPhoto(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreview = document.getElementById('photoPreview');
                photoPreview.src = e.target.result;
                showSuccess('Photo selected!');
            };
            reader.readAsDataURL(file);
        }
    }

    function previewPetPhoto(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('petPhotoPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.innerHTML = '<i class="fa fa-check-circle"></i> ' + message + '<button type="button" class="close" onclick="this.parentElement.style.display=\'none\';" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
        successDiv.style.display = 'block';
        setTimeout(() => { successDiv.style.display = 'none'; }, 5000);
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }

    function showPasswordSuccess(message) {
        const successDiv = document.getElementById('passwordSuccessMessage');
        successDiv.innerHTML = '<i class="fa fa-check-circle"></i> ' + message + '<button type="button" class="close" onclick="this.parentElement.style.display=\'none\';" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
        successDiv.style.display = 'block';
        setTimeout(() => { successDiv.style.display = 'none'; }, 5000);
    }

    function showPasswordError(message) {
        const errorDiv = document.getElementById('passwordErrorMessage');
        const errorText = document.getElementById('passwordErrorText');
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }

    function showPetSuccess(message) {
        const successDiv = document.getElementById('petSuccessMessage');
        const successText = document.getElementById('petSuccessText');
        successText.textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => { successDiv.style.display = 'none'; }, 5000);
    }

    function showPetError(message) {
        const errorDiv = document.getElementById('petErrorMessage');
        const errorText = document.getElementById('petErrorText');
        errorText.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        var profileOverlay = document.getElementById('editProfileOverlay');
        if (profileOverlay) {
            profileOverlay.addEventListener('click', function(event) {
                if (event.target === profileOverlay) {
                    closeEditModal();
                }
            });
        }

        var petOverlay = document.getElementById('addPetOverlay');
        if (petOverlay) {
            petOverlay.addEventListener('click', function(event) {
                if (event.target === petOverlay) {
                    closeAddPetModal();
                }
            });
        }

        var imageEditorOverlay = document.getElementById('imageEditorOverlay');
        if (imageEditorOverlay) {
            imageEditorOverlay.addEventListener('click', function(event) {
                if (event.target === imageEditorOverlay) {
                    closeImageEditor();
                }
            });
        }
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeEditModal();
            closeAddPetModal();
            closeImageEditor();
        }
    });

        function redirectAndScroll(event) {
        event.preventDefault();

        // Navigate to the Index page
        window.location.href = '/Customer/Home/Index';

        // After a short delay, scroll to the redeem gift section
        setTimeout(() => {
            const redeemSection = document.querySelector('section:has(> .container > .row > .col-lg-7:has(.section_title:has(h3:contains("🎁"))))');

            if (redeemSection) {
                redeemSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // Fallback: scroll by searching for the text
                const sections = document.querySelectorAll('section');
                for (let section of sections) {
                    if (section.textContent.includes('🎁 Redeem Gift')) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        break;
                    }
                }
            }
        }, 500);
    }
</script>



