@model PetGroomingAppointmentSystem.Areas.Customer.ViewModels.HomeViewModel

@{
    ViewData["Title"] = "Home";
}

<!-- Login Required Modal with Better Styling -->
<div class="modal fade" id="loginRequiredModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true" style="z-index: 9999;">
    <div class="modal-dialog modal-dialog-centered" role="document" style="z-index: 10000;">
        <div class="modal-content" style="border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); z-index: 10001;">
            <div class="modal-header border-0" style="background: #f8f9fa; border-radius: 12px 12px 0 0;">
                <h5 class="modal-title" id="loginModalLabel" style="font-weight: 700; color: #333;">Login Required</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="cursor: pointer;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center py-5" style="padding: 40px 30px !important;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="1.5" style="margin-bottom: 20px;">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <h4 class="mb-3" style="font-weight: 700; color: #333; font-size: 20px;">Login Required</h4>
                <p class="text-muted mb-4" style="font-size: 15px; line-height: 1.6;">Please login first to book an appointment for your pet.</p>
            </div>
            <div class="modal-footer border-0" style="background: #f8f9fa; border-radius: 0 0 12px 12px; gap: 10px;">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal" style="padding: 10px 25px; cursor: pointer; font-weight: 500;">Cancel</button>
                <a href="/Customer/Auth/Login" class="btn btn-primary" style="padding: 10px 25px; background-color: #ff6b35; border-color: #ff6b35; cursor: pointer; font-weight: 500;">Go to Login</a>
            </div>
        </div>
    </div>
</div>

<!-- Modal Backdrop Fix -->
<style>
    .modal-backdrop {
        z-index: 9998 !important;
    }
    
    .modal.fade.show {
        z-index: 9999 !important;
    }
    
    .modal.fade.show .modal-dialog {
        z-index: 10000 !important;
    }
    
    .modal.fade.show .modal-content {
        z-index: 10001 !important;
    }
    
    /* Ensure buttons are clickable */
    .modal-footer .btn {
        position: relative;
        z-index: 10002 !important;
        pointer-events: auto !important;
    }
</style>

<!-- slider_area_start -->
<div class="slider_area">
    <div class="single_slider slider_bg_1 d-flex align-items-center">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-5 col-md-6">
                    <div class="slider_text">
                        <h3 class="wow fadeInUp" data-wow-delay="0.2s">Your Pets' <br> <span>Well-being</span></h3>
                        <p class="wow fadeInUp" data-wow-delay="0.4s">Easy grooming appointments with gentle, reliable care for every furry companion.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="dog_thumb d-none d-lg-block wow slideInRight" data-wow-delay="0.3s">
            <img src="~/Customer/img/banner/dog.png" alt="Dog grooming" loading="lazy" decoding="async">
        </div>
    </div>
</div>
<!-- slider_area_end -->
<!-- services_price_area_start -->
<section class="services_price_area py-5">
    <div class="container">
        <div class="row justify-content-center ">
            <div class="col-lg-6 col-md-10">
                <div class="section_title text-center mb-95 wow fadeInUp" data-wow-delay="0.2s">
                    <h3>Our Services & <br> Price List</h3>
                </div>
            </div>
        </div>
        <div class="text-center">
            <img src="~/Customer/img/about/price_list.png" alt="Price list for pet grooming services" class="img-fluid wow zoomIn" data-wow-delay="0.3s" loading="lazy" decoding="async" style="max-width:1100px;">
        </div>
    </div>
</section>
<!-- services_price_area_end -->
<!-- dog service_area_start -->
<section class="service_area py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-md-10">
                <div class="section_title text-center mb-95 wow fadeInUp" data-wow-delay="0.2s">
                    <h3>üêæ Services for dog</h3>
                </div>
            </div>
        </div>
        <div class="owl-carousel service-carousel dog-carousel">
            @foreach (var s in Model.DogServices)
            {
                <div class="single_service wow fadeInUp">
                    <div class="service_thumb d-flex align-items-center justify-content-center">
                        <img src="~/Customer/img/service/pet_icon.png" alt="@s.Name icon">
                    </div>
                    <div class="service_content text-center">
                        <h3>@s.Name</h3>
                        <p>@s.Description</p>
                        <a asp-controller="Home" asp-action="Appointment" 
                           asp-route-petType="dog" 
                           asp-route-serviceId="@s.ServiceId"
                           asp-route-serviceName="@Uri.EscapeDataString(s.Name)"
                           asp-route-description="@Uri.EscapeDataString(s.Description ?? "")"
                           asp-route-price="@s.Price"
                           asp-route-duration="@s.DurationTime"
                           class="boxed-btn4">
                            Book Now
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</section>
<!-- dog service_area_end -->
<!-- cat_service_area_start -->
<section class="service_area py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-md-10">
                <div class="section_title text-center mb-95 wow fadeInUp" data-wow-delay="0.2s">
                    <h3>üêà Services for cat</h3>
                </div>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="owl-carousel service-carousel cat-carousel w-100">
                @foreach (var s in Model.CatServices)
                {
                    <div class="single_service wow fadeInUp">
                        <div class="service_thumb d-flex align-items-center justify-content-center">
                            <img src="~/Customer/img/service/pet_icon.png" alt="@s.Name icon">
                        </div>
                        <div class="service_content text-center">
                            <h3>@s.Name</h3>
                            <p>@s.Description</p>
                            <a asp-controller="Home" asp-action="Appointment" 
                               asp-route-petType="cat"
                               asp-route-serviceId="@s.ServiceId"
                               asp-route-serviceName="@Uri.EscapeDataString(s.Name)"
                               asp-route-description="@Uri.EscapeDataString(s.Description ?? "")"
                               asp-route-price="@s.Price"
                               asp-route-duration="@s.DurationTime"
                               class="boxed-btn4">
                                Book Now
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</section>
<!-- cat_service_area_end -->
<!-- redeem_gift_area_start -->
<section class="service_area py-5" id="redeem_gift_area_start">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-md-10">
                <div class="section_title text-center mb-95 wow fadeInUp" data-wow-delay="0.2s">
                    <h3>üéÅ Redeem Gift </h3>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="owl-carousel service-carousel gift-carousel w-100">

                @foreach (var gift in Model.RedeemGifts)
                {
                    <div class="single_service wow fadeInUp" data-wow-delay="0.1s">
                        <div class="service_thumb d-flex align-items-center justify-content-center">
                            <img src="@gift.Photo" alt="@gift.Name icon">
                        </div>
                        <div class="service_content text-center">
                            <h3>@gift.Name</h3>
                            <p>Loyalty Point Cost: @gift.LoyaltyPointCost pts</p>

                            <button class="boxed-btn4 redeem-btn"
                                    data-gift-id="@gift.GiftId"
                                    data-gift-name="@gift.Name"
                                    data-cost="@gift.LoyaltyPointCost"
                                    data-maxqty="@gift.Quantity"
                                    data-userpoints="@Model.CustomerLoyaltyPoints">
                                Redeem Gift
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</section>
<!-- redeem_gift_area_end -->
<!-- Popup -->
<div id="redeemPopup" class="popup-container" style="display:none;">
    <div class="popup-box">
        <h3 id="popupGiftName"></h3>
        <p>Cost per item: <span id="popupGiftCost"></span> pts</p>
        <p>Your points: <span id="popupUserPoints"></span></p>
        <p>Available quantity: <span id="popupMaxQty"></span></p>

        <label>Quantity:</label>
        <input id="popupQty" type="number" min="1" style="width:80px; text-align:center;">

        <div class="button-row">
            <button id="confirmBtn" class="boxed-btn4">Confirm</button>
            <button id="cancelBtn" class="boxed-btn4">Cancel</button>
        </div>

    </div>
</div>

<!-- contact_anipat_start -->
<section class="contact_anipat anipat_bg_1 py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="contact_text text-center wow fadeInUp" data-wow-delay="0.2s">
                    <div class="section_title text-center">
                        <h3>Why go with Us?</h3>
                        <p>Because we know that even the best technology is only as good as the people behind it. 24/7 tech support.</p>
                    </div>
                    <div class="contact_btn d-flex align-items-center justify-content-center mt-4">
                        <a href="https://wa.me/601160628990" target="_blank" rel="noopener noreferrer" class="boxed-btn4">
                            <i class="fa fa-whatsapp"></i> Contact Us: +6011 4589 2563
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- contact_anipat_end -->
@section Scripts {
    <script>
        $(document).ready(function () {
            new WOW().init();

            // ? read counts from model (rendered as numbers)
            var dogCount = @Model.DogServices.Count;
            var catCount = @Model.CatServices.Count;
            var giftCount = @Model.RedeemGifts.Count;

            // Generic function for initializing any carousel
            function initCarousel(selector, count) {
                $(selector).owlCarousel({
                    items: 3,
                    loop: count > 3,        // loop only when more than 3
                    autoplay: count > 3,    // autoplay only when more than 3
                    autoplayTimeout: 4000,
                    autoplayHoverPause: true,
                    margin: 18,
                    responsive: {
                        0: { items: 1 },
                        768: { items: 2 },
                        1200: { items: 3 }
                    }
                });
            }

            // Initialize carousels with model count
            initCarousel(".dog-carousel", dogCount);
            initCarousel(".cat-carousel", catCount);
            initCarousel(".gift-carousel", giftCount);

            // Equal height adjustment
            function setCarouselHeights() {
                $(".service-carousel").each(function () {
                    var maxHeight = 0;
                    $(this).find(".single_service").each(function () {
                        var height = $(this).height();
                        if (height > maxHeight) maxHeight = height;
                    });
                    $(this).find(".single_service").height(maxHeight);
                });
            }

            setCarouselHeights();
            $(window).on('resize', setCarouselHeights);
        });

        // ============ BOOK NOW LOGIN CHECK ============
        function handleBookNow(event, element) {
            event.preventDefault();
            event.stopPropagation();
            
            // Show loading state
            $(element).prop('disabled', true);
            const originalText = $(element).text();
            $(element).text('Checking...');
            
            // Fetch user login status from server
            fetch('/Customer/Home/CheckUserStatus')
                .then(response => response.json())
                .then(data => {
                    $(element).prop('disabled', false);
                    $(element).text(originalText);
                    
                    if (!data.isLoggedIn) {
                        // User is NOT logged in - show modal
                        const modal = new bootstrap.Modal(document.getElementById('loginRequiredModal'));
                        modal.show();
                    } else {
                        // User IS logged in - proceed to appointment booking
                        proceedToBooking(element);
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    $(element).prop('disabled', false);
                    $(element).text(originalText);
                    // On error, show login modal to be safe
                    const modal = new bootstrap.Modal(document.getElementById('loginRequiredModal'));
                    modal.show();
                });
            
            return false;
        }

        function proceedToBooking(element) {
            const petType = element.getAttribute('data-pet-type');
            const serviceId = element.getAttribute('data-service-id');
            const serviceName = element.getAttribute('data-service-name');
            const description = element.getAttribute('data-description');
            const price = element.getAttribute('data-price');
            const duration = element.getAttribute('data-duration');
            
            // Build the URL with all parameters
            const url = `/Customer/Home/Appointment?petType=${petType}&serviceId=${serviceId}&serviceName=${encodeURIComponent(serviceName)}&description=${encodeURIComponent(description)}&price=${price}&duration=${duration}`;
            
            window.location.href = url;
        }

        // Popup / Redeem Logic
        let redeemData = { giftId: null, giftName: "", cost: 0, maxQty: 0, userPoints: 0 };

        function openRedeemPopup(data) {
            redeemData = data;
            $("#popupGiftName").text(data.giftName);
            $("#popupGiftCost").text(data.cost);
            $("#popupUserPoints").text(data.userPoints);
            $("#popupMaxQty").text(data.maxQty);

            const qtyInput = $("#popupQty");
            qtyInput.val(1);
            qtyInput.attr("max", data.maxQty);

            $("#redeemPopup").fadeIn();
        }

        $(".redeem-btn").click(function () {
            let data = {
                giftId: $(this).data("gift-id"),
                giftName: $(this).data("gift-name"),
                cost: parseInt($(this).data("cost")),
                maxQty: parseInt($(this).data("maxqty")),
                userPoints: parseInt($(this).data("userpoints"))
            };
            openRedeemPopup(data);
        });

        $("#cancelBtn").click(() => $("#redeemPopup").fadeOut());

        $("#confirmBtn").click(() => {
            const qty = parseInt($("#popupQty").val());
            const totalCost = qty * redeemData.cost;

            if (qty <= 0) {
                alert("Quantity must be at least 1!");
                return;
            }

            if (qty > redeemData.maxQty) {
                alert("Exceeds available gift stock!");
                return;
            }

            if (totalCost > redeemData.userPoints) {
                alert("Not enough loyalty points!");
                return;
            }

            // AJAX request to confirm redemption
            $.post("/Customer/Home/RedeemGiftConfirm", { giftId: redeemData.giftId, quantity: qty })
                .done(response => {
                    alert(response.message || "Gift redeemed successfully!");
                    location.reload(); // reload page to update points and gift stock
                })
                .fail(xhr => alert(xhr.responseText || "Error redeeming gift!"));

            $("#redeemPopup").fadeOut();
        });

        // Optional: dynamically update total cost when quantity changes
        $("#popupQty").on("input", function () {
            const qty = parseInt($(this).val());
            const totalCost = qty * redeemData.cost;
            if (totalCost > redeemData.userPoints) {
                $(this).val(Math.floor(redeemData.userPoints / redeemData.cost));
                alert("Adjusted quantity to match available loyalty points.");
            }
        });
    </script>
}
