<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>

    <!-- <link rel="manifest" href="site.webmanifest"> -->
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.png">

    <!-- Dark Mode CSS (Shared across all pages) -->
    <link rel="stylesheet" href="~/css/dark-mode.css">

    <!-- CSS here -->
    <link rel="stylesheet" href="~/Customer/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/Customer/css/owl.carousel.min.css">
    <link rel="stylesheet" href="~/Customer/css/magnific-popup.css">
    <link rel="stylesheet" href="~/Customer/css/font-awesome.min.css">
    <link rel="stylesheet" href="~/Customer/css/themify-icons.css">
    <link rel="stylesheet" href="~/Customer/css/nice-select.css">
    <link rel="stylesheet" href="~/Customer/css/flaticon.css">
    <link rel="stylesheet" href="~/Customer/css/gijgo.css">
    <link rel="stylesheet" href="~/Customer/css/animate.css">
    <link rel="stylesheet" href="~/Customer/css/slicknav.css">
    <link rel="stylesheet" href="~/Customer/css/style.css">
    <link rel="stylesheet" href="~/Customer/css/profile.css">
    <link rel="stylesheet" href="~/Customer/css/edit-profile-modal.css">
    <link rel="stylesheet" href="~/Customer/css/chatbot.css">
    <link rel="stylesheet" href="~/Customer/css/redeemGift.css">

</head>
<body>

    <!-- Header -->
    @await Html.PartialAsync("_Header")

    <!-- Page content -->
    <main role="main">
        @RenderBody()
    </main>

    <!-- Chatbot -->
    @await Html.PartialAsync("_ChatBot")

    <!-- Footer -->
    @await Html.PartialAsync("_Footer")

    <!-- JS files - Load in correct order -->
    <script src="~/Customer/js/vendor/modernizr-3.5.0.min.js"></script>
    <script src="~/Customer/js/vendor/jquery-1.12.4.min.js"></script>
    <script src="~/Customer/js/popper.min.js"></script>
    <script src="~/Customer/js/bootstrap.min.js"></script>
    <script src="~/Customer/js/owl.carousel.min.js"></script>
    <script src="~/Customer/js/isotope.pkgd.min.js"></script>
    <script src="~/Customer/js/ajax-form.js"></script>
    <script src="~/Customer/js/waypoints.min.js"></script>
    <script src="~/Customer/js/jquery.counterup.min.js"></script>
    <script src="~/Customer/js/imagesloaded.pkgd.min.js"></script>
    <script src="~/Customer/js/scrollIt.js"></script>
    <script src="~/Customer/js/jquery.scrollUp.min.js"></script>
    <script src="~/Customer/js/wow.min.js"></script>
    <script src="~/Customer/js/nice-select.min.js"></script>
    <script src="~/Customer/js/jquery.slicknav.min.js"></script>
    <script src="~/Customer/js/jquery.magnific-popup.min.js"></script>
    <script src="~/Customer/js/plugins.js"></script>
    <script src="~/Customer/js/gijgo.min.js"></script>
    <script src="~/Customer/js/jquery.ajaxchimp.min.js"></script>
    <script src="~/Customer/js/main.js"></script>
    <script src="~/Customer/js/chatbot.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>


    <!-- Dark Mode Script (Shared across all pages) -->
    <script src="~/js/dark-mode.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const chatbotContainer = document.getElementById("chatbot-container");
            const messagesContainer = document.getElementById("chatbot-messages");
            const toggleBtn = document.getElementById("chatbot-toggle");
            const header = document.getElementById("chatbot-header");
            const input = document.getElementById("chatbot-input");
            const sendBtn = document.getElementById("chatbot-send");

            /* ---------------------------------------
               SIGNALR CONNECTION
            ----------------------------------------*/
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .build();

            connection.on("ReceiveMessage", function (sender, message) {

                // Remove loading indicator if exists
                const loading = document.querySelector(".loading-indicator");
                if (loading) loading.parentElement.remove();

                // Only display bot messages from SignalR
                if (sender === "Bot") {
                    const msg = document.createElement("div");
                    msg.className = "message bot-message";
                    msg.innerHTML = `<p>${message}</p>`;
                    messagesContainer.appendChild(msg);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    saveChat();
                }
            });

            connection.start()
                .catch(err => console.error("SignalR connection error:", err));

            /* ---------------------------------------
               RESTORE STATE
            ----------------------------------------*/
            const savedMessages = sessionStorage.getItem("chatbot_messages");
            if (savedMessages) {
                messagesContainer.innerHTML = savedMessages;
            }

            const minimizedState = sessionStorage.getItem("chatbot_minimized");
            if (minimizedState === "true") {
                chatbotContainer.classList.add("minimized");
            } else {
                chatbotContainer.classList.add("minimized");
                sessionStorage.setItem("chatbot_minimized", true);
            }

            toggleBtn.textContent = "+";

            /* ---------------------------------------
               TOGGLE CHAT
            ----------------------------------------*/
            function toggleChat() {
                const isMin = chatbotContainer.classList.toggle("minimized");
                toggleBtn.textContent = isMin ? "+" : "−";
                sessionStorage.setItem("chatbot_minimized", isMin);
            }

            toggleBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                toggleChat();
            });

            header.addEventListener("click", toggleChat);

            /* ---------------------------------------
               SAVE CHAT
            ----------------------------------------*/
            function saveChat() {
                sessionStorage.setItem("chatbot_messages", messagesContainer.innerHTML);
            }

            /* ---------------------------------------
               SEND MESSAGE (SignalR)
            ----------------------------------------*/
            function sendMessage(message) {
                if (!message) return;

                // USER MESSAGE (UI)
                const userMsg = document.createElement("div");
                userMsg.className = "message user-message";
                userMsg.innerHTML = `<p>${message}</p>`;
                messagesContainer.appendChild(userMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                saveChat();

                input.value = "";

                // LOADING INDICATOR
                const loading = document.createElement("div");
                loading.className = "message bot-message";
                loading.innerHTML = `
                    <div class="loading-indicator">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>`;
                messagesContainer.appendChild(loading);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // SEND TO SIGNALR HUB
                connection.invoke("SendMessage", message)
                    .catch(err => {
                        console.error(err);
                        loading.remove();

                        const errorMsg = document.createElement("div");
                        errorMsg.className = "message bot-message";
                        errorMsg.innerHTML = `<p>Sorry, something went wrong.</p>`;
                        messagesContainer.appendChild(errorMsg);
                        saveChat();
                    });
            }

            /* ---------------------------------------
               INPUT EVENTS
            ----------------------------------------*/
            sendBtn.addEventListener("click", () => {
                sendMessage(input.value.trim());
            });

            input.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    sendMessage(input.value.trim());
                }
            });

            /* ---------------------------------------
               FAQ TOPIC CLICK (event delegation)
            ----------------------------------------*/
            const topicsContainer = document.querySelector(".greeting-topics");
            if (topicsContainer) {
                topicsContainer.addEventListener("click", (e) => {
                    const topic = e.target.closest(".topic-item");
                    if (!topic) return;

                    sendMessage(topic.dataset.topic);
                });
            }

        });
    </script>



    @RenderSection("Scripts", required: false)

</body>
</html>
