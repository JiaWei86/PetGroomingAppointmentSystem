<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>

    <!-- <link rel="manifest" href="site.webmanifest"> -->
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.png">

    <!-- Dark Mode CSS (Shared across all pages) -->
    <link rel="stylesheet" href="~/css/dark-mode.css">

    <!-- CSS here -->
    <link rel="stylesheet" href="~/Customer/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/Customer/css/owl.carousel.min.css">
    <link rel="stylesheet" href="~/Customer/css/magnific-popup.css">
    <link rel="stylesheet" href="~/Customer/css/font-awesome.min.css">
    <link rel="stylesheet" href="~/Customer/css/themify-icons.css">
    <link rel="stylesheet" href="~/Customer/css/nice-select.css">
    <link rel="stylesheet" href="~/Customer/css/flaticon.css">
    <link rel="stylesheet" href="~/Customer/css/gijgo.css">
    <link rel="stylesheet" href="~/Customer/css/animate.css">
    <link rel="stylesheet" href="~/Customer/css/slicknav.css">
    <link rel="stylesheet" href="~/Customer/css/style.css">
    <link rel="stylesheet" href="~/Customer/css/profile.css">
    <link rel="stylesheet" href="~/Customer/css/edit-profile-modal.css">
    <link rel="stylesheet" href="~/Customer/css/chatbot.css">
    <link rel="stylesheet" href="~/Customer/css/redeemGift.css">

</head>
<body>

    <!-- Header -->
    @await Html.PartialAsync("_Header")

    <!-- Page content -->
    <main role="main">
        @RenderBody()
    </main>

  @*   <div id="loyaltyToast" style="position: fixed; top: 20px; right: 20px; background-color: #ff9800; color: white; padding: 10px 18px; border-radius: 6px; box-shadow: 0 3px 8px rgba(0,0,0,0.15); z-index: 10000; display: none; font-size: 14px; animation: slideInRight 0.3s ease-out;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 1.1rem;">🎁</span>
            <span id="loyaltyToastMessage"></span>
        </div>
    </div> *@

    <!-- Place this somewhere near the body tag, hidden by default -->
    @* <div id="loyaltyContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div> *@

    <!-- Chatbot -->
    @await Html.PartialAsync("_ChatBot")

    <!-- Footer -->
    @await Html.PartialAsync("_Footer")

    <!-- JS files - Load in correct order -->
    <script src="~/Customer/js/vendor/modernizr-3.5.0.min.js"></script>
    <script src="~/Customer/js/vendor/jquery-1.12.4.min.js"></script>
    <script src="~/Customer/js/popper.min.js"></script>
    <script src="~/Customer/js/bootstrap.min.js"></script>
    <script src="~/Customer/js/owl.carousel.min.js"></script>
    <script src="~/Customer/js/isotope.pkgd.min.js"></script>
    <script src="~/Customer/js/ajax-form.js"></script>
    <script src="~/Customer/js/waypoints.min.js"></script>
    <script src="~/Customer/js/jquery.counterup.min.js"></script>
    <script src="~/Customer/js/imagesloaded.pkgd.min.js"></script>
    <script src="~/Customer/js/scrollIt.js"></script>
    <script src="~/Customer/js/jquery.scrollUp.min.js"></script>
    <script src="~/Customer/js/wow.min.js"></script>
    <script src="~/Customer/js/nice-select.min.js"></script>
    <script src="~/Customer/js/jquery.slicknav.min.js"></script>
    <script src="~/Customer/js/jquery.magnific-popup.min.js"></script>
    <script src="~/Customer/js/plugins.js"></script>
    <script src="~/Customer/js/gijgo.min.js"></script>
    <script src="~/Customer/js/jquery.ajaxchimp.min.js"></script>
    <script src="~/Customer/js/main.js"></script>
    <script src="~/Customer/js/chatbot.js"></script>

    <!-- Dark Mode Script (Shared across all pages) -->
    <script src="~/js/dark-mode.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const chatbotContainer = document.getElementById("chatbot-container");
            const messagesContainer = document.getElementById("chatbot-messages");
            const toggleBtn = document.getElementById("chatbot-toggle");
            const header = document.getElementById("chatbot-header");
            const input = document.getElementById("chatbot-input");
            const sendBtn = document.getElementById("chatbot-send");

            /* ---------------------------------------
                RESTORE STATE
            ----------------------------------------*/

            // Restore chat messages
            const savedMessages = sessionStorage.getItem("chatbot_messages");
            if (savedMessages) {
                messagesContainer.innerHTML = savedMessages;
            }

            // By default, start minimized with "+" button
            const minimizedState = sessionStorage.getItem("chatbot_minimized");
            if (minimizedState === "true") {
                chatbotContainer.classList.add("minimized");
            } else {
                chatbotContainer.classList.add("minimized"); // force minimized at first visit
                sessionStorage.setItem("chatbot_minimized", true);
            }

            toggleBtn.textContent = "+";

            /* ---------------------------------------
                TOGGLE CHAT
            ----------------------------------------*/
            function toggleChat() {
                const isMin = chatbotContainer.classList.toggle("minimized");
                toggleBtn.textContent = isMin ? "+" : "−";
                sessionStorage.setItem("chatbot_minimized", isMin);
            }

            toggleBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                toggleChat();
            });

            header.addEventListener("click", toggleChat);

            /* ---------------------------------------
                SAVE CHAT MESSAGES
            ----------------------------------------*/
            function saveChat() {
                sessionStorage.setItem("chatbot_messages", messagesContainer.innerHTML);
            }

            /* ---------------------------------------
                SEND MESSAGE
            ----------------------------------------*/
            async function sendMessage(message) {
                if (!message) return;

                // USER MESSAGE
                const userMsg = document.createElement("div");
                userMsg.className = "message user-message";
                userMsg.innerHTML = `<p>${message}</p>`;
                messagesContainer.appendChild(userMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                saveChat();

                input.value = "";

                // LOADING
                const loading = document.createElement("div");
                loading.className = "message bot-message";
                loading.innerHTML = `
                    <div class="loading-indicator">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>`;
                messagesContainer.appendChild(loading);

                try {
                    const response = await fetch("/api/chatbot/message", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message })
                    });

                    const data = await response.json();

                    loading.remove();

                    const botMsg = document.createElement("div");
                    botMsg.className = "message bot-message";
                    botMsg.innerHTML = `<p>${data.response}</p>`;
                    messagesContainer.appendChild(botMsg);

                    saveChat();

                } catch (err) {
                    loading.remove();

                    const errorMsg = document.createElement("div");
                    errorMsg.className = "message bot-message";
                    errorMsg.innerHTML = `<p>Sorry, something went wrong.</p>`;
                    messagesContainer.appendChild(errorMsg);

                    saveChat();
                }
            }

            /* ---------------------------------------
                INPUT + BUTTON EVENTS
            ----------------------------------------*/
            sendBtn.addEventListener("click", () => sendMessage(input.value.trim()));

            input.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    sendMessage(input.value.trim());
                }
            });

            /* ---------------------------------------
                TOPIC CLICK EVENTS
            ----------------------------------------*/
            document.querySelectorAll(".topic-item").forEach(topic => {
                topic.addEventListener("click", () => {
                    sendMessage(topic.dataset.topic);
                });
            });


        });


    </script>

    @RenderSection("Scripts", required: false)

</body>
</html>
