<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>

    <!-- <link rel="manifest" href="site.webmanifest"> -->
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.png">

    <!-- CSS here -->
    <link rel="stylesheet" href="~/Customer/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/Customer/css/owl.carousel.min.css">
    <link rel="stylesheet" href="~/Customer/css/magnific-popup.css">
    <link rel="stylesheet" href="~/Customer/css/font-awesome.min.css">
    <link rel="stylesheet" href="~/Customer/css/themify-icons.css">
    <link rel="stylesheet" href="~/Customer/css/nice-select.css">
    <link rel="stylesheet" href="~/Customer/css/flaticon.css">
    <link rel="stylesheet" href="~/Customer/css/gijgo.css">
    <link rel="stylesheet" href="~/Customer/css/animate.css">
    <link rel="stylesheet" href="~/Customer/css/slicknav.css">
    <link rel="stylesheet" href="~/Customer/css/style.css">
    <link rel="stylesheet" href="~/Customer/css/profile.css">
    <link rel="stylesheet" href="~/Customer/css/edit-profile-modal.css">
    <link rel="stylesheet" href="~/Customer/css/chatbot.css">

</head>
<body>
    <!-- Header -->
    @await Html.PartialAsync("_Header")

    <!-- Page content -->
    <main role="main">
        @RenderBody()
    </main>

    <!-- Chatbot -->
    @await Html.PartialAsync("_ChatBot")

    <!-- Footer -->
    @await Html.PartialAsync("_Footer")

    <!-- JS files - Load in correct order -->
    <script src="~/Customer/js/vendor/modernizr-3.5.0.min.js"></script>
    <script src="~/Customer/js/vendor/jquery-1.12.4.min.js"></script>
    <script src="~/Customer/js/popper.min.js"></script>
    <script src="~/Customer/js/bootstrap.min.js"></script>
    <script src="~/Customer/js/owl.carousel.min.js"></script>
    <script src="~/Customer/js/isotope.pkgd.min.js"></script>
    <script src="~/Customer/js/ajax-form.js"></script>
    <script src="~/Customer/js/waypoints.min.js"></script>
    <script src="~/Customer/js/jquery.counterup.min.js"></script>
    <script src="~/Customer/js/imagesloaded.pkgd.min.js"></script>
    <script src="~/Customer/js/scrollIt.js"></script>
    <script src="~/Customer/js/jquery.scrollUp.min.js"></script>
    <script src="~/Customer/js/wow.min.js"></script>
    <script src="~/Customer/js/nice-select.min.js"></script>
    <script src="~/Customer/js/jquery.slicknav.min.js"></script>
    <script src="~/Customer/js/jquery.magnific-popup.min.js"></script>
    <script src="~/Customer/js/plugins.js"></script>
    <script src="~/Customer/js/gijgo.min.js"></script>
    <script src="~/Customer/js/jquery.ajaxchimp.min.js"></script>
    <script src="~/Customer/js/main.js"></script>
    <script src="~/Customer/js/chatbot.js"></script>

    <script>
                 document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('chatbot-container');
            const toggleBtn = document.getElementById('chatbot-toggle');
            const header = document.getElementById('chatbot-header');
            const messages = document.getElementById('chatbot-messages');
            const input = document.getElementById('chatbot-input');
            const sendBtn = document.getElementById('chatbot-send');

            // Initialize minimized state
            let isMinimized = container.classList.contains('minimized');
            toggleBtn.textContent = isMinimized ? '+' : '−';

            // Toggle function
            function toggleChat() {
                isMinimized = !isMinimized;
                container.classList.toggle('minimized', isMinimized);
                toggleBtn.textContent = isMinimized ? '+' : '−';
            }

            toggleBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleChat(); });
            header.addEventListener('click', toggleChat);

            // Send message function
            async function sendMessage(message) {
                if (!message) return;

                // Add user message
                const userMsgDiv = document.createElement('div');
                userMsgDiv.className = 'message user-message';
                userMsgDiv.innerHTML = `<p>${message}</p>`;
                messages.appendChild(userMsgDiv);
                messages.scrollTop = messages.scrollHeight;

                // Clear input if using text field
                input.value = '';

                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot-message';
                loadingDiv.id = 'loading-indicator';
                loadingDiv.innerHTML = `
                    <div class="loading-indicator">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>`;
                messages.appendChild(loadingDiv);
                messages.scrollTop = messages.scrollHeight;

                try {
                    // Call your backend API
                    const response = await fetch('/api/chatbot/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });
                    const data = await response.json();

                    // Remove loading
                    loadingDiv.remove();

                    // Add bot response
                    const botMsgDiv = document.createElement('div');
                    botMsgDiv.className = 'message bot-message';
                    botMsgDiv.innerHTML = `<p>${data.response}</p>`;
                    messages.appendChild(botMsgDiv);
                    messages.scrollTop = messages.scrollHeight;

                } catch (err) {
                    console.error(err);
                    loadingDiv.remove();
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'message bot-message';
                    errorMsg.innerHTML = `<p>Sorry, something went wrong.</p>`;
                    messages.appendChild(errorMsg);
                }
            }

            // Input and send button events
            if (sendBtn) sendBtn.addEventListener('click', () => sendMessage(input.value.trim()));
            if (input) input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage(input.value.trim());
            });

            // ===== NEW: Topic click events =====
            const topics = document.querySelectorAll('.topic-item');
            topics.forEach(topic => {
                topic.addEventListener('click', () => {
                    const userQuestion = topic.dataset.topic;
                    sendMessage(userQuestion);
                });
            });
        });
    </script>


    @RenderSection("Scripts", required: false)

</body>
</html>
