@model PetGroomingAppointmentSystem.Models.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Administrator Dashboard";
    ViewData["ActivePage"] = "Dashboard";
}
@section Styles {
    <link rel="stylesheet" href="~/admin/css/dashboard.css" />
}
<div class="content-header">
    <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="breadcrumb">Welcome back, Admin! Here's what's happening today.</p>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card blue">
        <div class="stat-icon">
            <i class="material-icons">event_note</i>
        </div>
        <div class="stat-content">
            <p class="stat-title">Total Appointments</p>
            <div class="stat-value">
                @(Model?.TotalAppointments?.Count ?? 24)
                @if (Model?.TotalAppointments != null && Model.TotalAppointments.ChangePercentage != 0)
                {
                    <span class="change @(Model.TotalAppointments.ChangePercentage >= 0 ? "up" : "down")">
                        <i class="material-icons">@(Model.TotalAppointments.ChangePercentage >= 0 ? "trending_up" : "trending_down")</i> @Model.TotalAppointments.ChangePercentage.ToString("0.##")%
                    </span>
                }
            </div>
            <p class="stat-extra">This month's appointments</p>
        </div>
    </div>

    <div class="stat-card green">
        <div class="stat-icon">
            <i class="material-icons">person</i>
        </div>
        <div class="stat-content">
            <p class="stat-title">Total Groomers</p>
            <div class="stat-value">
                @(Model?.ActiveGroomers?.Count ?? 2)
            </div>
            <p class="stat-extra">Available to work</p>
        </div>
    </div>

    <div class="stat-card yellow">
        <div class="stat-icon">
            <i class="material-icons">contacts</i>
        </div>
        <div class="stat-content">
            <p class="stat-title">Total Customer</p>
            <div class="stat-value">
                @(Model?.PendingAppointments?.Count ?? 1)
            </div>
            <p class="stat-extra">Registered in system</p>
        </div>
    </div>


</div>

<div class="chart-and-info-grid">
    <div class="chart-panel">
        <div class="panel-header">
            <div>
                <h3 class="panel-title">Appointment Trend</h3>
                <p class="panel-subtitle-small">Track your booking patterns</p>
            </div>
            <div class="chart-options">
                <button class="btn-chart-option" onclick="DashboardChart.updateChart(event, 'month')">Month</button>
                <button class="btn-chart-option active" onclick="DashboardChart.updateChart(event, 'week')">Week</button>
                <button class="btn-chart-option" onclick="DashboardChart.updateChart(event, 'day')">Day</button>
            </div>
        </div>
        <canvas id="appointmentChart" style="max-height: 350px;"></canvas>
    </div>

    <div class="info-panel">
        <div class="loyalty-header" >
            <i class="material-icons loyalty-icon">card_giftcard</i>
        </div>
        <h3 class="panel-title">Loyalty Points</h3>
        <p class="stat-value-large">@(Model?.LoyaltyPoints?.AwardedThisWeek.ToString("N0") ?? "7,650")</p>
        <p class="panel-subtitle">Points Awarded This Week</p>
        <div class="loyalty-stats">
            <div class="loyalty-stat-item">
                <span class="loyalty-stat-label">Active Members</span> 
                <span class="loyalty-stat-value">@(Model?.LoyaltyPoints?.ActiveMembers.ToString("N0") ?? "156")</span>
            </div>
            <div class="loyalty-stat-item">
                <span class="loyalty-stat-label">Points Redeemed</span>
                <span class="loyalty-stat-value">@(Model?.LoyaltyPoints?.RedeemedThisWeek.ToString("N0") ?? "2,340")</span>
            </div>
        </div>
    </div>
</div>

<div class="calendar-section">
    <div class="calendar-container">
        <div class="calendar-header">
            <h2>Appointment Calendar</h2>
            <div class="calendar-nav">
                <button id="prevMonth" class="btn-nav">&laquo;</button>
                <span id="monthYear" class="month-year"></span>
                <button id="nextMonth" class="btn-nav">&raquo;</button>
            </div>
        </div>

        <div class="calendar-grid-wrapper">
            <div class="calendar-weekdays">
                <div class="calendar-day-header">SUN</div>
                <div class="calendar-day-header">MON</div>
                <div class="calendar-day-header">TUE</div>
                <div class="calendar-day-header">WED</div>
                <div class="calendar-day-header">THU</div>
                <div class="calendar-day-header">FRI</div>
                <div class="calendar-day-header">SAT</div>
            </div>

            <div id="calendar"></div>
        </div>
    </div>

    <div class="appointments-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="material-icons">event</i>
                <span>Appointments</span>
            </div>
            <span id="selectedDate" class="selected-date-badge">Today</span>
        </div>

        <div id="appointmentsList">
            <p class="no-appointments">No appointments scheduled</p>
        </div>
    </div>
</div>



<script>
        // ========================================
    // DASHBOARD DATA (Page-Specific)
    // ========================================

    // Dynamically inject data from the ViewModel.
    // If the model is null, it serializes empty objects/arrays to prevent script errors.
    window.dashboardChartData = @Html.Raw(Json.Serialize(Model?.ChartData ?? new PetGroomingAppointmentSystem.Models.ViewModels.ChartDataModel()));
    const appointmentData = @Html.Raw(Json.Serialize(Model?.AppointmentsForCalendar ?? new List<PetGroomingAppointmentSystem.Models.ViewModels.CalendarAppointmentModel>()));

    // Fallback data for local testing if the backend doesn't provide data.
    const fallbackChartData = {
         week: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], data: [12, 19, 15, 25, 22, 18, 20] },
         month: { labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'], data: [65, 78, 82, 95] },
         day: { labels: ['9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM'], data: [2, 4, 3, 5, 4, 6, 3, 2, 1] }
    };

    if (!window.dashboardChartData || Object.keys(window.dashboardChartData).length === 0) {
        window.dashboardChartData = fallbackChartData;
    }

    if (!appointmentData || appointmentData.length === 0) {
        // Add some static data if the dynamic list is empty
        appointmentData.push(
            { id: 1, date: new Date().toISOString().split('T')[0], time: "09:00", petName: "Buddy (Sample)", groomerName: "Anna Lee", serviceType: "Full Groom", status: "confirmed" },
            { id: 2, date: new Date().toISOString().split('T')[0], time: "10:30", petName: "Whiskers (Sample)", groomerName: "Mark Chen", serviceType: "Bath", status: "confirmed" },
            { id: 3, date: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], time: "14:00", petName: "Max (Sample)", groomerName: "Anna Lee", serviceType: "Nail Trim", status: "pending" }
        );
    }

    // ========================================
    // DASHBOARD CHART MODULE
    // ========================================
    const DashboardChart = (() => {
        let chart = null;
        let currentView = 'week';

        const init = (chartData) => {
            const ctx = document.getElementById('appointmentChart');
            if (!ctx) return;

            chart = new Chart(ctx, { 
                type: 'line',
                data: {
                    labels: chartData[currentView]?.labels || [],
                    datasets: [{ 
                        label: 'Appointments',
                        data: chartData[currentView]?.data || [],
                        borderColor: '#d97706',
                        backgroundColor: 'rgba(217, 119, 6, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#d97706',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#d97706',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        };

        const updateChart = (event, view) => {
            if (!chart || !window.dashboardChartData) return;

            currentView = view;
            const data = window.dashboardChartData[view];

            chart.data.labels = data?.labels || [];
            chart.data.datasets[0].data = data?.data || [];
            chart.update();

            document.querySelectorAll('.btn-chart-option').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) event.target.classList.add('active');
        };

        return { init, updateChart };
    })();

    // ========================================
    // DASHBOARD CALENDAR MODULE
    // ========================================
    const DashboardCalendar = (() => {
        let currentDate = new Date();
        let selectedDate = new Date();
        let appointments = [];

        const getLocalDateString = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const init = (appointmentData) => {
            appointments = appointmentData;
            renderCalendar();
            renderAppointments(getLocalDateString(selectedDate));

            document.getElementById('prevMonth')?.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonth')?.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
        };

        const renderCalendar = () => {
            const calendar = document.getElementById('calendar');
            const monthYear = document.getElementById('monthYear');
            if (!calendar || !monthYear) return;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthYear.textContent = new Date(year, month).toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const todayStr = getLocalDateString(new Date());
            const selectedStr = getLocalDateString(selectedDate);

            let calendarHTML = '';

            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = getLocalDateString(date);
                const hasAppointments = appointments.some(apt => apt.date === dateStr);
                const isToday = dateStr === todayStr;
                const isSelected = dateStr === selectedStr;

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                if (hasAppointments) classes += ' has-appointments';

                calendarHTML += `
                    <div class="${classes}" onclick="selectDate('${dateStr}')">
                        <span class="day-number">${day}</span>
                        ${hasAppointments ? '<span class="appointment-dot"></span>' : ''}
                    </div>
                `;
            }

            calendar.innerHTML = calendarHTML;
        };

        const renderAppointments = (dateStr) => {
            const appointmentsList = document.getElementById('appointmentsList');
            const selectedDateBadge = document.getElementById('selectedDate');
            if (!appointmentsList) return;

            const dateAppointments = appointments.filter(apt => apt.date === dateStr);

            if (selectedDateBadge) {
                const date = new Date(dateStr + 'T00:00:00');
                const todayStr = getLocalDateString(new Date());

                if (dateStr === todayStr) {
                    selectedDateBadge.textContent = 'Today';
                } else {
                    selectedDateBadge.textContent = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }

            if (dateAppointments.length === 0) {
                appointmentsList.innerHTML = '<p class="no-appointments">No appointments scheduled</p>';
                return;
            }

            appointmentsList.innerHTML = dateAppointments.map(apt => `
                <div class="appointment-item ${apt.status}">
                    <div class="appointment-time">${apt.time}</div>
                    <div class="appointment-details">
                        <div class="appointment-pet">${apt.petName}</div>
                        <div class="appointment-service">${apt.serviceType}</div>
                        <div class="appointment-groomer">with ${apt.groomerName}</div>
                    </div>
                    <span class="appointment-status ${apt.status}">${apt.status}</span>
                </div>
            `).join('');
        };

        const selectDate = (dateStr) => {
            selectedDate = new Date(dateStr + 'T00:00:00');
            renderCalendar();
            renderAppointments(dateStr);
        };

        return { init, selectDate };
    })();

    window.selectDate = (dateStr) => DashboardCalendar.selectDate(dateStr);

    // ========================================
    // INITIALIZE DASHBOARD
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        DashboardChart.init(window.dashboardChartData);
        DashboardCalendar.init(appointmentData);
    });

    // ========== ADD LOGOUT CONFIRMATION ==========
    // This script finds logout links for both Admin and Staff and adds a confirmation dialog.
    // It is best placed in a shared layout file, but adding it to the dashboard ensures it's loaded on login.
    document.addEventListener('DOMContentLoaded', function () {
        // Find links pointing to AdminLogout or StaffLogout
        const logoutLinks = document.querySelectorAll('a[href*="/Admin/Auth/AdminLogout"], a[href*="/Admin/Auth/StaffLogout"]');

        logoutLinks.forEach(link => {
            link.addEventListener('click', function (event) {
                if (!confirm('Are you sure you want to log out?')) {
                    event.preventDefault(); // Stop the navigation if the user clicks "Cancel"
                }
            });
        });
    });

</script>