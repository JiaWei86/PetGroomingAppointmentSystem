@using PetGroomingAppointmentSystem.Models
@model Customer

@{
    ViewData["Title"] = $"Customer Profile - {Model?.Name}";
    ViewData["ActivePage"] = "Customer";

    // Choose the first photo when customer.Photo contains multiple comma-separated URLs
    // Use an existing upload as fallback to avoid404
    string photoSrc = "/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg";
    var photoList = new string[0];
    if (!string.IsNullOrEmpty(Model?.Photo))
    {
        photoList = Model.Photo.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries)
                                 .Select(p => p.Trim())
                                 .Where(p => !string.IsNullOrEmpty(p))
                                 .ToArray();
        if (photoList.Length >0)
        {
            photoSrc = photoList[0];
        }
    }
}


<div class="content-header">
    <a href="@Url.Action("Customer", "Home", new { area = "Admin" })" class="btn btn-sm btn-secondary">← Back to Customers</a>
    <h1 class="page-title">👤 Customer Profile</h1>
</div>

<div class="customer-profile-wrapper">
    <div class="profile-container">

        <!-- Left Column: Customer Info Card -->
        <div>
            <div class="profile-card">
                <!-- Avatar (supports multi-photo carousel) -->
                <div class="animated-avatar-container admin-animated-avatar" id="adminAnimatedAvatar">
                    @if (photoList.Length == 0)
                    {
                        <img src="/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg" alt="@Model?.Name" class="profile-avatar avatar-photo active" />
                    }
                    else
                    {
                        for (int i = 0; i < photoList.Length; i++)
                        {
                            <img src="@photoList[i]" alt="avatar @(i+1)" class="profile-avatar avatar-photo @(i==0?"active":"")" data-index="@i" />
                        }
                    }
                    @if (photoList.Length > 1)
                    {
                        <span class="photo-count-badge">@photoList.Length photos</span>
                    }
                </div>
                @if (photoList.Length > 1)
                {
                    <div class="avatar-indicators" id="adminAvatarIndicators">
                        @for (int i = 0; i < photoList.Length; i++)
                        {
                            <button type="button" class="avatar-indicator @(i==0?"active":"")" data-index="@i"></button>
                        }
                    </div>
                }

                <h4>@Model?.Name</h4>
                <div class="profile-card-email">@Model?.Email</div>

                <button type="button" class="btn btn-primary profile-edit-btn" id="editProfileBtn">
                    ✏️ Edit Profile
                </button>

                <!-- Customer Info List -->
                <div class="profile-info-list">
                    <div class="profile-info-row">
                        <span class="profile-info-label">Phone:</span>
                        <span class="profile-info-value">@Model?.Phone</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">IC Number:</span>
                        <span class="profile-info-value">@Model?.IC</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">Member Since:</span>
                        <span class="profile-info-value">@Model?.RegisteredDate?.ToString("MMM yyyy")</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">Status:</span>
                        <span class="status-tag @(Model?.Status == "active" ? "status-active" : "status-inactive")">
                            @Model?.Status?.ToUpper()
                        </span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">Loyalty Points:</span>
                        <span class="profile-info-value loyalty-points" id="loyaltyPointsDisplay">@Model?.LoyaltyPoint pts</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions-card">
                <h6>Quick Actions</h6>
                <div class="quick-actions-buttons">
                    <button type="button" class="btn btn-primary quick-actions-btn" id="addPetBtn">
                        🐾 Add Pet
                    </button>
                    <button type="button" class="btn btn-primary quick-actions-btn" id="adjustLoyaltyBtn">
                        🎁 Adjust Points
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column: Tabs for Pets & Loyalty -->
        <div class="profile-content-card">
            <!-- Tab Navigation -->
            <div class="profile-tabs">
                <button class="profile-tab-btn active" id="pets-tab-btn" data-tab="pets">
                    🐾 Pets (@(Model?.Pets?.Count ?? 0))
                </button>
                <button class="profile-tab-btn" id="loyalty-tab-btn" data-tab="loyalty">
                    💎 Loyalty Points
                </button>
            </div>

            <!-- Pets Tab Content -->
            <div id="pets-content" class="profile-tab-content active">
                @if (Model?.Pets?.Count > 0)
                {
                    <div class="pets-grid">
                        @foreach (var pet in Model.Pets)
                        {
                            <div class="pet-item">
                                <img src="@(pet?.Photo ?? "/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg")"
                                     alt="@pet?.Name"
                                     class="pet-avatar" />
                                <div class="pet-info">
                                    <h6 class="pet-name">@pet?.Name</h6>
                                    <p class="pet-detail">@pet?.Type - @pet?.Breed</p>
                                    <p class="pet-last-detail">Age: @pet?.Age years</p>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-primary btn-sm edit-pet-btn"
 data-pet-id="@pet?.PetId"
 data-pet-name="@pet?.Name"
 data-pet-type="@pet?.Type"
 data-pet-breed="@pet?.Breed"
 data-pet-age="@pet?.Age"
 data-pet-remark="@pet?.Remark"
 data-pet-photo="@pet?.Photo">
                                            ✏️ Edit
                                        </button>
                                        <button type="button" class="btn btn-sm delete-btn delete-pet-btn" data-pet-id="@pet?.PetId" data-pet-name="@pet?.Name">
                                            🗑️ Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div style="text-align: center; margin-top: 16px;">
                        <button type="button" class="btn btn-primary add-new-pet-btn">
                            ➕ Add New Pet
                        </button>
                    </div>
                }
                else
                {
                    <div class="empty-state-message">
                        <p>No pets assigned yet.</p>
                        <button type="button" class="btn btn-primary add-new-pet-btn">
                            ➕ Add First Pet
                        </button>
                    </div>
                }
            </div>

            <!-- Loyalty Points Tab Content -->
            <div id="loyalty-content" class="profile-tab-content">
                <div class="loyalty-grid">
                    <div class="loyalty-balance-card">
                        <h6 class="loyalty-balance-label">Current Balance</h6>
                        <div class="loyalty-balance-amount">
                            <span id="loyaltyBalanceDisplay">@Model?.LoyaltyPoint</span>
                            <span class="loyalty-balance-unit">pts</span>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm adjust-points-btn">
                            💎 Adjust Points
                        </button>
                    </div>
                    <div class="loyalty-benefits-card">
                        <h6>Loyalty Tier Benefits</h6>
                        <div class="loyalty-tier-item">
                            <span class="loyalty-tier-name">Silver (100+ pts):</span><br>
                            <span class="loyalty-tier-description">5% discount on services</span>
                        </div>
                        <div class="loyalty-tier-item">
                            <span class="loyalty-tier-name">Gold (500+ pts):</span><br>
                            <span class="loyalty-tier-description">10% discount + priority booking</span>
                        </div>
                        <div class="loyalty-tier-item">
                            <span class="loyalty-tier-name">Platinum (1000+ pts):</span><br>
                            <span class="loyalty-tier-description">15% discount + free monthly service</span>
                        </div>
                    </div>
                </div>

                @if (Model?.Redeems?.Count > 0)
                {
                    <div class="redemptions-card">
                        <div class="redemptions-header">
                            Recent Redemptions
                        </div>
                        @foreach (var redeem in Model.Redeems.Take(5))
                        {
                            <div class="redemption-item">
                                <div class="redemption-details">
                                    <strong>@redeem.Gift?.Name</strong>
                                    <span class="redemption-date">@redeem.RedeemDate?.ToString("MMM dd, yyyy")</span>
                                </div>
                                <span class="redemption-points">
                                    -@(redeem.QuantityRedeemed * redeem.Gift?.LoyaltyPointCost ?? 0) pts
                                </span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileOverlay" class="edit-modal-overlay">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h5>✏️ Edit Customer Profile</h5>
            <button type="button" class="edit-modal-close-btn">×</button>
        </div>

        <form id="editProfileForm" asp-controller="Home" asp-action="EditCustomer" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" name="customerId" value="@Model?.UserId" />

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Full Name <span class="modal-form-required">*</span></label>
                    <input id="customerName" type="text" name="Name" value="@Model?.Name" required class="modal-form-input" />
                    <small class="error-message" id="error-Name"></small>
                </div>
                <div class="modal-form-group">
                    <label>Email <span class="modal-form-required">*</span></label>
                    <input id="customerEmail" type="email" name="Email" value="@Model?.Email" required class="modal-form-input" />
                    <small class="error-message" id="error-Email"></small>
                </div>
            </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Phone <span class="modal-form-required">*</span></label>
                    <input id="customerPhone" type="tel" name="Phone" value="@Model?.Phone" required class="modal-form-input" />
                    <small class="error-message" id="error-Phone"></small>
                </div>
                <div class="modal-form-group">
                    <label>IC Number</label>
                    <input id="customerIC" type="text" name="IC" value="@Model?.IC" class="modal-form-input" />
                    <small class="error-message" id="error-IC"></small>
                </div>
            </div>

            <div class="modal-form-group">
                <label>Status</label>
                <select name="Status" id="editStatus" class="modal-form-select">
                    <option value="active">Active</option>
                    <option value="blocked">Blocked</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>

            <div class="modal-form-group">
                <label>Profile Photo</label>
                <input type="file" name="Photos" accept="image/*" class="modal-form-input" multiple />
                <small class="modal-form-help-text">You can select multiple photos. Leave empty to keep current photos.</small>
            </div>

            @* Existing photos gallery with delete buttons *@
            @if (photoList.Length > 0)
            {
                <div class="modal-form-group">
                    <label>Existing Photos</label>
                    <div id="existingPhotosContainer" style="display:flex;gap:8px;flex-wrap:wrap;">
                        @for (int i = 0; i < photoList.Length; i++)
                        {
                            var p = photoList[i];
                            <div class="existing-photo-item" data-photo="@p" style="position:relative;width:72px;height:72px;border-radius:50%;overflow:visible;border:2px solid #ff9500;">
                                <img src="@p" style="width:100%;height:100%;object-fit:cover;display:block;" alt="photo @(i+1)" />
                                <button type="button" class="delete-photo-btn" data-photo="@p" title="Delete photo">×</button>
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="modal-form-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">💾 Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Pet Modal -->
<div id="addPetOverlay" class="edit-modal-overlay">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h5>🐾 Add New Pet</h5>
            <button type="button" class="edit-modal-close-btn">×</button>
        </div>

        <form id="addPetForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" name="customerId" value="@Model?.UserId" />

            <div style="text-align:center;margin-bottom:12px;">
              <img id="addPetPhotoPreview" src="/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg" alt="Pet Photo" style="width:96px;height:96px;border-radius:8px;object-fit:cover;display:block;margin:0 auto8px;" />
              <input type="file" id="addPetPhotoUpload" name="petPhotoUpload" accept="image/*" class="modal-form-input" />
            </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Pet Name <span class="modal-form-required">*</span></label>
                    <input type="text" id="petName" name="petName" required class="modal-form-input" placeholder="e.g., Buddy" />
                </div>
                <div class="modal-form-group">
                    <label>Pet Type <span class="modal-form-required">*</span></label>
                    <select id="petType" name="petType" required class="modal-form-select">
                        <option value="">Select Type</option>
                        <option value="Dog">🐕 Dog</option>
                        <option value="Cat">🐱 Cat</option>

                    </select>
                </div>
            </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Breed</label>
                    <input type="text" id="petBreed" name="petBreed" class="modal-form-input" placeholder="e.g., Golden Retriever" />
                </div>
                <div class="modal-form-group">
                    <label>Age (Years)</label>
                    <input type="number" id="petAge" name="petAge" min="0" max="50" step="0.5" class="modal-form-input" />
                </div>
            </div>

            <div class="modal-form-group">
                <label>Special Notes/Remarks</label>
                <textarea id="petRemark" name="petRemark" class="modal-form-input" rows="3" placeholder="Allergies, behaviors, or special care requirements..."></textarea>
            </div>

            <div id="petErrorMessage" class="alert alert-danger" style="display:none;"></div>
            <div id="petSuccessMessage" class="alert alert-success" style="display:none;"></div>

            <div class="modal-form-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">💾 Add Pet</button>
            </div>
        </form>
    </div>
</div>

<!-- Adjust Loyalty Points Modal -->
<div id="adjustLoyaltyOverlay" class="edit-modal-overlay">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h5>💎 Adjust Loyalty Points</h5>
            <button type="button" class="edit-modal-close-btn">×</button>
        </div>

        <form id="adjustLoyaltyForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="customerId" value="@Model?.UserId" />

            <div class="loyalty-adjustment-info">
                <p><strong>Current Balance:</strong> <span id="currentBalance">@Model?.LoyaltyPoint</span> pts</p>
            </div>

            <div class="modal-form-group">
                <label>Adjustment Type <span class="modal-form-required">*</span></label>
                <div class="adjustment-type-options">
                    <label class="radio-label">
                        <input type="radio" name="adjustmentType" value="add" checked required />
                        <span>➕ Add Points</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="adjustmentType" value="subtract" required />
                        <span>➖ Subtract Points</span>
                    </label>
                </div>
            </div>

            <div class="modal-form-group">
                <label>Amount <span class="modal-form-required">*</span></label>
                <input type="number" id="loyaltyAmount" name="loyaltyAmount" min="0" max="999999" required class="modal-form-input" placeholder="Enter amount" />
            </div>

            <div class="loyalty-preview-info">
                <p><strong>New Balance:</strong> <span id="newBalance">@Model?.LoyaltyPoint</span> pts</p>
            </div>

            <div id="loyaltyErrorMessage" class="alert alert-danger" style="display:none;"></div>
            <div id="loyaltySuccessMessage" class="alert alert-success" style="display:none;"></div>

            <div class="modal-form-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">💾 Confirm Adjustment</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Pet Modal -->
<div id="editPetOverlay" class="edit-modal-overlay">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h5 id="petModalTitle">🐾 Add New Pet</h5>
            <button type="button" class="edit-modal-close-btn">×</button>
        </div>

        <form id="editPetForm">
            @Html.AntiForgeryToken()
            <input type="hidden" id="editPetId" name="petId" value="" />
            <input type="hidden" name="customerId" value="@Model?.UserId" />

            <div style="text-align:center;margin-bottom:12px;">
              <img id="editPetPhotoPreview" src="/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg" alt="Pet Photo" style="width:96px;height:96px;border-radius:8px;object-fit:cover;display:block;margin:0 auto8px;" />
              <input type="file" id="editPetPhotoUpload" name="petPhotoUpload" accept="image/*" class="modal-form-input" />
            </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Pet Name <span class="modal-form-required">*</span></label>
                    <input type="text" id="editPetName" name="petName" required class="modal-form-input" placeholder="e.g., Buddy" />
                </div>
                <div class="modal-form-group">
                    <label>Pet Type <span class="modal-form-required">*</span></label>
                    <select id="editPetType" name="petType" required class="modal-form-select">
                        <option value="">Select Type</option>
                        <option value="Dog">🐕 Dog</option>
                        <option value="Cat">🐱 Cat</option>
                    </select>
                </div>
            </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Breed</label>
                    <input type="text" id="editPetBreed" name="petBreed" class="modal-form-input" placeholder="e.g., Golden Retriever" />
                </div>
                <div class="modal-form-group">
                    <label>Age (Years)</label>
                    <input type="number" id="editPetAge" name="petAge" min="0" max="50" step="0.5" class="modal-form-input" />
                </div>
            </div>

            <div class="modal-form-group">
                <label>Special Notes/Remarks</label>
                <textarea id="editPetRemark" name="petRemark" class="modal-form-input" rows="3" placeholder="Allergies, behaviors, or special care requirements..."></textarea>
            </div>

            <div id="editPetErrorMessage" class="alert alert-danger" style="display:none;"></div>
            <div id="editPetSuccessMessage" class="alert alert-success" style="display:none;"></div>

            <div class="modal-form-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">💾 Save Pet</button>
            </div>
        </form>
    </div>
</div>

<!-- Validation colors -->
<style>
    .error-message { color: #dc3545; font-size:12px; min-height:16px; display:block; }
    .error-message.valid { color: #198754; }
    .modal-form-input.is-invalid { border-color: #dc3545 !important; }
    .modal-form-input.is-valid { border-color: #198754 !important; }

    /* ========== ANIMATED AVATAR (match customer) ========== */
    .admin-animated-avatar {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto; /* center horizontally */
        transform: translateX(6px); /* nudge slightly right to align under name */
        margin-bottom: 15px;
    }

    .admin-animated-avatar .avatar-photo {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #ff9500;
        opacity: 0;
        transition: opacity .25s ease-in-out, transform .2s ease;
        background: #f5f5f5;
    }

    .admin-animated-avatar .avatar-photo.active {
        opacity: 1;
        z-index: 2;
        transform: scale(1);
    }

    .admin-animated-avatar .avatar-photo:not(.active) {
        z-index: 1;
        transform: scale(0.98);
    }

    /* ========== PHOTO INDICATORS (DOTS) ========== */
    .avatar-indicators {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: 10px;
        flex-wrap: wrap;
        max-width: 200px;
        margin-left: auto;
        margin-right: auto;
    }

    .avatar-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        transition: all .2s ease;
        border: none;
        padding: 0;
    }

    .avatar-indicator.active {
        background: #ff9500;
        transform: scale(1.3);
    }

    .avatar-indicator:hover {
        background: #ff6b35;
    }

    /* ========== PHOTO COUNT BADGE ========== */
    .photo-count-badge {
        position: absolute;
        bottom: 6px;
        right: 6px;
        background: #ff9500; /* solid orange for visibility */
        color: #ffffff;
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 14px;
        font-weight: 600;
        z-index: 30;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    /* small visual tweaks to match customer page spacing */
    .profile-card .profile-avatar { width: 100%; height: 100%; border-radius: 50%; }

    /* Existing photos delete button */
    .existing-photo-item { position: relative; overflow: visible; display: inline-block; }
    .existing-photo-item .delete-photo-btn {
        position: absolute;
        top: 6px; /* inside circle */
        right: 6px;
        background: #dc3545;
        color: #fff;
        border: 2px solid #fff;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        padding: 0;
        line-height: 1;
        pointer-events: auto;
    }
    .existing-photo-item .delete-photo-btn:focus { outline: none; box-shadow: 0 4px 8px rgba(255,149,0,0.15); }
</style>

@section Scripts {
    <script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Constants and State ---
    const customerId = '@Model?.UserId';
    let currentLoyaltyPoints = @(Model?.LoyaltyPoint ?? 0); // changed to let so it can be updated
    const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

    const ANIMATION_DELAY = 3200;
    let avatarInterval = null;
    let isAvatarPaused = false;
    let currentPhotoIndex = 0;

    // --- DOM Element References ---
    const avatarContainer = document.getElementById('adminAnimatedAvatar');
    const avatarPhotos = avatarContainer?.querySelectorAll('.avatar-photo');
    const avatarIndicatorsContainer = document.getElementById('adminAvatarIndicators');
    const avatarIndicators = avatarIndicatorsContainer?.querySelectorAll('.avatar-indicator');

    const editProfileModal = document.getElementById('editProfileOverlay');
    const addPetModal = document.getElementById('addPetOverlay');
    const editPetModal = document.getElementById('editPetOverlay');
    const adjustLoyaltyModal = document.getElementById('adjustLoyaltyOverlay');

    const loyaltyAmountInput = document.getElementById('loyaltyAmount');
    const newBalanceDisplay = document.getElementById('newBalance');
    const currentBalanceDisplay = document.getElementById('currentBalance');


    // --- Functions ---

    // Shows a modal overlay.
    // modal: The modal element to show
    function openModal(modal) {
        if (!modal) return;
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    // Hides a modal overlay.
    // modal: The modal element to hide.
    function closeModal(modal) {
        if (!modal) return;
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    // Switches between tabs (Pets and Loyalty).
    // tabName: The name of the tab to switch to ('pets' or 'loyalty').
    function switchTab(tabName) {
        document.querySelectorAll('.profile-tab-content').forEach(content => content.classList.remove('active'));
        document.querySelectorAll('.profile-tab-btn').forEach(btn => btn.classList.remove('active'));

        document.getElementById(`${tabName}-content`)?.classList.add('active');
        document.getElementById(`${tabName}-tab-btn`)?.classList.add('active');
    }

    // --- Avatar Carousel Logic ---

    function updateAvatarUI() {
        avatarPhotos?.forEach((photo, idx) => {
            const isActive = idx === currentPhotoIndex;
            photo.classList.toggle('active', isActive);
            photo.style.opacity = isActive ? '1' : '0';
            photo.style.transform = isActive ? 'scale(1)' : 'scale(0.98)';
        });
        avatarIndicators?.forEach((indicator, idx) => {
            indicator.classList.toggle('active', idx === currentPhotoIndex);
        });
    }

    function advanceAvatar() {
        if (!avatarPhotos || avatarPhotos.length <= 1) return;
        currentPhotoIndex = (currentPhotoIndex + 1) % avatarPhotos.length;
        updateAvatarUI();
    }

    function goToPhoto(index) {
        if (!avatarPhotos || !avatarPhotos[index]) return;
        currentPhotoIndex = index;
        updateAvatarUI();
        // Reset interval so user has time to view the selected photo
        clearInterval(avatarInterval);
        if (!isAvatarPaused) {
            avatarInterval = setInterval(advanceAvatar, ANIMATION_DELAY);
        }
    }

    function initAvatarAnimation() {
        if (!avatarContainer || !avatarPhotos || avatarPhotos.length <= 1) return;

        // Set initial state
        const activePhoto = avatarContainer.querySelector('.avatar-photo.active');
        currentPhotoIndex = activePhoto ? parseInt(activePhoto.dataset.index || '0', 10) : 0;
        updateAvatarUI();

        avatarContainer.addEventListener('mouseenter', () => {
            isAvatarPaused = true;
            clearInterval(avatarInterval);
        });

        avatarContainer.addEventListener('mouseleave', () => {
            isAvatarPaused = false;
            avatarInterval = setInterval(advanceAvatar, ANIMATION_DELAY);
        });
        
        avatarIndicatorsContainer.addEventListener('click', e => {
            if(e.target.matches('.avatar-indicator')) {
                 const index = parseInt(e.target.dataset.index, 10);
                 goToPhoto(index);
            }
        });

        avatarInterval = setInterval(advanceAvatar, ANIMATION_DELAY);
    }
    
    // --- Loyalty Points Modal ---

    function updateLoyaltyPreview() {
        const adjustmentType = document.querySelector('input[name="adjustmentType"]:checked')?.value || 'add';
        const amount = parseInt(loyaltyAmountInput?.value || '0', 10) || 0;
        let newBalance = (typeof currentLoyaltyPoints === 'number') ? currentLoyaltyPoints : 0;

        if (adjustmentType === 'add') {
            newBalance += amount;
        } else {
            newBalance -= amount;
        }

        if (newBalanceDisplay) newBalanceDisplay.textContent = `${newBalance} pts`;
    }

    // --- API Calls ---

    async function handleAddPetSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const successMessage = document.getElementById('petSuccessMessage');
        const errorMessage = document.getElementById('petErrorMessage');
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton?.innerHTML || 'Saving...';

        if(successMessage) successMessage.style.display = 'none';
        if(errorMessage) errorMessage.style.display = 'none';
        if(submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = 'Saving...';
        }

        try {
            // Use the correct action name defined in controller
            const response = await fetch('@Url.Action("AddPetToCustomer", "Home", new { area = "Admin" })', {
                method: 'POST',
                body: formData
            });

            // Read response as text first so we can detect non-JSON responses (e.g. HTML login page due to redirect)
            const raw = await response.text();
            let json = null;
            try {
                json = raw ? JSON.parse(raw) : null;
            } catch (e) {
                // Not JSON (likely HTML), fall through
            }

            if (response.ok && json && json.success) {
                if (successMessage) {
                    successMessage.textContent = 'Pet added successfully! Reloading...';
                    successMessage.style.display = 'block';
                }
                setTimeout(() => window.location.reload(),1500);
            } else {
                // If server returned JSON, prefer its message. Otherwise use raw text or a generic error.
                let errorMsg = 'An unknown error occurred.';
                if (json && json.message) errorMsg = json.message;
                else if (raw && raw.trim().length >0) errorMsg = raw;

                // Common cause: session expired and server returned login HTML. Detect by checking if HTML contains '<form' or 'login'.
                if (!json && /<form\b|login/i.test(raw)) {
                    errorMsg = 'Session expired or redirected to login. Please reload the page and sign in again.';
                    console.warn('AddPetToCustomer: server returned HTML (possible redirect):', raw.substring(0,200));
                }

                if (errorMessage) { errorMessage.textContent = errorMsg; errorMessage.style.display = 'block'; }
            }
        } catch (error) {
            console.error('Error adding pet:', error);
            if(errorMessage) { errorMessage.textContent = 'A network error occurred. Please try again.'; errorMessage.style.display = 'block'; }
        } finally {
            if(submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }
        }
    }

    async function handleAdjustLoyaltySubmit(event) {
        event.preventDefault();
        const form = event.target;
        const successMessage = document.getElementById('loyaltySuccessMessage');
        const errorMessage = document.getElementById('loyaltyErrorMessage');
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton?.innerHTML || 'Saving...';
        
        const data = {
            customerId: form.querySelector('input[name="customerId"]').value,
            adjustmentType: form.querySelector('input[name="adjustmentType"]:checked').value,
            loyaltyAmount: form.querySelector('input[name="loyaltyAmount"]').value,
            __RequestVerificationToken: form.querySelector('input[name="__RequestVerificationToken"]')?.value
        };

        if(successMessage) successMessage.style.display = 'none';
        if(errorMessage) errorMessage.style.display = 'none';
        if(submitButton) { submitButton.disabled = true; submitButton.innerHTML = 'Saving...'; }

        try {
            const response = await fetch('@Url.Action("AdjustLoyalty", "Home", new { area = "Admin" })', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    if(successMessage){ successMessage.textContent = 'Points adjusted successfully!'; successMessage.style.display = 'block'; }

                    const newPoints = result.newLoyaltyPoints;
                    currentLoyaltyPoints = newPoints; // Update mutable global state
                    
                    const loyaltyPointsEl = document.getElementById('loyaltyPointsDisplay');
                    if(loyaltyPointsEl) loyaltyPointsEl.textContent = `${newPoints} pts`;

                    document.querySelectorAll('#loyaltyBalanceDisplay, #currentBalance').forEach(el => {
                        el.textContent = `${newPoints}`;
                    });

                    updateLoyaltyPreview();

                    setTimeout(() => {
                        closeModal(document.getElementById('adjustLoyaltyOverlay'));
                        if(successMessage) successMessage.style.display = 'none';
                    },1500);
                } else {
                    if(errorMessage){ errorMessage.textContent = result.message || 'An unknown error occurred.'; errorMessage.style.display = 'block'; }
                }
            } else {
                let errorMsg = 'An unknown server error occurred.';
                const text = await response.text();
                try {
                    const errorData = text ? JSON.parse(text) : null;
                    errorMsg = (errorData && (errorData.message || errorData.error)) ? (errorData.message || errorData.error) : text || errorMsg;
                } catch (e) {
                    errorMsg = text || errorMsg;
                }
                if(errorMessage) { errorMessage.textContent = errorMsg; errorMessage.style.display = 'block'; }
            }
        } catch (error) {
            console.error('Error adjusting loyalty points:', error);
            if(errorMessage) { errorMessage.textContent = 'A network error occurred. Please check the console.'; errorMessage.style.display = 'block'; }
        } finally {
            if(submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }
        }
    }

    async function deleteCustomerPhoto(photoUrl, button) {
        if (!confirm('Are you sure you want to delete this photo?')) return;
        
        button.disabled = true;
        try {
            const response = await fetch('@Url.Action("DeleteCustomerPhoto", "Home", new { area = "Admin" })', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({ customerId, photoUrl })
            });

            if (response.ok) {
                 // On success, remove the photo from the modal and the carousel
                document.querySelector(`.existing-photo-item[data-photo="${photoUrl}"]`)?.remove();
                const carouselPhoto = document.querySelector(`#adminAnimatedAvatar .avatar-photo[src="${photoUrl}"]`);
                if(carouselPhoto){
                    const wasActive = carouselPhoto.classList.contains('active');
                    carouselPhoto.remove();
                    // Refresh photos nodeList and reset animation
                    const freshPhotos = avatarContainer?.querySelectorAll('.avatar-photo');
                    if(freshPhotos.length > 0 && wasActive){
                        goToPhoto(0);
                    } else if (freshPhotos.length <= 1) {
                         clearInterval(avatarInterval);
                    }
                }
                // Check if no photos are left
                if (document.querySelectorAll('.existing-photo-item').length === 0) {
                     const container = document.getElementById('existingPhotosContainer');
                     if(container) container.innerHTML = '<p style="color:#999;">No photos remaining.</p>';
                }
                // TODO: Add a more robust success notification
            } else {
                throw new Error('Server responded with an error.');
            }
        } catch (error) {
            console.error('Error deleting photo:', error);
            alert('Failed to delete the photo. Please check the console and try again.');
        } finally {
            button.disabled = false;
        }
    }


    // --- Event Listener Setup ---
    
    function setupEventListeners() {
        // --- Modal Triggers ---
        document.getElementById('editProfileBtn')?.addEventListener('click', () => {
             const status = '@Model?.Status';
             document.getElementById('editStatus').value = status;
             openModal(editProfileModal)
        });
        
        document.getElementById('addPetBtn')?.addEventListener('click', () => openModal(addPetModal));
        document.querySelectorAll('.add-new-pet-btn').forEach(btn => btn.addEventListener('click', () => openModal(addPetModal)));

        document.getElementById('adjustLoyaltyBtn')?.addEventListener('click', () => openModal(adjustLoyaltyModal));
        document.querySelectorAll('.adjust-points-btn').forEach(btn => btn.addEventListener('click', () => openModal(adjustLoyaltyModal)));

        // --- Modal Close/Cancel Buttons ---
        document.querySelectorAll('.edit-modal-overlay').forEach(modal => {
            // Close when clicking the background overlay
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeModal(modal);
                }
            });
            // Close when clicking a "close" or "cancel" button inside the modal
            modal.querySelector('.edit-modal-close-btn')?.addEventListener('click', () => closeModal(modal));
            modal.querySelector('.cancel-btn')?.addEventListener('click', () => closeModal(modal));
        });

        // --- Tab Navigation ---
        document.querySelector('.profile-tabs')?.addEventListener('click', (e) => {
            if (e.target.matches('[data-tab]')) {
                switchTab(e.target.dataset.tab);
            }
        });
        
        // --- Pet Actions ---
        document.getElementById('pets-content')?.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-pet-btn');
            const deleteBtn = e.target.closest('.delete-pet-btn');
            if (editBtn) {
                // Populate edit modal using data- attributes (mirror Customer-side behavior)
                const petId = editBtn.dataset.petId || '';
                document.getElementById('editPetId').value = petId;
                document.getElementById('editPetName').value = editBtn.dataset.petName || '';
                document.getElementById('editPetAge').value = editBtn.dataset.petAge || '';
                document.getElementById('editPetType').value = editBtn.dataset.petType || '';
                document.getElementById('editPetBreed').value = editBtn.dataset.petBreed || '';
                document.getElementById('editPetRemark').value = editBtn.dataset.petRemark || '';
                const photo = editBtn.dataset.petPhoto || '';
                const preview = document.getElementById('editPetPhotoPreview');
                if (preview) preview.src = photo || '/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg';
                document.getElementById('petModalTitle').textContent = '🐾 Edit Pet';
                openModal(editPetModal);
                return;
            }
            if (deleteBtn) {
                const petId = deleteBtn.dataset.petId;
                const petName = deleteBtn.dataset.petName || 'this pet';
                if (!confirm(`Delete ${petName}?`)) return;

                // build FormData like customer-side to ensure antiforgery token binds
                const formData = new FormData();
                formData.append('petId', petId);
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) formData.append('__RequestVerificationToken', token);

                // disable button while request is running
                deleteBtn.disabled = true;
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = 'Deleting...';

                fetch('@Url.Action("DeletePet", "Home", new { area = "Admin" })', { method: 'POST', body: formData })
                .then(async response => {
                    const text = await response.text();
                    try {
                        const data = text ? JSON.parse(text) : {};
                        if (data.success) {
                            // mirror customer behavior: reload on success
                            location.reload();
                        } else {
                            console.error('DeletePet error response:', data);
                            alert(data.message || 'Delete failed');
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = originalText;
                        }
                    } catch (err) {
                        console.error('Failed to parse DeletePet response as JSON:', text, err);
                        alert('Server error while deleting pet. See console for details.');
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = originalText;
                    }
                })
                .catch(err => {
                    console.error('DeletePet request failed:', err);
                    alert('Request failed. See console for details.');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalText;
                });
            }
        });

        // --- Edit Pet Form Submit ---
        document.getElementById('editPetForm')?.addEventListener('submit', async function (event) {
            event.preventDefault();
            const form = event.target;
            const successMessage = document.getElementById('editPetSuccessMessage');
            const errorMessage = document.getElementById('editPetErrorMessage');
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton?.innerHTML || 'Saving...';

            if (successMessage) successMessage.style.display = 'none';
            if (errorMessage) errorMessage.style.display = 'none';
            if (submitButton) { submitButton.disabled = true; submitButton.innerHTML = 'Saving...'; }

            try {
                const formData = new FormData(form);
                const response = await fetch('@Url.Action("UpdatePet", "Home", new { area = "Admin" })', { method: 'POST', body: formData });
                const text = await response.text();
                let data = {};
                try { data = text ? JSON.parse(text) : {}; } catch { data = { success: false, message: text || 'Invalid server response' }; }

                if (response.ok && data.success) {
                    if (successMessage) { successMessage.textContent = data.message || 'Pet updated!'; successMessage.style.display = 'block'; }
                    setTimeout(() => { closeModal(editPetModal); location.reload(); },900);
                } else {
                    if (errorMessage) { errorMessage.textContent = data.message || 'Failed to update pet'; errorMessage.style.display = 'block'; }
                }
            } catch (err) {
                console.error('Error updating pet:', err);
                if (document.getElementById('editPetErrorMessage')) { document.getElementById('editPetErrorMessage').textContent = 'Request failed'; document.getElementById('editPetErrorMessage').style.display = 'block'; }
            } finally {
                if (submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalText; }
            }
        });
    }


    // --- Initialization ---
    initAvatarAnimation();
    setupEventListeners();
    updateLoyaltyPreview(); // Initial calculation

    // preview handler for add pet photo
    const addPetPhotoUpload = document.getElementById('addPetPhotoUpload');
    if (addPetPhotoUpload) {
      addPetPhotoUpload.addEventListener('change', function (e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
          const img = document.getElementById('addPetPhotoPreview');
          if (img) img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
    
</script>
}