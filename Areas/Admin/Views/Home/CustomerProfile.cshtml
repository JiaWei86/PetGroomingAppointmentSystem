@using PetGroomingAppointmentSystem.Models
@model Customer

@{
    ViewData["Title"] = $"Customer Profile - {Model?.Name}";
    ViewData["ActivePage"] = "Customer";

    // Choose the first photo when customer.Photo contains multiple comma-separated URLs
    // Use an existing upload as fallback to avoid404
    string photoSrc = "/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg";
    var photoList = new string[0];
    if (!string.IsNullOrEmpty(Model?.Photo))
    {
        photoList = Model.Photo.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries)
                                 .Select(p => p.Trim())
                                 .Where(p => !string.IsNullOrEmpty(p))
                                 .ToArray();
        // Remove duplicate URLs (case-insensitive) so UI doesn't show repeated thumbnails
        photoList = photoList.Distinct(StringComparer.OrdinalIgnoreCase).ToArray();
        if (photoList.Length >0)
        {
            photoSrc = photoList[0];
        }
    }
}

<script>
// Early safe fallback for openConfirmModal so other scripts can call it without errors
if (typeof window !== 'undefined' && typeof window.openConfirmModal !== 'function') {
    window.openConfirmModal = function(title, message, callback) {
        try {
            if (typeof window.showConfirmModal === 'function') {
                window.showConfirmModal(title, message, 'help_outline', '#ef4444', callback);
                return;
            }
        } catch (e) { /* ignore */ }
        if (confirm(message)) { try { callback && callback(); } catch (err) { console.error(err); } }
    };
}
</script>


<div class="content-header">
    <a href="@Url.Action("Customer", "Home", new { area = "Admin" })" class="btn btn-sm btn-secondary">← Back to Customers</a>
    <h1 class="page-title">👤 Customer Profile</h1>
</div>

<div class="customer-profile-wrapper">
    @* Use Groomer/Customer-style alert banner so messages match listing page *@
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" id="alertMessage">
            <strong>❌ Error:</strong> @TempData["ErrorMessage"]
        </div>
    }
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" id="alertMessage">
            <strong>✔️ Success:</strong> @TempData["SuccessMessage"]
        </div>
    }
    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning" id="alertMessage">
            @TempData["WarningMessage"]
        </div>
    }
    <div class="profile-container">

        <!-- Left Column: Customer Info Card -->
        <div>
            <div class="profile-card">
                <!-- Avatar (supports multi-photo carousel) -->
                <div class="animated-avatar-container admin-animated-avatar" id="adminAnimatedAvatar">
                    @if (photoList.Length == 0)
                    {
                        <img src="/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg" alt="@Model?.Name" class="profile-avatar avatar-photo active" />
                    }
                    else
                    {
                        for (int i = 0; i < photoList.Length; i++)
                        {
                            <img src="@photoList[i]" alt="avatar @(i+1)" class="profile-avatar avatar-photo @(i==0?"active":"")" data-index="@i" onerror="this.onerror=null;this.src='/images/ownerAvatar.png'" />
                        }
                    }
                    @if (photoList.Length > 1)
                    {
                        <span class="photo-count-badge">@photoList.Length photos</span>
                    }
                </div>
                @if (photoList.Length > 1)
                {
                    <div class="avatar-indicators" id="adminAvatarIndicators">
                        @for (int i = 0; i < photoList.Length; i++)
                        {
                            <button type="button" class="avatar-indicator @(i==0?"active":"")" data-index="@i"></button>
                        }
                    </div>
                }

                <h4>@Model?.Name</h4>
                <div class="profile-card-email">@Model?.Email</div>

                <button type="button" class="btn btn-primary profile-edit-btn" id="editProfileBtn">
                    ✏️ Edit Profile
                </button>

                <!-- Customer Info List -->
                <div class="profile-info-list">
                    <div class="profile-info-row">
                        <span class="profile-info-label">Phone:</span>
                        <span class="profile-info-value">@Model?.Phone</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">IC Number:</span>
                        <span class="profile-info-value">@Model?.IC</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">Member Since:</span>
                        <span class="profile-info-value">@Model?.RegisteredDate?.ToString("MMM yyyy")</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">Status:</span>
                        <span class="status-tag @(Model?.Status == "active" ? "status-active" : "status-inactive")">
                            @Model?.Status?.ToUpper()
                        </span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-info-label">Loyalty Points:</span>
                        <span class="profile-info-value loyalty-points" id="loyaltyPointsDisplay">@Model?.LoyaltyPoint pts</span>
                    </div>
                </div>
            </div>

                    <!-- Confirmation Modal (page-local, reused from Groomer) -->
                    <div id="confirmModal" class="modal-backdrop">
                        <div class="modal-content">
                            <span class="close-btn" onclick="closeConfirmModal()">&times;</span>
                            <div style="text-align: center; padding: 20px 0;">
                                <div style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;">
                                    <i class="material-icons" id="confirmIcon" style="font-size: 64px;">help_outline</i>
                                </div>
                                <h3 id="confirmTitle" style="margin-bottom: 15px; color: var(--text-color);">Confirm Action</h3>
                                <p id="confirmMessage" style="color: var(--text-light); margin-bottom: 30px; font-size: 15px;"></p>
                                <div style="display: flex; gap: 12px; justify-content: center;">
                                    <button onclick="closeConfirmModal()" class="btn btn-action" style="min-width: 100px;">Cancel</button>
                                    <button id="confirmBtn" class="btn btn-primary" style="min-width: 100px;">Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>

            <!-- Quick Actions -->
            <div class="quick-actions-card">
                <h6>Quick Actions</h6>
                <div class="quick-actions-buttons">
                    <button type="button" class="btn btn-primary quick-actions-btn" id="addPetBtn">
                        🐾 Add Pet
                    </button>
                    <div class="pending-wrapper" @(Model?.Status == "pending_password" ? "data-pending=\"true\"" : "") style="display:inline-block; position:relative;">
                        <button type="button" class="btn btn-primary quick-actions-btn @(Model?.Status == "pending_password" ? "btn-disabled" : "")" id="adjustLoyaltyBtn" @(Model?.Status == "pending_password" ? "disabled aria-disabled=\"true\" tabindex=\"-1\"" : "")>
                            🎁 Adjust Points
                        </button>
                        <span id="adjustPendingHint" class="pending-hint">Customer account not activated — cannot adjust points</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Tabs for Pets & Loyalty -->
        <div class="profile-content-card">
            <!-- Tab Navigation -->
            <div class="profile-tabs">
                <button class="profile-tab-btn active" id="pets-tab-btn" data-tab="pets">
                    🐾 Pets (@(Model?.Pets?.Count ?? 0))
                </button>
                <button class="profile-tab-btn" id="loyalty-tab-btn" data-tab="loyalty">
                    💎 Loyalty Points
                </button>
            </div>

            <!-- Pets Tab Content -->
            <div id="pets-content" class="profile-tab-content active">
                @if (Model?.Pets?.Count > 0)
                {
                    <div class="pets-grid">
                        @foreach (var pet in Model.Pets)
                        {
                            var stored = pet?.Photo?.Trim();
                            string petImg;
                            if (string.IsNullOrEmpty(stored) || stored == "/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg" || stored == "/images/dogAvatar.png" || stored == "/uploads/pet-placeholder.png")
                            {
                                var t = (pet?.Type ?? "").Trim().ToLower();
                                petImg = t == "dog" ? "/images/dogAvatar.png" : (t == "cat" ? "/images/catAvatar.png" : "/images/dogAvatar.png");
                            }
                            else
                            {
                                petImg = stored;
                            }

                            <div class="pet-item">
                                    <img src="@petImg"
                                        onerror="this.onerror=null;this.src='/images/dogAvatar.png'"
                                     alt="@pet?.Name"
                                     class="pet-avatar" />
                                <div class="pet-info">
                                    <h6 class="pet-name">@pet?.Name</h6>
                                    <p class="pet-detail">@pet?.Type - @pet?.Breed</p>
                                    <p class="pet-last-detail">Age: @pet?.Age years</p>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-primary btn-sm edit-pet-btn"
 data-pet-id="@pet?.PetId"
 data-pet-name="@pet?.Name"
 data-pet-type="@pet?.Type"
 data-pet-breed="@pet?.Breed"
 data-pet-age="@pet?.Age"
 data-pet-remark="@pet?.Remark"
 data-pet-photo="@pet?.Photo">
                                            ✏️ Edit
                                        </button>
                                        <button type="button" class="btn btn-sm delete-btn delete-pet-btn" data-pet-id="@pet?.PetId" data-pet-name="@pet?.Name">
                                            🗑️ Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div style="text-align: center; margin-top: 16px;">
                        <button type="button" class="btn btn-primary add-new-pet-btn">
                            ➕ Add New Pet
                        </button>
                    </div>
                }
                else
                {
                    <div class="empty-state-message">
                        <p>No pets assigned yet.</p>
                        <button type="button" class="btn btn-primary add-new-pet-btn">
                            ➕ Add First Pet
                        </button>
                    </div>
                }
            </div>

            <!-- Loyalty Points Tab Content -->
            <div id="loyalty-content" class="profile-tab-content">
                <div class="loyalty-grid">
                    <div class="loyalty-balance-card">
                        <h6 class="loyalty-balance-label">Current Balance</h6>
                        <div class="loyalty-balance-amount">
                            <span id="loyaltyBalanceDisplay">@Model?.LoyaltyPoint</span>
                            <span class="loyalty-balance-unit">pts</span>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm adjust-points-btn">
                            💎 Adjust Points
                        </button>
                    </div>
                    <div class="loyalty-benefits-card">
                        <h6>Loyalty Tier Benefits</h6>
                        <div class="loyalty-tier-item">
                            <span class="loyalty-tier-name">Silver (100+ pts):</span><br>
                            <span class="loyalty-tier-description">5% discount on services</span>
                        </div>
                        <div class="loyalty-tier-item">
                            <span class="loyalty-tier-name">Gold (500+ pts):</span><br>
                            <span class="loyalty-tier-description">10% discount + priority booking</span>
                        </div>
                        <div class="loyalty-tier-item">
                            <span class="loyalty-tier-name">Platinum (1000+ pts):</span><br>
                            <span class="loyalty-tier-description">15% discount + free monthly service</span>
                        </div>
                    </div>
                </div>

                @if (Model?.Redeems?.Count > 0)
                {
                    <div class="redemptions-card">
                        <div class="redemptions-header">
                            Recent Redemptions
                        </div>
                        @foreach (var redeem in Model.Redeems.Take(5))
                        {
                            <div class="redemption-item">
                                <div class="redemption-details">
                                    <strong>@redeem.Gift?.Name</strong>
                                    <span class="redemption-date">@redeem.RedeemDate?.ToString("MMM dd, yyyy")</span>
                                </div>
                                <span class="redemption-points">
                                    -@(redeem.QuantityRedeemed * redeem.Gift?.LoyaltyPointCost ?? 0) pts
                                </span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileOverlay" class="edit-modal-overlay">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h5>✏️ Edit Customer Profile</h5>
            <button type="button" class="edit-modal-close-btn">×</button>
        </div>

        <form id="editProfileForm" asp-controller="Home" asp-action="EditCustomer" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" name="customerId" value="@Model?.UserId" />

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Full Name <span class="modal-form-required">*</span></label>
                    <input id="customerName" type="text" name="Name" value="@Model?.Name" required class="modal-form-input" />
                    <small class="error-message" id="error-Name"></small>
                </div>
                <div class="modal-form-group">
                    <label>Email <span class="modal-form-required">*</span></label>
                    <input id="customerEmail" type="email" name="Email" value="@Model?.Email" required class="modal-form-input" />
                    <small class="error-message" id="error-Email"></small>
                </div>
            </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Phone <span class="modal-form-required">*</span></label>
                    <input id="customerPhone" type="tel" name="Phone" value="@Model?.Phone" required class="modal-form-input" />
                    <small class="error-message" id="error-Phone"></small>
                </div>
                <div class="modal-form-group">
                    <label>IC Number</label>
                    <input id="customerIC" type="text" name="IC" value="@Model?.IC" class="modal-form-input" />
                    <small class="error-message" id="error-IC"></small>
                </div>
            </div>

            <div class="modal-form-group">
                <label>Status</label>
                <select name="Status" id="editStatus" class="modal-form-select">
                    <option value="active">Active</option>
                    <option value="blocked">Blocked</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending_password">Pending Password</option>
                </select>
                <small class="modal-form-help-text">Status change rules: pending-password accounts can only be set to Active by admin.</small>

                <script>
                    (function () {
                        try {
                            var currentStatus = '@(Model?.Status ?? "")'.toLowerCase();
                            var select = document.getElementById('editStatus');
                            if (!select) return;

                            // If account currently pending_password, admin may only change to Active
                            if (currentStatus === 'pending_password') {
                                for (var i = 0; i < select.options.length; i++) {
                                    var opt = select.options[i];
                                    var val = (opt.value || '').toLowerCase();
                                    if (val !== 'pending_password' && val !== 'active') {
                                        opt.disabled = true;
                                    }
                                }
                            }

                            // If account is active, prevent setting it back to pending_password
                            if (currentStatus === 'active') {
                                for (var j = 0; j < select.options.length; j++) {
                                    var o = select.options[j];
                                    if ((o.value || '').toLowerCase() === 'pending_password') o.disabled = true;
                                }
                            }

                            // select the current status if option exists
                            for (var k = 0; k < select.options.length; k++) {
                                if ((select.options[k].value || '').toLowerCase() === currentStatus) {
                                    select.selectedIndex = k; break;
                                }
                            }
                        } catch (e) { console && console.log && console.log('status select init error', e); }
                    })();
                </script>
            </div>

            <div class="modal-form-group">
                <label>Profile Photo</label>
                <input id="editProfilePhotosInput" type="file" name="Photos" accept="image/*" class="modal-form-input" multiple />
                <small class="modal-form-help-text">You can select multiple photos. Leave empty to keep current photos.</small>
                <div id="editPhotoPreviewList" class="photo-preview-list" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"></div>
            </div>

            @* Existing photos gallery with delete buttons *@
            @if (photoList.Length > 0)
            {
                <div class="modal-form-group">
                    <label>Existing Photos</label>
                    <div id="existingPhotosContainer" style="display:flex;gap:8px;flex-wrap:wrap;">
                        @for (int i = 0; i < photoList.Length; i++)
                        {
                            var p = photoList[i];
                            <div class="existing-photo-item" data-photo="@p" style="position:relative;width:72px;height:72px;border:2px solid #ff9500;">
                                <img src="@p" alt="photo @(i+1)" onerror="this.onerror=null;this.src='/images/ownerAvatar.png'" />
                                <button type="button" class="delete-photo-btn" data-photo="@p" title="Delete photo">×</button>
                            </div>
                        }
                    </div>
                </div>
            }

            <div class="modal-form-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">💾 Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Pet Modal -->
<div id="addPetOverlay" class="edit-modal-overlay">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h5>🐾 Add New Pet</h5>
            <button type="button" class="edit-modal-close-btn">×</button>
        </div>

        <form id="addPetForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" name="customerId" value="@Model?.UserId" />

                        <div style="text-align:center;margin-bottom:12px;">
                            <input type="file" id="addPetPhotoUpload" name="petPhotoUpload" accept="image/*" class="modal-form-input" />
                                <div style="margin-top:8px;display:flex;gap:12px;align-items:center;justify-content:center;flex-direction:column;">
                                    <img id="addPetPhotoPreview" src="/images/dogAvatar.png" alt="Pet preview" style="width:120px;height:120px;border-radius:8px;object-fit:cover;" />
                                    <div>
                                        <span id="addPetPhotoFileName" class="file-name-display">No file chosen</span>
                                        <small id="addPetPhotoValidationMessage" class="error-message" aria-live="polite"></small>
                                    </div>
                                </div>
                        </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Pet Name <span class="modal-form-required">*</span></label>
                    <input type="text" id="petName" name="petName" required class="modal-form-input" placeholder="e.g., Buddy" />
                </div>
                <div class="modal-form-group">
                    <label>Pet Type <span class="modal-form-required">*</span></label>
                    <select id="petType" name="petType" required class="modal-form-select">
                        <option value="">Select Type</option>
                        <option value="Dog">🐕 Dog</option>
                        <option value="Cat">🐱 Cat</option>

                    </select>
                </div>
            </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Breed</label>
                    <input type="text" id="petBreed" name="petBreed" class="modal-form-input" placeholder="e.g., Golden Retriever" />
                </div>
                <div class="modal-form-group">
                    <label>Age (Years)</label>
                    <input type="number" id="petAge" name="petAge" min="0" max="50" step="0.5" class="modal-form-input" />
                </div>
            </div>

            <div class="modal-form-group">
                <label>Special Notes/Remarks</label>
                <textarea id="petRemark" name="petRemark" class="modal-form-input" rows="3" placeholder="Allergies, behaviors, or special care requirements..."></textarea>
            </div>

            <div id="petErrorMessage" class="alert alert-danger" style="display:none;"></div>
            <div id="petSuccessMessage" class="alert alert-success" style="display:none;"></div>

            <div class="modal-form-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary" id="addPetSaveBtn">💾 Add Pet</button>
            </div>
        </form>
    </div>
</div>

<!-- Adjust Loyalty Points Modal -->
<div id="adjustLoyaltyOverlay" class="edit-modal-overlay">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h5>💎 Adjust Loyalty Points</h5>
            <button type="button" class="edit-modal-close-btn">×</button>
        </div>

        <form id="adjustLoyaltyForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="customerId" value="@Model?.UserId" />

            <div class="loyalty-adjustment-info">
                <p><strong>Current Balance:</strong> <span id="currentBalance">@Model?.LoyaltyPoint</span> pts</p>
            </div>

            <div class="modal-form-group">
                <label>Adjustment Type <span class="modal-form-required">*</span></label>
                <div class="adjustment-type-options">
                    <label class="radio-label">
                        <input type="radio" name="adjustmentType" value="add" checked required />
                        <span>➕ Add Points</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="adjustmentType" value="subtract" required />
                        <span>➖ Subtract Points</span>
                    </label>
                </div>
            </div>

            <div class="modal-form-group">
                <label>Amount <span class="modal-form-required">*</span></label>
                <input type="number" id="loyaltyAmount" name="loyaltyAmount" min="0" max="999999" required class="modal-form-input" placeholder="Enter amount" />
            </div>

            <div class="loyalty-preview-info">
                <p><strong>New Balance:</strong> <span id="newBalance">@Model?.LoyaltyPoint</span> pts</p>
            </div>

            <div id="loyaltyErrorMessage" class="alert alert-danger" style="display:none;"></div>
            <div id="loyaltySuccessMessage" class="alert alert-success" style="display:none;"></div>

            <div class="modal-form-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">💾 Confirm Adjustment</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Pet Modal -->
<div id="editPetOverlay" class="edit-modal-overlay">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h5 id="petModalTitle">🐾 Add New Pet</h5>
            <button type="button" class="edit-modal-close-btn">×</button>
        </div>

        <form id="editPetForm">
            @Html.AntiForgeryToken()
            <input type="hidden" id="editPetId" name="petId" value="" />
            <input type="hidden" name="customerId" value="@Model?.UserId" />

                        <div style="text-align:center;margin-bottom:12px;">
                            <input type="file" id="editPetPhotoUpload" name="petPhotoUpload" accept="image/*" class="modal-form-input" />
                                <div style="margin-top:8px;display:flex;gap:12px;align-items:center;justify-content:center;flex-direction:column;">
                                    <img id="editPetPhotoPreview" src="/images/dogAvatar.png" alt="Pet preview" style="width:120px;height:120px;border-radius:8px;object-fit:cover;" />
                                    <div>
                                        <span id="editPetPhotoFileName" class="file-name-display">No file chosen</span>
                                        <small id="editPetPhotoValidationMessage" class="error-message" aria-live="polite"></small>
                                    </div>
                                </div>
                        </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Pet Name <span class="modal-form-required">*</span></label>
                    <input type="text" id="editPetName" name="petName" required class="modal-form-input" placeholder="e.g., Buddy" />
                </div>
                <div class="modal-form-group">
                    <label>Pet Type <span class="modal-form-required">*</span></label>
                    <select id="editPetType" name="petType" required class="modal-form-select">
                        <option value="">Select Type</option>
                        <option value="Dog">🐕 Dog</option>
                        <option value="Cat">🐱 Cat</option>
                    </select>
                </div>
            </div>

            <div class="modal-form-grid-2">
                <div class="modal-form-group">
                    <label>Breed</label>
                    <input type="text" id="editPetBreed" name="petBreed" class="modal-form-input" placeholder="e.g., Golden Retriever" />
                </div>
                <div class="modal-form-group">
                    <label>Age (Years)</label>
                    <input type="number" id="editPetAge" name="petAge" min="0" max="50" step="0.5" class="modal-form-input" />
                </div>
            </div>

            <div class="modal-form-group">
                <label>Special Notes/Remarks</label>
                <textarea id="editPetRemark" name="petRemark" class="modal-form-input" rows="3" placeholder="Allergies, behaviors, or special care requirements..."></textarea>
            </div>

            <div id="editPetErrorMessage" class="alert alert-danger" style="display:none;"></div>
            <div id="editPetSuccessMessage" class="alert alert-success" style="display:none;"></div>

            <div class="modal-form-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary" id="editPetSaveBtn">💾 Save Pet</button>
            </div>
        </form>
    </div>
</div>

<!-- Validation colors -->
<style>
    .error-message { color: #6b7280; font-size:12px; min-height:16px; display:block; }
    .error-message.valid { color: #198754; }
    .error-message.invalid { color: #dc3545; }
    .modal-form-input.is-invalid { border-color: #dc3545 !important; }
    .modal-form-input.is-valid { border-color: #198754 !important; }

    /* ========== ANIMATED AVATAR (match customer) ========== */
    .admin-animated-avatar {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto; /* center horizontally */
        transform: translateX(6px); /* nudge slightly right to align under name */
        margin-bottom: 15px;
    }

    .admin-animated-avatar .avatar-photo {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #ff9500;
        opacity: 0;
        transition: opacity .25s ease-in-out, transform .2s ease;
        background: #f5f5f5;
    }

    .admin-animated-avatar .avatar-photo.active {
        opacity: 1;
        z-index: 2;
        transform: scale(1);
    }

    .admin-animated-avatar .avatar-photo:not(.active) {
        z-index: 1;
        transform: scale(0.98);
    }

    /* ========== PHOTO INDICATORS (DOTS) ========== */
    .avatar-indicators {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: 10px;
        flex-wrap: wrap;
        max-width: 200px;
        margin-left: auto;
        margin-right: auto;
    }

    .avatar-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        transition: all .2s ease;
        border: none;
        padding: 0;
    }

    .avatar-indicator.active {
        background: #ff9500;
        transform: scale(1.3);
    }

    .avatar-indicator:hover {
        background: #ff6b35;
    }

    /* ========== PHOTO COUNT BADGE ========== */
    .photo-count-badge {
        position: absolute;
        bottom: 6px;
        right: 6px;
        background: #ff9500; /* solid orange for visibility */
        color: #ffffff;
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 14px;
        font-weight: 600;
        z-index: 30;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    /* small visual tweaks to match customer page spacing */
    .profile-card .profile-avatar { width: 100%; height: 100%; border-radius: 50%; }

    /* Existing photos delete button */
    .existing-photo-item { position: relative; overflow: hidden; display: inline-block; width:72px; height:72px; border-radius:50%; }
    .existing-photo-item img { width:100%; height:100%; object-fit:cover; display:block; border-radius:50%; }
    .existing-photo-item .delete-photo-btn {
        position: absolute;
        top: 6px; /* inside circle */
        right: 6px;
        background: #dc3545;
        color: #fff;
        border: 2px solid #fff;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        padding: 0;
        line-height: 1;
        pointer-events: auto;
    }
    .existing-photo-item .delete-photo-btn:focus { outline: none; box-shadow: 0 4px 8px rgba(255,149,0,0.15); }
</style>

<style>
    /* Groomer-style alert & modal (copied for consistent look) */
    @@keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    #alertMessage { position: fixed; top: 85px; left: calc(var(--sidebar-width) + 35px); right: 35px; animation: slideDown 0.5s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.25); padding: 24px 32px !important; font-size: 18px !important; font-weight: 600 !important; border-radius: 12px !important; border-width: 3px !important; }
    #alertMessage.alert-success { background: linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%) !important; color:#065f46 !important; border-left:6px solid #10b981 !important; }
    #alertMessage.alert-danger { background: linear-gradient(135deg,#fee2e2 0%,#fecaca 100%) !important; color:#991b1b !important; border-left:6px solid #ef4444 !important; }
    #alertMessage.alert-warning { background: linear-gradient(135deg,#fef3c7 0%,#fde68a 100%) !important; color:#92400e !important; border-left:6px solid #f59e0b !important; }

    .alert { position: fixed; top: 85px; left: calc(var(--sidebar-width) + 35px); right: 35px; z-index: 9999; padding: 24px 32px !important; font-size: 18px !important; font-weight: 600 !important; border-radius: 12px !important; box-shadow: 0 8px 20px rgba(0,0,0,0.25) !important; animation: slideDown 0.5s ease !important; }
    .alert.alert-success { background: linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%) !important; color: #065f46 !important; border-left: 6px solid #10b981 !important; }
    .alert.alert-danger { background: linear-gradient(135deg,#fee2e2 0%,#fecaca 100%) !important; color:#991b1b !important; border-left:6px solid #ef4444 !important; }
    .alert.alert-warning { background: linear-gradient(135deg,#fef3c7 0%,#fde68a 100%) !important; color:#92400e !important; border-left:6px solid #f59e0b !important; }

    /* Modal Styles */
    .modal-backdrop { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); z-index:40000; align-items:center; justify-content:center; }
    .modal-backdrop.show { display:flex; }
    .modal-content { background-color:white; padding:20px; border-radius:8px; max-width:500px; width:90%; position:relative; }
    .close-btn { position:absolute; top:10px; right:10px; font-size:24px; cursor:pointer; color:#666; }
    .close-btn:hover { color:#000; }

    /* Disabled-looking button for pending customers */
    .btn-disabled {
        background: #cbd5e1 !important;
        color: #6b7280 !important;
        border-color: #cbd5e1 !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
    }

    .pending-hint {
        display: none;
        background: rgba(17,24,39,0.9);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        line-height: 1;
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        white-space: nowrap;
        z-index: 50000;
        box-shadow: 0 6px 18px rgba(0,0,0,0.2);
    }

    .pending-wrapper[data-pending="true"]:hover .pending-hint,
    .pending-wrapper[data-pending="true"]:focus-within .pending-hint {
        display: inline-block;
    }

    .btn-disabled {
        background: #cbd5e1 !important;
        color: #6b7280 !important;
        border-color: #cbd5e1 !important;
        cursor: not-allowed !important;
        box-shadow: none !important;
        pointer-events: none !important;
    }
</style>

@section Scripts {
    <script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Constants and State ---
    const customerId = '@Model?.UserId';
    let currentLoyaltyPoints = @(Model?.LoyaltyPoint ?? 0); // changed to let so it can be updated
    const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
    const customerStatus = '@(Model?.Status ?? "")';

    const ANIMATION_DELAY = 3200;
    let avatarInterval = null;
    let isAvatarPaused = false;
    let currentPhotoIndex = 0;

    // --- DOM Element References ---
    const avatarContainer = document.getElementById('adminAnimatedAvatar');
    let avatarPhotos = [];
    const avatarIndicatorsContainer = document.getElementById('adminAvatarIndicators');
    let avatarIndicators = [];

    const editProfileModal = document.getElementById('editProfileOverlay');
    const addPetModal = document.getElementById('addPetOverlay');
    const editPetModal = document.getElementById('editPetOverlay');
    const adjustLoyaltyModal = document.getElementById('adjustLoyaltyOverlay');

    const loyaltyAmountInput = document.getElementById('loyaltyAmount');
    const newBalanceDisplay = document.getElementById('newBalance');
    const currentBalanceDisplay = document.getElementById('currentBalance');

    


    // --- Functions ---

    // Shows a modal overlay.
    // modal: The modal element to show
    function openModal(modal) {
        if (!modal) return;
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    // Hides a modal overlay.
    // modal: The modal element to hide.
    function closeModal(modal) {
        if (!modal) return;
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
        // Cleanup: if closing adjust loyalty modal, clear messages and re-enable submit
        try {
            if (modal && modal.id === 'adjustLoyaltyOverlay') {
                const errEl = document.getElementById('loyaltyErrorMessage');
                const successEl = document.getElementById('loyaltySuccessMessage');
                if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
                if (successEl) { successEl.style.display = 'none'; successEl.textContent = ''; }
                const submitBtn = modal.querySelector('button[type="submit"]');
                if (submitBtn && submitBtn.dataset && submitBtn.dataset._wasDisabledByPending) {
                    submitBtn.disabled = false;
                    delete submitBtn.dataset._wasDisabledByPending;
                }
            }
        } catch (e) { /* ignore */ }
    }

    // Page-local confirm modal fallback (reuse Groomer pattern)
    if (typeof window.showConfirmModal !== 'function') {
        function ensureConfirmModal() {
            try {
                const modal = document.getElementById('confirmModal');
                if (!modal) return;
                if (modal.parentElement !== document.body) document.body.appendChild(modal);
                modal.style.zIndex = '40000';
                const content = modal.querySelector('.modal-content');
                if (content) content.style.zIndex = '40001';
            } catch (e) { console.warn('ensureConfirmModal error', e); }
        }

        window.showConfirmModal = function(title, message, icon, iconColor, confirmCallback) {
            try { ensureConfirmModal(); } catch (e) {}
            const modal = document.getElementById('confirmModal');
            const confirmBtn = document.getElementById('confirmBtn');
            const confirmIcon = document.getElementById('confirmIcon');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            if (!modal || !confirmBtn || !confirmIcon || !confirmTitle || !confirmMessage) {
                if (confirm(message)) { confirmCallback && confirmCallback(); }
                return;
            }
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmIcon.textContent = icon || 'help_outline';
            confirmIcon.style.color = iconColor || '#000';
            modal.classList.add('show');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (typeof confirmCallback === 'function') confirmCallback();
                modal.classList.remove('show');
            });
        };

        window.closeConfirmModal = function() { const modal = document.getElementById('confirmModal'); if (modal) modal.classList.remove('show'); };

        window.openConfirmModal = function(title, message, callback) { window.showConfirmModal(title, message, 'help_outline', '#ef4444', callback); };

        // Intercept confirm submit so we can include selected preview files and provide smooth UX
        if (typeof window.confirmEditProfile !== 'function') {
            window.confirmEditProfile = function(event, name) {
                if (event && event.preventDefault) event.preventDefault();
                // Determine the form element (event.target can be the form when used as onsubmit)
                const form = event && event.target && event.target.tagName === 'FORM' ? event.target : document.getElementById('editProfileForm');
                const doSubmit = function() { 
                    if (form) {
                        console.log('antiforgery token', document.querySelector('input[name="__RequestVerificationToken"]').value);
                        submitEditProfileForm(form); 
                    }
                };
                if (typeof window.openConfirmModal === 'function') {
                    window.openConfirmModal('Confirm Edit', `Are you sure you want to save changes to "${name}"?`, doSubmit);
                } else if (typeof window.showConfirmModal === 'function') {
                    window.showConfirmModal('Confirm Edit', `Are you sure you want to save changes to "${name}"?`, 'save', '#10b981', doSubmit);
                } else {
                    if (confirm(`Are you sure you want to save changes to "${name}"?`)) doSubmit();
                }
                return false;
            };
        }

        // Ensure confirmEditProfile is defined even if a global showConfirmModal exists
        if (typeof window.confirmEditProfile !== 'function') {
            window.confirmEditProfile = function(event, name) {
                if (event && event.preventDefault) event.preventDefault();
                const form = event && event.target && event.target.tagName === 'FORM' ? event.target : document.getElementById('editProfileForm');
                const doSubmit = function() { if (form) submitEditProfileForm(form); };
                if (typeof window.openConfirmModal === 'function') {
                    window.openConfirmModal('Confirm Edit', `Are you sure you want to save changes to "${name}"?`, doSubmit);
                } else if (typeof window.showConfirmModal === 'function') {
                    window.showConfirmModal('Confirm Edit', `Are you sure you want to save changes to "${name}"?`, 'save', '#10b981', doSubmit);
                } else {
                    if (confirm(`Are you sure you want to save changes to "${name}"?`)) doSubmit();
                }
                return false;
            };
        }
    }

    // Submit edit profile via fetch so we can control which files are uploaded (based on preview selection)
    async function submitEditProfileForm(form) {
        try {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) { submitBtn.disabled = true; submitBtn.innerText = 'Saving...'; }

            const fd = new FormData();
            // Append non-file fields
            Array.from(form.elements).forEach(el => {
                if (!el.name) return;
                if (el.type === 'file') return; // handled separately
                if (el.name === '__RequestVerificationToken') return; // handled manually to avoid duplication
                if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) return;
                fd.append(el.name, el.value);
            });

            // Append files selected via preview manager
            if (window._editSelectedFiles && window._editSelectedFiles.length) {
                window._editSelectedFiles.forEach((f) => fd.append('Photos', f));
            }

            // Ensure anti-forgery token present (append once)
            const token = form.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (token) fd.append('__RequestVerificationToken', token);

                // Ensure antiforgery cookie is sent and token header included to prevent 400
                const tokenValue = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                const response = await fetch(form.action || window.location.href, {
                    method: 'POST',
                    body: fd,
                    credentials: 'include',
                    headers: tokenValue ? { 'X-Requested-With': 'XMLHttpRequest', 'RequestVerificationToken': tokenValue } : { 'X-Requested-With': 'XMLHttpRequest' }
                });
            // Log status and body for easier debugging when server returns HTML or errors
            try {
                const raw = await response.text();
                console.log('[EditCustomer] response status:', response.status, 'body length:', raw ? raw.length : 0);
                if (!response.ok) console.error('[EditCustomer] response body:', raw);
                // Re-create a Response object if caller expects response.json() later (not needed here)
            } catch (e) { console.warn('Could not read EditCustomer response body', e); }

            if (response.ok) {
                showDynamicAlert('Profile updated', 'success');
                // delay longer so console messages are visible before the reload
                setTimeout(() => { window.location.href = '@Url.Action("CustomerProfile","Home", new { area = "Admin", customerId = Model?.UserId })'; }, 6000);
            } else {
                // Already logged body above
                showDynamicAlert('Failed to update profile. See console.', 'danger');
                if (submitBtn) { submitBtn.disabled = false; submitBtn.innerText = '💾 Save Changes'; }
            }
        } catch (err) {
            console.error('submitEditProfileForm error', err);
            showDynamicAlert('Network error. See console.', 'danger');
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) { submitBtn.disabled = false; submitBtn.innerText = '💾 Save Changes'; }
        }
    }

    // Ensure `confirmEditProfile` exists even when a global `showConfirmModal` is already present
    if (typeof window.confirmEditProfile !== 'function') {
        window.confirmEditProfile = function(event, name) {
            if (event && event.preventDefault) event.preventDefault();
            const form = event && event.target && event.target.tagName === 'FORM' ? event.target : document.getElementById('editProfileForm');
            const doSubmit = function() { if (form) submitEditProfileForm(form); };
            if (typeof window.openConfirmModal === 'function') {
                window.openConfirmModal('Confirm Edit', `Are you sure you want to save changes to "${name}"?`, doSubmit);
            } else if (typeof window.showConfirmModal === 'function') {
                window.showConfirmModal('Confirm Edit', `Are you sure you want to save changes to "${name}"?`, 'save', '#10b981', doSubmit);
            } else {
                if (confirm(`Are you sure you want to save changes to "${name}"?`)) doSubmit();
            }
            return false;
        };
    }

    // showDynamicAlert fallback — use same Groomer/Customer listing style (banner from sidebar to right edge)
    if (typeof window.showDynamicAlert !== 'function') {
        window.showDynamicAlert = function(message, type) {
            try {
                const existing = document.getElementById('alertMessage');
                if (existing) existing.remove();

                const alertDiv = document.createElement('div');
                alertDiv.id = 'alertMessage';
                const bsClass = type === 'success' ? 'alert-success' : (type === 'warning' ? 'alert-warning' : 'alert-danger');
                alertDiv.className = `alert ${bsClass}`;
                alertDiv.setAttribute('role', 'alert');
                // Use the same structure as listing page alerts so CSS matches
                alertDiv.innerHTML = `<strong>${type === 'success' ? '✔️ Success:' : (type === 'warning' ? '⚠️ Warning:' : '❌ Error:')}</strong> ${message}`;

                document.body.appendChild(alertDiv);

                // Auto hide after 5 seconds
                setTimeout(() => {
                    if (alertDiv) {
                        alertDiv.classList.add('fade-out');
                        alertDiv.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                        alertDiv.style.opacity = '0';
                        alertDiv.style.transform = 'translateY(-10px)';
                        setTimeout(() => { alertDiv.remove(); }, 450);
                    }
                }, 5000);
            } catch (e) {
                console.error('showDynamicAlert error:', e);
            }
        };
    }

    // Switches between tabs (Pets and Loyalty).
    // tabName: The name of the tab to switch to ('pets' or 'loyalty').
    function switchTab(tabName) {
        document.querySelectorAll('.profile-tab-content').forEach(content => content.classList.remove('active'));
        document.querySelectorAll('.profile-tab-btn').forEach(btn => btn.classList.remove('active'));

        document.getElementById(`${tabName}-content`)?.classList.add('active');
        document.getElementById(`${tabName}-tab-btn`)?.classList.add('active');
    }

    // --- Avatar Carousel Logic ---

    function updateAvatarUI() {
        if (!avatarPhotos || avatarPhotos.length === 0) return;
        avatarPhotos.forEach((photo, idx) => {
            const isActive = idx === currentPhotoIndex;
            photo.classList.toggle('active', isActive);
            photo.style.opacity = isActive ? '1' : '0';
            photo.style.transform = isActive ? 'scale(1)' : 'scale(0.98)';
        });
        if (avatarIndicators && avatarIndicators.length) {
            avatarIndicators.forEach((indicator, idx) => {
                indicator.classList.toggle('active', idx === currentPhotoIndex);
            });
        }
    }

    function advanceAvatar() {
        if (!avatarPhotos || avatarPhotos.length <= 1) return;
        currentPhotoIndex = (currentPhotoIndex + 1) % avatarPhotos.length;
        updateAvatarUI();
    }

    function goToPhoto(index) {
        if (!avatarPhotos || !avatarPhotos[index]) return;
        currentPhotoIndex = index;
        updateAvatarUI();
        // Reset interval so user has time to view the selected photo
        clearInterval(avatarInterval);
        if (!isAvatarPaused) {
            avatarInterval = setInterval(advanceAvatar, ANIMATION_DELAY);
        }
    }

    function initAvatarAnimation() {
        if (!avatarContainer) return;

        // Re-query photos/indicators to ensure we have the live nodes
        avatarPhotos = Array.from(avatarContainer.querySelectorAll('.avatar-photo'));
        avatarIndicators = avatarIndicatorsContainer ? Array.from(avatarIndicatorsContainer.querySelectorAll('.avatar-indicator')) : [];

        if (!avatarPhotos || avatarPhotos.length <= 1) return;

        // Set initial state
        const activePhoto = avatarContainer.querySelector('.avatar-photo.active');
        currentPhotoIndex = activePhoto ? parseInt(activePhoto.dataset.index || '0', 10) : 0;
        updateAvatarUI();

        avatarContainer.addEventListener('mouseenter', () => {
            isAvatarPaused = true;
            clearInterval(avatarInterval);
        });

        avatarContainer.addEventListener('mouseleave', () => {
            isAvatarPaused = false;
            avatarInterval = setInterval(advanceAvatar, ANIMATION_DELAY);
        });

        if (avatarIndicatorsContainer) {
            avatarIndicatorsContainer.addEventListener('click', e => {
                if (e.target && e.target.matches('.avatar-indicator')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    if (!Number.isNaN(index)) goToPhoto(index);
                }
            });
        }

        clearInterval(avatarInterval);
        avatarInterval = setInterval(advanceAvatar, ANIMATION_DELAY);
    }
    
    // --- Loyalty Points Modal ---

    function updateLoyaltyPreview() {
        const adjustmentType = document.querySelector('input[name="adjustmentType"]:checked')?.value || 'add';
        const amount = parseInt(loyaltyAmountInput?.value || '0', 10) || 0;
        let newBalance = (typeof currentLoyaltyPoints === 'number') ? currentLoyaltyPoints : 0;

        if (adjustmentType === 'add') {
            newBalance += amount;
        } else {
            newBalance -= amount;
        }

        // Ensure new balance never goes negative
        newBalance = Math.max(0, newBalance);

        if (newBalanceDisplay) newBalanceDisplay.textContent = `${newBalance} pts`;
    }

    // --- API Calls ---

    async function handleAddPetSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const successMessage = document.getElementById('petSuccessMessage');
        const errorMessage = document.getElementById('petErrorMessage');
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton?.innerHTML || 'Saving...';

        if(successMessage) successMessage.style.display = 'none';
        if(errorMessage) errorMessage.style.display = 'none';
        if(submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = 'Saving...';
        }

        try {
            // Ensure antiforgery token appended and cookies sent
            const token = form.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (token) formData.append('__RequestVerificationToken', token);
            // Use the correct action name defined in controller
            const tokenHeaderAdd = form.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const response = await fetch('@Url.Action("AddPetToCustomer", "Home", new { area = "Admin" })', {
                method: 'POST',
                body: formData,
                credentials: 'include',
                headers: tokenHeaderAdd ? { 'X-Requested-With': 'XMLHttpRequest', 'RequestVerificationToken': tokenHeaderAdd } : { 'X-Requested-With': 'XMLHttpRequest' }
            });

            // Read response as text first so we can detect non-JSON responses (e.g. HTML login page due to redirect)
            const raw = await response.text();
            let json = null;
            try {
                json = raw ? JSON.parse(raw) : null;
            } catch (e) {
                // Not JSON (likely HTML), fall through
            }

            if (response.ok && json && json.success) {
                if (successMessage) {
                    successMessage.textContent = 'Pet added successfully! Reloading...';
                    successMessage.style.display = 'block';
                }
                try { showDynamicAlert('Pet added successfully! Reloading...', 'success'); } catch (e) {}
                setTimeout(() => window.location.reload(),5000);
            } else {
                // If server returned JSON, prefer its message. Otherwise use raw text or a generic error.
                let errorMsg = 'An unknown error occurred.';
                if (json && json.message) errorMsg = json.message;
                else if (raw && raw.trim().length >0) errorMsg = raw;

                // Common cause: session expired and server returned login HTML. Detect by checking if HTML contains '<form' or 'login'.
                if (!json && /<form\b|login/i.test(raw)) {
                    errorMsg = 'Session expired or redirected to login. Please reload the page and sign in again.';
                    console.warn('AddPetToCustomer: server returned HTML (possible redirect):', raw.substring(0,200));
                }

                if (errorMessage) { errorMessage.textContent = errorMsg; errorMessage.style.display = 'block'; }
            }
        } catch (error) {
            console.error('Error adding pet:', error);
            if(errorMessage) { errorMessage.textContent = 'A network error occurred. Please try again.'; errorMessage.style.display = 'block'; }
        } finally {
            if(submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }
        }
    }

    async function handleAdjustLoyaltySubmit(event) {
        event.preventDefault();
        const form = event.target;
        const successMessage = document.getElementById('loyaltySuccessMessage');
        const errorMessage = document.getElementById('loyaltyErrorMessage');
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton?.innerHTML || 'Saving...';
        
        const rawAmount = form.querySelector('input[name="loyaltyAmount"]').value;
        const amt = parseInt(rawAmount, 10);
        const token = form.querySelector('input[name="__RequestVerificationToken"]')?.value;

        const data = {
            customerId: form.querySelector('input[name="customerId"]').value,
            adjustmentType: form.querySelector('input[name="adjustmentType"]:checked').value,
            loyaltyAmount: isNaN(amt) ? 0 : amt
        };

        if(successMessage) successMessage.style.display = 'none';
        if(errorMessage) errorMessage.style.display = 'none';
        if(submitButton) { submitButton.disabled = true; submitButton.innerHTML = 'Saving...'; }

        try {
            if (isNaN(amt) || amt < 0) {
                if (errorMessage) { errorMessage.textContent = 'Amount must be a non-negative integer.'; errorMessage.style.display = 'block'; }
                if (submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }
                return;
            }

            // Client-side guard: when subtracting, do not allow subtracting more than current balance
            const adjustmentType = form.querySelector('input[name="adjustmentType"]:checked')?.value || 'add';
            if (adjustmentType === 'subtract' && (isNaN(amt) ? 0 : amt) > (typeof currentLoyaltyPoints === 'number' ? currentLoyaltyPoints : 0)) {
                if (errorMessage) { errorMessage.textContent = 'Cannot subtract more than the customer\'s current balance.'; errorMessage.style.display = 'block'; }
                if (submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }
                return;
            }

            // Client-side guard: block adjustments for customers pending password setup
            if (customerStatus && customerStatus.toLowerCase() === 'pending_password') {
                if (errorMessage) { errorMessage.textContent = 'Cannot adjust points: customer account not activated.'; errorMessage.style.display = 'block'; }
                if (submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }
                return;
            }

            // Use FormData so ASP.NET model binding binds primitive params correctly
            const fd = new FormData();
            fd.append('customerId', data.customerId);
            fd.append('adjustmentType', data.adjustmentType);
            fd.append('loyaltyAmount', String(data.loyaltyAmount));
            if (token) fd.append('__RequestVerificationToken', token);

            const response = await fetch('@Url.Action("AdjustLoyaltyPoints", "Home", new { area = "Admin" })', {
                method: 'POST',
                credentials: 'include',
                headers: token ? { 'RequestVerificationToken': token } : {},
                body: fd
            });

            const raw = await response.text();
            let result = {};
            try { result = raw ? JSON.parse(raw) : {}; } catch (e) { result = { success: false, message: raw || 'Invalid server response' }; }

            if (response.ok && result && result.success) {
                if(successMessage){ successMessage.textContent = 'Points adjusted successfully!'; successMessage.style.display = 'block'; }

                const newPoints = result.newLoyaltyPoints;
                currentLoyaltyPoints = newPoints; // Update mutable global state
                
                const loyaltyPointsEl = document.getElementById('loyaltyPointsDisplay');
                if(loyaltyPointsEl) loyaltyPointsEl.textContent = `${newPoints} pts`;

                document.querySelectorAll('#loyaltyBalanceDisplay, #currentBalance').forEach(el => {
                    el.textContent = `${newPoints}`;
                });

                updateLoyaltyPreview();

                // Show global dynamic alert and close modal after a short delay
                try { showDynamicAlert('Points adjusted successfully!', 'success'); } catch (e) {}
                setTimeout(() => { try { closeModal(adjustLoyaltyModal); } catch (e) {} }, 1200);

                setTimeout(() => {
                    closeModal(document.getElementById('adjustLoyaltyOverlay'));
                    if(successMessage) successMessage.style.display = 'none';
                },1500);
            } else {
                const errMsg = result && (result.message || result.error) ? (result.message || result.error) : (raw || 'An unknown server error occurred.');
                if(errorMessage) { errorMessage.textContent = errMsg; errorMessage.style.display = 'block'; }
            }
        } catch (error) {
            console.error('Error adjusting loyalty points:', error);
            if(errorMessage) { errorMessage.textContent = 'A network error occurred. Please check the console.'; errorMessage.style.display = 'block'; }
        } finally {
            if(submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalButtonText; }
        }
    }

    async function deleteCustomerPhoto(photoUrl, button) {
        // Use page confirm modal (Groomer style) to match Customer page
        if (typeof window.showConfirmModal === 'function') {
            window.showConfirmModal('Confirm Delete', 'Are you sure you want to delete this photo?', 'delete', '#ef4444', async function() {
                // proceed with deletion
                if (button) button.disabled = true;
                try {
                    const response = await fetch('@Url.Action("DeleteCustomerPhoto", "Home", new { area = "Admin" })', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': antiForgeryToken
                        },
                        body: JSON.stringify({ customerId, photoUrl })
                    });

                    if (response.ok) {
                        try { button.closest('.existing-photo-item')?.remove(); } catch (e) {}

                        let carouselPhoto = null;
                        if (avatarContainer) {
                            carouselPhoto = Array.from(avatarContainer.querySelectorAll('.avatar-photo')).find(img => {
                                const s = img.getAttribute('src') || '';
                                try { return s === photoUrl || img.src.endsWith(photoUrl) || s.endsWith(photoUrl); } catch { return s === photoUrl; }
                            });
                        }

                        if (carouselPhoto) {
                            const wasActive = carouselPhoto.classList.contains('active');
                            carouselPhoto.remove();
                            const freshPhotos = avatarContainer?.querySelectorAll('.avatar-photo') || [];
                            if (freshPhotos.length > 0 && wasActive) goToPhoto(0);
                            if (freshPhotos.length <= 1) clearInterval(avatarInterval);
                        }

                        if (document.querySelectorAll('.existing-photo-item').length === 0) {
                            const container = document.getElementById('existingPhotosContainer');
                            if (container) container.innerHTML = '<p style="color:#999;">No photos remaining.</p>';
                        }

                        showDynamicAlert('Photo deleted', 'success');
                    } else {
                        const text = await response.text();
                        console.error('DeleteCustomerPhoto failed:', text);
                        showDynamicAlert('Failed to delete photo. See console.', 'danger');
                    }
                } catch (err) {
                    console.error('Error deleting photo:', err);
                    showDynamicAlert('Network error deleting photo.', 'danger');
                } finally {
                    if (button) button.disabled = false;
                }
            });
        } else {
            if (!confirm('Are you sure you want to delete this photo?')) return;
            // fallback to original behavior if modal not available
            try { button.disabled = true; } catch (e) {}
            try {
                const response = await fetch('@Url.Action("DeleteCustomerPhoto", "Home", new { area = "Admin" })', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': antiForgeryToken },
                    body: JSON.stringify({ customerId, photoUrl })
                });
                if (response.ok) {
                    try { button.closest('.existing-photo-item')?.remove(); } catch (e) {}
                    showDynamicAlert('Photo deleted', 'success');
                } else {
                    showDynamicAlert('Failed to delete photo.', 'danger');
                }
            } catch (e) { console.error(e); showDynamicAlert('Network error deleting photo.', 'danger'); }
            finally { try { button.disabled = false; } catch (e) {} }
        }
    }


    // --- Event Listener Setup ---
    
    function setupEventListeners() {
        // --- Modal Triggers ---
        document.getElementById('editProfileBtn')?.addEventListener('click', () => {
             const status = '@Model?.Status';
             document.getElementById('editStatus').value = status;
             openModal(editProfileModal)
        });
        
        document.getElementById('addPetBtn')?.addEventListener('click', () => openModal(addPetModal));
        // Attach add pet form submit handler (with confirmation)
        document.getElementById('addPetForm')?.addEventListener('submit', function (e) { confirmAddPet(e); });
        // Adjust loyalty form uses double-confirm flow
        document.getElementById('adjustLoyaltyForm')?.addEventListener('submit', function (e) { try { e.preventDefault(); confirmAdjustLoyalty(e); } catch (ex) {} });
        document.querySelectorAll('.add-new-pet-btn').forEach(btn => btn.addEventListener('click', () => openModal(addPetModal)));

        // Prevent opening the Adjust Points modal for pending_password customers; show error instead
        document.getElementById('adjustLoyaltyBtn')?.addEventListener('click', (e) => {
            // If customer is pending password, open the modal but show an inline error and disable submit
            if (customerStatus && customerStatus.toLowerCase() === 'pending_password') {
                openModal(adjustLoyaltyModal);
                try {
                    const errEl = document.getElementById('loyaltyErrorMessage');
                    const successEl = document.getElementById('loyaltySuccessMessage');
                    if (successEl) successEl.style.display = 'none';
                    if (errEl) {
                        errEl.textContent = 'Cannot adjust points: customer account not activated.';
                        errEl.style.display = 'block';
                    }
                    // disable the submit button inside the modal to prevent attempts
                    const submitBtn = adjustLoyaltyModal?.querySelector('button[type="submit"]');
                    if (submitBtn) { submitBtn.disabled = true; submitBtn.dataset._wasDisabledByPending = 'true'; }
                } catch (ex) { console.warn('failed to show inline pending message', ex); }
                return;
            }
            // Normal flow
            openModal(adjustLoyaltyModal);
            // Ensure error message hidden and submit enabled
            try { document.getElementById('loyaltyErrorMessage').style.display = 'none'; } catch (e) {}
            try { const submitBtn = adjustLoyaltyModal?.querySelector('button[type="submit"]'); if (submitBtn) submitBtn.disabled = false; } catch (e) {}
        });

        // Hover hint is now handled by CSS using the .pending-wrapper container
        document.querySelectorAll('.adjust-points-btn').forEach(btn => btn.addEventListener('click', () => openModal(adjustLoyaltyModal)));

        // --- Modal Close/Cancel Buttons ---
        document.querySelectorAll('.edit-modal-overlay').forEach(modal => {
            // Close when clicking the background overlay
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeModal(modal);
                }
            });
            // Close when clicking a "close" or "cancel" button inside the modal
            modal.querySelector('.edit-modal-close-btn')?.addEventListener('click', () => closeModal(modal));
            modal.querySelector('.cancel-btn')?.addEventListener('click', () => closeModal(modal));
        });

        // --- Tab Navigation ---
        document.querySelector('.profile-tabs')?.addEventListener('click', (e) => {
            if (e.target.matches('[data-tab]')) {
                switchTab(e.target.dataset.tab);
            }
        });
        
        // --- Pet Actions ---
        document.getElementById('pets-content')?.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-pet-btn');
            const deleteBtn = e.target.closest('.delete-pet-btn');
            if (editBtn) {
                // Populate edit modal using data- attributes (mirror Customer-side behavior)
                const petId = editBtn.dataset.petId || '';
                document.getElementById('editPetId').value = petId;
                document.getElementById('editPetName').value = editBtn.dataset.petName || '';
                document.getElementById('editPetAge').value = editBtn.dataset.petAge || '';
                document.getElementById('editPetType').value = editBtn.dataset.petType || '';
                document.getElementById('editPetBreed').value = editBtn.dataset.petBreed || '';
                document.getElementById('editPetRemark').value = editBtn.dataset.petRemark || '';
                const photo = editBtn.dataset.petPhoto || '';
                const preview = document.getElementById('editPetPhotoPreview');
                if (preview) preview.src = photo || '/uploads/d3999c82-0883-447a-9a53-52dec5cc92d5.jpeg';
                document.getElementById('petModalTitle').textContent = '🐾 Edit Pet';
                openModal(editPetModal);
                return;
            }
            if (deleteBtn) {
                    const petId = deleteBtn.dataset.petId;
                    const petName = deleteBtn.dataset.petName || 'this pet';
                    if (typeof window.openConfirmModal === 'function') {
                        window.openConfirmModal('Confirm Delete', `Are you sure you want to delete "${petName}"?`, function() {
                            // proceed with delete
                            proceedDelete();
                        });
                    } else if (typeof window.showConfirmModal === 'function') {
                        window.showConfirmModal('Confirm Delete', `Are you sure you want to delete "${petName}"?`, 'delete', '#ef4444', function() { proceedDelete(); });
                    } else {
                        if (confirm(`Are you sure you want to delete "${petName}"?`)) { proceedDelete(); }
                    }
                    function proceedDelete() {
                        // proceed with delete
                        const formData = new FormData();
                        formData.append('petId', petId);
                        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                        if (token) formData.append('__RequestVerificationToken', token);

                        deleteBtn.disabled = true;
                        const originalText = deleteBtn.innerHTML;
                        deleteBtn.innerHTML = 'Deleting...';

                        fetch('@Url.Action("DeletePet", "Home", new { area = "Admin" })', { method: 'POST', body: formData })
                        .then(async response => {
                            const text = await response.text();
                            try {
                                const data = text ? JSON.parse(text) : {};
                                if (data.success) {
                                    showDynamicAlert(`${petName} deleted.`, 'success');
                                    setTimeout(() => location.reload(), 5000);
                                } else {
                                    console.error('DeletePet error response:', data);
                                    showDynamicAlert(data.message || 'Delete failed', 'danger');
                                    deleteBtn.disabled = false;
                                    deleteBtn.innerHTML = originalText;
                                }
                            } catch (err) {
                                console.error('Failed to parse DeletePet response as JSON:', text, err);
                                showDynamicAlert('Server error while deleting pet.', 'danger');
                                deleteBtn.disabled = false;
                                deleteBtn.innerHTML = originalText;
                            }
                        })
                        .catch(err => {
                            console.error('DeletePet request failed:', err);
                            showDynamicAlert('Request failed. See console for details.', 'danger');
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = originalText;
                        });
                    }

            }
        });

        // Fallback: global delegated listener for .delete-pet-btn in case the local handler is blocked
        document.addEventListener('click', function (e) {
            try {
                const deleteBtn = e.target && e.target.closest ? e.target.closest('.delete-pet-btn') : null;
                if (!deleteBtn) return;
                // Prevent duplicate execution if the local handler already handled it
                if (deleteBtn.__handling) return;
                deleteBtn.__handling = true;
                e.preventDefault();

                const petId = deleteBtn.dataset.petId;
                const petName = deleteBtn.dataset.petName || 'this pet';

                const proceed = function () {
                    const formData = new FormData();
                    formData.append('petId', petId);
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    if (token) formData.append('__RequestVerificationToken', token);

                    deleteBtn.disabled = true;
                    const originalText = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = 'Deleting...';

                    fetch('@Url.Action("DeletePet", "Home", new { area = "Admin" })', { method: 'POST', body: formData, credentials: 'include', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(async response => {
                            const text = await response.text();
                            try {
                                const data = text ? JSON.parse(text) : {};
                                if (data.success) {
                                    showDynamicAlert(`${petName} deleted.`, 'success');
                                    setTimeout(() => location.reload(), 5000);
                                } else {
                                    console.error('DeletePet error response:', data);
                                    showDynamicAlert(data.message || 'Delete failed', 'danger');
                                    deleteBtn.disabled = false;
                                    deleteBtn.innerHTML = originalText;
                                }
                            } catch (err) {
                                console.error('Failed to parse DeletePet response as JSON:', text, err);
                                showDynamicAlert('Server error while deleting pet.', 'danger');
                                deleteBtn.disabled = false;
                                deleteBtn.innerHTML = originalText;
                            }
                        })
                        .catch(err => {
                            console.error('DeletePet request failed:', err);
                            showDynamicAlert('Request failed. See console for details.', 'danger');
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = originalText;
                        })
                        .finally(() => { deleteBtn.__handling = false; });
                };

                if (typeof window.openConfirmModal === 'function') {
                    if (typeof window.openConfirmModal === 'function') {
                        window.openConfirmModal('Confirm Delete', `Are you sure you want to delete "${petName}"?`, proceed);
                    } else if (typeof window.showConfirmModal === 'function') {
                        window.showConfirmModal('Confirm Delete', `Are you sure you want to delete "${petName}"?`, 'delete', '#ef4444', proceed);
                    } else {
                        if (confirm(`Are you sure you want to delete "${petName}"?`)) proceed();
                    }
                } else if (typeof window.showConfirmModal === 'function') {
                    window.showConfirmModal('Confirm Delete', `Are you sure you want to delete "${petName}"?`, 'delete', '#ef4444', proceed);
                } else {
                    if (confirm(`Are you sure you want to delete "${petName}"?`)) proceed();
                }
            } catch (e) { console.warn('global delete-pet-btn handler error', e); }
        });

        // --- Edit Pet Form Submit (with confirmation) ---
        document.getElementById('editPetForm')?.addEventListener('submit', function (event) {
            event.preventDefault();
            const form = event.target;
            confirmEditPet(event);
            return;
        });

        // confirmAddPet/confirmEditPet helpers show the Groomer-style double-confirm modal
        window.confirmAddPet = function(event) {
            try { if (event && event.preventDefault) event.preventDefault(); } catch (e) {}
            const form = event && event.target ? event.target : document.getElementById('addPetForm');
            const nameInput = form ? form.querySelector('[name="petName"]') : null;
            const name = nameInput ? (nameInput.value || 'pet') : 'pet';
            if (typeof window.showConfirmModal === 'function') {
                window.showConfirmModal('Confirm Add', `Are you sure you want to add "${name}"?`, 'save', '#10b981', function() {
                    // call existing handler with a synthetic event-like object
                    handleAddPetSubmit({ target: form, preventDefault: function(){} });
                });
            } else {
                if (confirm(`Are you sure you want to add "${name}"?`)) {
                    handleAddPetSubmit({ target: form, preventDefault: function(){} });
                }
            }
        };

        window.confirmEditPet = function(event) {
            try { if (event && event.preventDefault) event.preventDefault(); } catch (e) {}
            const form = event && event.target ? event.target : document.getElementById('editPetForm');
            const nameInput = form ? form.querySelector('[name="petName"]') || form.querySelector('#editPetName') : null;
            const name = nameInput ? (nameInput.value || 'pet') : 'pet';
            if (typeof window.showConfirmModal === 'function') {
                window.showConfirmModal('Confirm Edit', `Are you sure you want to save changes to "${name}"?`, 'save', '#10b981', function() {
                    // perform the existing submit logic inline
                    (async function(form) {
                        const successMessage = document.getElementById('editPetSuccessMessage');
                        const errorMessage = document.getElementById('editPetErrorMessage');
                        const submitButton = form.querySelector('button[type="submit"]');
                        const originalText = submitButton?.innerHTML || 'Saving...';
                        if (successMessage) successMessage.style.display = 'none';
                        if (errorMessage) errorMessage.style.display = 'none';
                        if (submitButton) { submitButton.disabled = true; submitButton.innerHTML = 'Saving...'; }
                        try {
                            const formData = new FormData(form);
                            // append antiforgery token and include credentials
                            try {
                                const t = form.querySelector('input[name="__RequestVerificationToken"]')?.value;
                                if (t) formData.append('__RequestVerificationToken', t);
                            } catch (e) {}
                            const tokenHeader = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                            const response = await fetch('@Url.Action("UpdatePet", "Home", new { area = "Admin" })', {
                                method: 'POST',
                                body: formData,
                                credentials: 'include',
                                headers: tokenHeader ? { 'X-Requested-With': 'XMLHttpRequest', 'RequestVerificationToken': tokenHeader } : { 'X-Requested-With': 'XMLHttpRequest' }
                            });
                            const text = await response.text();
                            let data = {};
                            try { data = text ? JSON.parse(text) : {}; } catch { data = { success: false, message: text || 'Invalid server response' }; }
                            if (response.ok && data.success) {
                                if (successMessage) { successMessage.textContent = data.message || 'Pet updated!'; successMessage.style.display = 'block'; }
                                try { showDynamicAlert(data.message || 'Pet updated!', 'success'); } catch (e) {}
                                setTimeout(() => { closeModal(editPetModal); location.reload(); },5000);
                            } else {
                                if (errorMessage) { errorMessage.textContent = data.message || 'Failed to update pet'; errorMessage.style.display = 'block'; }
                            }
                        } catch (err) {
                            console.error('Error updating pet:', err);
                            if (errorMessage) { errorMessage.textContent = 'A network error occurred. Please try again.'; errorMessage.style.display = 'block'; }
                        } finally {
                            if (submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalText; }
                        }
                    })(form);
                });
            } else {
                if (confirm(`Are you sure you want to save changes to "${name}"?`)) {
                    // submit without confirmation modal
                    (async function(form) {
                        const successMessage = document.getElementById('editPetSuccessMessage');
                        const errorMessage = document.getElementById('editPetErrorMessage');
                        const submitButton = form.querySelector('button[type="submit"]');
                        const originalText = submitButton?.innerHTML || 'Saving...';
                        if (successMessage) successMessage.style.display = 'none';
                        if (errorMessage) errorMessage.style.display = 'none';
                        if (submitButton) { submitButton.disabled = true; submitButton.innerHTML = 'Saving...'; }
                        try {
                            const formData = new FormData(form);
                            // append antiforgery token and include credentials
                            try {
                                const t = form.querySelector('input[name="__RequestVerificationToken"]')?.value;
                                if (t) formData.append('__RequestVerificationToken', t);
                            } catch (e) {}
                            const tokenHeader2 = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                            const response = await fetch('@Url.Action("UpdatePet", "Home", new { area = "Admin" })', {
                                method: 'POST',
                                body: formData,
                                credentials: 'include',
                                headers: tokenHeader2 ? { 'X-Requested-With': 'XMLHttpRequest', 'RequestVerificationToken': tokenHeader2 } : { 'X-Requested-With': 'XMLHttpRequest' }
                            });
                            const text = await response.text();
                            let data = {};
                            try { data = text ? JSON.parse(text) : {}; } catch { data = { success: false, message: text || 'Invalid server response' }; }
                            if (response.ok && data.success) {
                                if (successMessage) { successMessage.textContent = data.message || 'Pet updated!'; successMessage.style.display = 'block'; }
                                setTimeout(() => { closeModal(editPetModal); location.reload(); },5000);
                            } else {
                                if (errorMessage) { errorMessage.textContent = data.message || 'Failed to update pet'; errorMessage.style.display = 'block'; }
                            }
                        } catch (err) {
                            console.error('Error updating pet:', err);
                            if (errorMessage) { errorMessage.textContent = 'A network error occurred. Please try again.'; errorMessage.style.display = 'block'; }
                        } finally {
                            if (submitButton) { submitButton.disabled = false; submitButton.innerHTML = originalText; }
                        }
                    })(form);
                }
            }
        };

        // Double-confirm for adjusting loyalty points
        window.confirmAdjustLoyalty = function(event) {
            try { if (event && event.preventDefault) event.preventDefault(); } catch (e) {}
            const form = event && event.target ? event.target : document.getElementById('adjustLoyaltyForm');
            if (!form) return;
            // If customer is pending_password, show inline error instead of confirm
            if (customerStatus && customerStatus.toLowerCase() === 'pending_password') {
                try { const errEl = document.getElementById('loyaltyErrorMessage'); if (errEl) { errEl.textContent = 'Cannot adjust points: customer account not activated.'; errEl.style.display = 'block'; } } catch (e) {}
                return;
            }

            const type = form.querySelector('input[name="adjustmentType"]:checked')?.value || 'add';
            const amtRaw = form.querySelector('input[name="loyaltyAmount"]')?.value || '0';
            const amt = parseInt(amtRaw, 10) || 0;
            const verb = type === 'add' ? 'add' : 'subtract';
            const pretty = `${amt} pts`;

            if (typeof window.showConfirmModal === 'function') {
                window.showConfirmModal('Confirm Adjustment', `Are you sure you want to ${verb} ${pretty} to this customer?`, 'save', '#10b981', function() {
                    // call actual submit handler
                    handleAdjustLoyaltySubmit({ target: form, preventDefault: function(){} });
                });
            } else {
                if (confirm(`Are you sure you want to ${verb} ${pretty} to this customer?`)) {
                    handleAdjustLoyaltySubmit({ target: form, preventDefault: function(){} });
                }
            }
        };
    }


    // --- Initialization ---
    initAvatarAnimation();
    setupEventListeners();
    updateLoyaltyPreview(); // Initial calculation

    // Live-update loyalty preview when amount or adjustment type changes
    try {
        if (loyaltyAmountInput) loyaltyAmountInput.addEventListener('input', updateLoyaltyPreview);
        document.querySelectorAll('input[name="adjustmentType"]').forEach(r => r.addEventListener('change', updateLoyaltyPreview));
    } catch (e) { /* ignore */ }

    // Bind edit form submit to confirm handler now that handlers are defined
    try {
        const editForm = document.getElementById('editProfileForm');
        const editName = '@(Model?.Name?.Replace("'", "\\'") ?? "")';
        if (editForm) {
            // Remove any existing handler to avoid double-binding
            if (editForm.removeEventListener) editForm.removeEventListener('submit', window.confirmEditProfile);
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                try { confirmEditProfile(e, editName); } catch (err) { console.error('confirmEditProfile missing', err); }
                return false;
            });
        }
    } catch (err) { console.warn('Binding edit form submit failed', err); }

    // --- Edit modal field validation (reuse Add Customer validation pattern) ---
    async function validateCustomerField_Edit(inputElement) {
        const rawFieldName = inputElement.name; // e.g., "Name", "Email", "Phone", "IC"
        const fieldName = rawFieldName.toLowerCase();
        const fieldValue = inputElement.value;
        const errorElement = document.getElementById(`error-${rawFieldName}`);

        if (errorElement) errorElement.textContent = '';
        if (errorElement) errorElement.classList.remove('valid');
        inputElement.classList.remove('is-invalid');

        if (inputElement.required && !fieldValue.trim()) {
            if (errorElement) errorElement.textContent = `${rawFieldName} is required.`;
            inputElement.classList.add('is-invalid');
            return;
        }

        if (!inputElement.required && !fieldValue.trim()) return;

        try {
            const response = await fetch('@Url.Action("ValidateCustomerField", "Home")', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ CustomerId: '@Model?.UserId', FieldName: fieldName, FieldValue: fieldValue })
            });

            if (!response.ok) throw new Error('Server validation failed');
            const result = await response.json();
            if (!result.isValid) {
                if (errorElement) errorElement.textContent = result.errorMessage;
                inputElement.classList.add('is-invalid');
            } else {
                if (errorElement) { errorElement.textContent = '✓ Valid'; errorElement.classList.add('valid'); }
            }
        } catch (err) {
            console.error('Edit field validation error:', err);
        }
    }

    // Attach validation handlers to edit modal inputs
    (function attachEditValidationHandlers() {
        const inputs = ['customerName','customerEmail','customerPhone','customerIC'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('blur', function () { validateCustomerField_Edit(this); });
            el.addEventListener('input', function () {
                // Clear error while typing
                const err = document.getElementById('error-' + this.name);
                if (err) { err.textContent = ''; err.classList.remove('valid'); }
                this.classList.remove('is-invalid');
            });
        });
    })();

    // --- Pet Age Validation (mirror Customer.cshtml behavior) ---
    function validatePetAgeField(inputId, errorId, submitBtnId) {
        const petAgeInput = document.getElementById(inputId);
        const errorEl = document.getElementById(errorId);
        const saveBtn = submitBtnId ? document.getElementById(submitBtnId) : null;
        if (!petAgeInput || !errorEl) return true;

        const raw = petAgeInput.value;
        if (raw === null || raw === undefined || raw === '') {
            errorEl.textContent = '';
            errorEl.classList.remove('valid','invalid');
            petAgeInput.classList.remove('is-invalid');
            petAgeInput.setCustomValidity('');
            if (saveBtn) saveBtn.disabled = false;
            return true;
        }

        const age = Number(raw);
        if (Number.isNaN(age) || !isFinite(age)) {
            errorEl.textContent = 'Age must be a number.';
            errorEl.classList.remove('valid'); errorEl.classList.add('invalid');
            petAgeInput.classList.add('is-invalid');
            petAgeInput.setCustomValidity('Invalid age');
            if (saveBtn) saveBtn.disabled = true;
            return false;
        }

        if (age < 0) {
            errorEl.textContent = 'Age cannot be negative.';
            errorEl.classList.remove('valid'); errorEl.classList.add('invalid');
            petAgeInput.classList.add('is-invalid');
            petAgeInput.setCustomValidity('Age cannot be negative');
            if (saveBtn) saveBtn.disabled = true;
            return false;
        }

        if (age > 30) {
            errorEl.textContent = 'Age cannot be greater than 30.';
            errorEl.classList.remove('valid'); errorEl.classList.add('invalid');
            petAgeInput.classList.add('is-invalid');
            petAgeInput.setCustomValidity('Age too large');
            if (saveBtn) saveBtn.disabled = true;
            return false;
        }

        // Valid
        errorEl.textContent = '✓ Valid';
        errorEl.classList.remove('invalid'); errorEl.classList.add('valid');
        petAgeInput.classList.remove('is-invalid');
        petAgeInput.setCustomValidity('');
        if (saveBtn) saveBtn.disabled = false;
        return true;
    }

    // Ensure error <small> elements exist for pet age fields
    (function ensurePetAgeErrorEls() {
        const addPetWrapper = document.querySelector('#addPetForm');
        if (addPetWrapper) {
            const existing = document.getElementById('error-PetAge');
            if (!existing) {
                const el = document.createElement('small');
                el.id = 'error-PetAge'; el.className = 'error-message';
                const petAgeInput = document.getElementById('petAge');
                if (petAgeInput && petAgeInput.parentNode) petAgeInput.parentNode.appendChild(el);
            }
        }

        const editPetWrapper = document.querySelector('#editPetForm');
        if (editPetWrapper) {
            const existing2 = document.getElementById('error-EditPetAge');
            if (!existing2) {
                const el2 = document.createElement('small');
                el2.id = 'error-EditPetAge'; el2.className = 'error-message';
                const petAgeInput2 = document.getElementById('editPetAge');
                if (petAgeInput2 && petAgeInput2.parentNode) petAgeInput2.parentNode.appendChild(el2);
            }
        }
    })();

    // Attach handlers
    (function attachPetAgeHandlers() {
        const petAgeInput = document.getElementById('petAge');
        const editPetAgeInput = document.getElementById('editPetAge');
        if (petAgeInput) {
            petAgeInput.addEventListener('input', () => validatePetAgeField('petAge','error-PetAge','addPetSaveBtn'));
            petAgeInput.addEventListener('blur', () => validatePetAgeField('petAge','error-PetAge','addPetSaveBtn'));
        }
        if (editPetAgeInput) {
            editPetAgeInput.addEventListener('input', () => validatePetAgeField('editPetAge','error-EditPetAge','editPetSaveBtn'));
            editPetAgeInput.addEventListener('blur', () => validatePetAgeField('editPetAge','error-EditPetAge','editPetSaveBtn'));
        }
    })();

    // --- Input formatting (phone & IC) ---
    function formatWithSegments(digits, segments) {
        let out = '';
        let idx = 0;
        for (let s = 0; s < segments.length; s++) {
            const segLen = segments[s];
            if (idx >= digits.length) break;
            const part = digits.substr(idx, segLen);
            out += part; idx += part.length;
            if (idx < digits.length) out += '-';
        }
        if (idx < digits.length) out += digits.substr(idx);
        return out;
    }

    function attachFormatter(inputEl, segments) {
        if (!inputEl) return;
        let previous = inputEl.value || '';
        inputEl.addEventListener('input', function (e) {
            const selStart = this.selectionStart || 0;
            const rawBeforeCursor = (this.value.slice(0, selStart) || '').replace(/[^0-9]/g, '');
            const digits = this.value.replace(/[^0-9]/g, '');
            const formatted = formatWithSegments(digits, segments);
            // compute new cursor position based on digits before cursor
            let newPos = 0; let seenDigits = 0;
            for (let i = 0; i < formatted.length; i++) {
                if (/[0-9]/.test(formatted[i])) seenDigits++;
                newPos++;
                if (seenDigits >= rawBeforeCursor.length) break;
            }
            this.value = formatted;
            try { this.setSelectionRange(newPos, newPos); } catch (err) {}
            previous = this.value;
        });
    }

    // phone: 3-remaining (e.g., 012-3456789). IC: 6-2-4
    attachFormatter(document.getElementById('customerPhone'), [3]);
    attachFormatter(document.getElementById('customerIC'), [6,2,4]);

    // --- Edit profile photo preview manager ---
    window._editSelectedFiles = [];
    const editPhotoInput = document.getElementById('editProfilePhotosInput');
    const editPhotoPreviewList = document.getElementById('editPhotoPreviewList');

    function renderEditPhotoPreviews() {
        if (!editPhotoPreviewList) return;
        editPhotoPreviewList.innerHTML = '';
        window._editSelectedFiles.forEach((file, idx) => {
            const url = URL.createObjectURL(file);
            const div = document.createElement('div');
            div.className = 'existing-photo-item selected-preview';
            div.style.position = 'relative'; div.style.width = '72px'; div.style.height = '72px'; div.style.borderRadius = '50%'; div.style.overflow = 'hidden';
            const img = document.createElement('img'); img.src = url; img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'cover'; img.alt = file.name;
            const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'delete-photo-btn remove-selected-photo'; btn.title = 'Remove selected file'; btn.textContent = '×';
            btn.style.position = 'absolute'; btn.style.top = '6px'; btn.style.right = '6px';
            btn.addEventListener('click', function () { window._editSelectedFiles.splice(idx,1); renderEditPhotoPreviews(); });
            div.appendChild(img); div.appendChild(btn); editPhotoPreviewList.appendChild(div);
        });
    }

    if (editPhotoInput) {
        editPhotoInput.addEventListener('change', function (e) {
            const files = Array.from(e.target.files || []);
            // replace selection with chosen files
            window._editSelectedFiles = files.slice(0);
            renderEditPhotoPreviews();
        });
    }

    // Wire delete buttons for existing photos (delegated)
    document.getElementById('existingPhotosContainer')?.addEventListener('click', function (e) {
        const btn = e.target.closest && e.target.closest('.delete-photo-btn');
        if (!btn) return;
        const photo = btn.dataset.photo || btn.getAttribute('data-photo');
        if (!photo) return;
        deleteCustomerPhoto(photo, btn);
    });

    // preview handler for add pet photo
    const addPetPhotoUpload = document.getElementById('addPetPhotoUpload');
    if (addPetPhotoUpload) {
            addPetPhotoUpload.addEventListener('change', function (e) {
                const file = e.target.files && e.target.files[0];
                const fileNameEl = document.getElementById('addPetPhotoFileName');
                const validationEl = document.getElementById('addPetPhotoValidationMessage');
                const saveBtn = document.getElementById('addPetSaveBtn') || (document.getElementById('addPetForm')?.querySelector('button[type="submit"]'));
                if (!file) {
                        if (fileNameEl) { fileNameEl.textContent = 'No file chosen'; fileNameEl.style.display = ''; }
                        if (validationEl) { validationEl.textContent = ''; validationEl.classList.remove('valid','invalid'); }
                        if (saveBtn) saveBtn.disabled = false;
                        return;
                }
                if (fileNameEl) { fileNameEl.textContent = `${file.name} (${formatBytes(file.size)})`; fileNameEl.style.display = 'none'; }
                const err = validatePetFile(file);
                if (err) {
                    if (validationEl) { validationEl.textContent = err; validationEl.classList.remove('valid'); validationEl.classList.add('invalid'); }
                    if (saveBtn) saveBtn.disabled = true;
                } else {
                    if (validationEl) { validationEl.textContent = `✓ Selected: ${file.name}`; validationEl.classList.remove('invalid'); validationEl.classList.add('valid'); }
                    if (saveBtn) saveBtn.disabled = false;
                }

                const reader = new FileReader();
                reader.onload = evt => {
                    const img = document.getElementById('addPetPhotoPreview');
                    if (img) img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });
    }
    // When pet type changes and no photo selected, show a type-based default preview
    const addPetTypeSelect = document.getElementById('petType');
    const addPetPhotoPreviewImg = document.getElementById('addPetPhotoPreview');
    function getTypeDefaultImg(type) {
        if (!type) return '/images/dogAvatar.png';
        const t = type.trim().toLowerCase();
        if (t === 'dog') return '/images/dogAvatar.png';
        if (t === 'cat') return '/images/catAvatar.png';
        return '/images/dogAvatar.png';
    }
    addPetTypeSelect?.addEventListener('change', function () {
        try {
            if (addPetPhotoUpload && addPetPhotoUpload.files && addPetPhotoUpload.files.length > 0) return; // user already picked a photo
            if (addPetPhotoPreviewImg) addPetPhotoPreviewImg.src = getTypeDefaultImg(this.value);
        } catch (e) { console.error('Error setting pet type default preview', e); }
    });

    // Edit-pet modal: if changing type and no custom photo chosen, update preview accordingly
    const editPetTypeSelect = document.getElementById('editPetType');
    const editPetPhotoPreviewImg = document.getElementById('editPetPhotoPreview');
    editPetTypeSelect?.addEventListener('change', function () {
        try {
            if (editPetPhotoUpload && editPetPhotoUpload.files && editPetPhotoUpload.files.length > 0) return;
            if (editPetPhotoPreviewImg) editPetPhotoPreviewImg.src = getTypeDefaultImg(this.value);
        } catch (e) { console.error('Error setting edit pet default preview', e); }
    });
    
        // preview + validation handler for edit pet photo
        const editPetPhotoUpload = document.getElementById('editPetPhotoUpload');
        if (editPetPhotoUpload) {
            editPetPhotoUpload.addEventListener('change', function (e) {
                const file = e.target.files && e.target.files[0];
                const fileNameEl = document.getElementById('editPetPhotoFileName');
                const validationEl = document.getElementById('editPetPhotoValidationMessage');
                const saveBtn = document.getElementById('editPetSaveBtn') || (document.getElementById('editPetForm')?.querySelector('button[type="submit"]'));
                if (!file) {
                        if (fileNameEl) { fileNameEl.textContent = 'No file chosen'; fileNameEl.style.display = ''; }
                        if (validationEl) { validationEl.textContent = ''; validationEl.classList.remove('valid','invalid'); }
                        if (saveBtn) saveBtn.disabled = false;
                        return;
                }
                if (fileNameEl) { fileNameEl.textContent = `${file.name} (${formatBytes(file.size)})`; fileNameEl.style.display = 'none'; }
                const err = validatePetFile(file);
                if (err) {
                    if (validationEl) { validationEl.textContent = err; validationEl.classList.remove('valid'); validationEl.classList.add('invalid'); }
                    if (saveBtn) saveBtn.disabled = true;
                } else {
                    if (validationEl) { validationEl.textContent = `✓ Selected: ${file.name}`; validationEl.classList.remove('invalid'); validationEl.classList.add('valid'); }
                    if (saveBtn) saveBtn.disabled = false;
                }

                const reader = new FileReader();
                reader.onload = evt => {
                    const img = document.getElementById('editPetPhotoPreview');
                    if (img) img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // small helpers for validation
        function formatBytes(bytes) {
                if (!bytes) return '0 B';
                const k = 1024;
                const sizes = ['B','KB','MB','GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function validatePetFile(file) {
                if (!file) return null;
                const allowed = ['image/jpeg','image/png','image/gif','image/webp'];
                const max = 5 * 1024 * 1024;
                if (allowed.indexOf(file.type) === -1) return 'Invalid file type. Use JPG/PNG/GIF/WEBP.';
                if (file.size > max) return `File too large (${formatBytes(file.size)}). Max 5MB.`;
                return null;
        }
    
        }); // end DOMContentLoaded

    </script>
    }

    