@model IEnumerable<PetGroomingAppointmentSystem.Models.RedeemGift>
@{
    ViewData["Title"] = "Redeem Gift Management";
    ViewData["ActivePage"] = "RedeemGift";
    string editingId = Context.Request.Query["editId"];
    var editingGift = Model.FirstOrDefault(g => g.GiftId == editingId);
}
@section Styles {
    <style>
       

        /* Position the server-rendered alert like Groomer (aligned with topbar/sidebar) */
        #alertMessage {
            position: fixed;
            top: 85px;
            left: calc(var(--sidebar-width) + 35px);
            right: 35px;
            z-index: 9999;
            padding: 24px 32px !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            animation: slideDown 0.5s ease;
        }

            #alertMessage.alert-success {
                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
                color: #065f46 !important;
                border-left: 6px solid #10b981 !important;
            }

            #alertMessage.alert-danger {
                background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%) !important;
                color: #991b1b !important;
                border-left: 6px solid #ef4444 !important;
            }

            #alertMessage.alert-warning {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
                color: #92400e !important;
                border-left: 6px solid #f59e0b !important;
            }

            #alertMessage strong {
                font-size: 20px !important;
                margin-right: 8px;
            }

            #alertMessage.fade-out {
                animation: fadeOut 0.5s ease forwards;
            }
    </style>
}
@* ========== 消息显示 ========== *@
@if (ViewData["Error"] != null)
{
    <div class="alert alert-danger" id="alertMessage">
        <strong>❌ Error:</strong> @ViewData["Error"]
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success" id="alertMessage">
        <strong>✔️ Success:</strong> @TempData["SuccessMessage"]
    </div>
}

@if (TempData["WarningMessage"] != null)
{
    <div class="alert alert-warning" id="alertMessage">
        @TempData["WarningMessage"]
    </div>
}

<div class="content-header">
    <h1 class="page-title">Redeem Gift Management</h1>
</div>
<div class="panel">
    <div class="panel-header-wrapper">
        <h3 class="panel-title">Redeem Gifts (@Model.Count())</h3>
    </div>

    <div class="actions">
        <button class="btn btn-primary" onclick="showCreateForm()">
            <i class="material-icons">add</i>
            Add New Gift
        </button>
    </div>

    <!-- Create New Gift Form (Hidden by default) -->
    <div class="panel create-form" id="createGiftForm" style="display: none;">
        <h3 class="panel-title">Create New Gift</h3>

        <form id="addGiftForm" asp-action="RedeemGift" asp-controller="Home" method="post" enctype="multipart/form-data" class="form-grid" onsubmit="return confirmAdd(event)">
            @Html.AntiForgeryToken()
            <input type="hidden" name="actionType" value="add" />

            <!-- Gift Name -->
            <div class="form-group">
                <label for="giftName">Gift Name</label>
                <input type="text" id="giftName" name="Name" placeholder="e.g., Pet Toy, Food Voucher" required />
            </div>

            <!-- Quantity -->
            <div class="form-group">
                <label for="quantity">Quantity</label>
                <input type="number" id="quantity" name="Quantity" min="0" placeholder="Available stock" required />
            </div>

            <!-- Points Cost -->
            <div class="form-group">
                <label for="points">Loyalty Points Cost</label>
                <input type="number" id="points" name="LoyaltyPointCost" min="0" placeholder="Points required" required />
            </div>

            <!-- Photo Upload -->
            <div class="form-group">
                <label for="photo">Gift Photo</label>
                <input type="file" 
                       id="photo" 
                       name="PhotoUpload" 
                       accept="image/*" 
                       required 
                       onchange="handlePhotoUpload(this, 'create')" />
                <span id="uploadStatus_create" 
                      style="display: none; font-size: 12px; margin-top: 5px; display: block; color: #10b981; font-weight: 600;">
                </span>
            </div>

            <!-- Save Button -->
            <div class="form-actions">
                <button type="submit" class="btn btn-success">
                    <i class="material-icons">add</i>
                    Save Gift
                </button>
                <button type="button" class="btn btn-action" onclick="hideCreateForm()">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    @if (Model.Any())
    {
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Gift ID</th>
                        <th>Name</th>
                        <th>Qty</th>
                        <th>Points Cost</th>
                        <th>Photo</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var gift in Model)
                {
                    if (editingGift != null && editingGift.GiftId == gift.GiftId)
                    {
                        // Inline edit row
                        <tr>
                        <form id="editGiftForm_@gift.GiftId" asp-action="RedeemGift" asp-controller="Home" method="post" enctype="multipart/form-data" onsubmit="return confirmEdit(event, '@gift.Name')">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="actionType" value="edit" />
                            <input type="hidden" name="editGiftId" value="@gift.GiftId" />
                            <td>@gift.GiftId</td>
                            <td><input type="text" name="Name" value="@gift.Name" required class="form-control" /></td>
                            <td><input type="number" name="Quantity" value="@gift.Quantity" required class="form-control" /></td>
                            <td><input type="number" name="LoyaltyPointCost" value="@gift.LoyaltyPointCost" required class="form-control" /></td>
                                <td>
                                    <input type="file" name="PhotoUpload" accept="image/*" class="form-control"
                                           id="photoInput_@gift.GiftId" onchange="handlePhotoUpload(this, '@gift.GiftId')" />
                                    <div id="uploadStatus_@gift.GiftId" style="display: none; color: #10b981; font-size: 12px; font-weight: 600; margin-top: 5px;">
                                        <!-- JavaScript will fill this -->
                                    </div>
                                    @if (!string.IsNullOrEmpty(gift.Photo))
                                    {
                                        <small class="text-muted d-block mt-1" style="font-size: 12px;">Current: <img src="@gift.Photo" alt="Current" style="width: 60px; height: 60px; object-fit: cover; margin-top: 5px;" /></small>
                                    }
                                </td>
                            <td>
                                <button type="submit" class="btn btn-success btn-sm">Save</button>
                                <a asp-action="RedeemGift" asp-controller="Home" class="btn btn-secondary btn-sm">Cancel</a>
                            </td>
                        </form>
                        </tr>
                    }
                    else
                    {
                        <tr>
                            <td>@gift.GiftId</td>
                            <td>@gift.Name</td>
                            <td>@gift.Quantity</td>
                            <td>@gift.LoyaltyPointCost</td>
                            <td>
                                @if (!string.IsNullOrEmpty(gift.Photo))
                                {
                                    <img src="@gift.Photo" alt="Photo" style="width: 70px; height: auto;" />
                                }
                            </td>
                            <td>
                                <a asp-action="RedeemGift" asp-controller="Home" asp-route-editId="@gift.GiftId" class="btn btn-sm btn-action edit-btn">Edit</a>
                                <form id="deleteGiftForm_@gift.GiftId" asp-action="RedeemGift" asp-controller="Home" method="post" style="display:inline" onsubmit="return confirmDelete(event, '@gift.Name')">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="actionType" value="delete" />
                                    <input type="hidden" name="deleteGiftId" value="@gift.GiftId" />
                                    <button type="submit" class="btn btn-sm btn-action delete-btn">
                                        Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="empty-state"><p>No redeem gifts found.</p></div>
    }
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-backdrop">
    <div class="modal-content" style="max-width: 450px;">
        <span class="close-btn" onclick="closeConfirmModal()">&times;</span>
        <div style="text-align: center; padding: 20px 0;">
            <div style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;">
                <i class="material-icons" id="confirmIcon" style="font-size: 64px;">help_outline</i>
            </div>
            <h3 id="confirmTitle" style="margin-bottom: 15px; color: var(--text-color);">Confirm Action</h3>
            <p id="confirmMessage" style="color: var(--text-light); margin-bottom: 30px; font-size: 15px;"></p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="closeConfirmModal()" class="btn btn-action" style="min-width: 100px;">
                    Cancel
                </button>
                <button id="confirmBtn" class="btn btn-primary" style="min-width: 100px;">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Replace the simple auto-hide with the Groomer-style behavior:
    (function () {
        const alertMessage = document.getElementById('alertMessage');
        if (!alertMessage) return;

        // Auto-hide after 5 seconds with fade animation
        setTimeout(function () {
            alertMessage.classList.add('fade-out');
            // remove from DOM after fade completes
            setTimeout(function () {
                if (alertMessage && alertMessage.parentNode) {
                    alertMessage.parentNode.removeChild(alertMessage);
                }
            },500);
        },5000);
    })();

    // Page-local fallbacks if admin.js didn't load or expose helpers
    (function() {
     if (typeof window.showConfirmModal === 'function') return; // global available

     window.showConfirmModal = function(title, message, icon, iconColor, confirmCallback) {
     var modal = document.getElementById('confirmModal');
     var confirmBtn = document.getElementById('confirmBtn');
     var confirmIcon = document.getElementById('confirmIcon');
     var confirmTitle = document.getElementById('confirmTitle');
     var confirmMessage = document.getElementById('confirmMessage');
     if (!modal || !confirmBtn || !confirmIcon || !confirmTitle || !confirmMessage) {
     // fallback to native confirm
     if (confirm(message)) { confirmCallback && confirmCallback(); }
     return;
     }
     confirmTitle.textContent = title || 'Confirm';
     confirmMessage.textContent = message || '';
     confirmIcon.textContent = icon || 'help_outline';
     confirmIcon.style.color = iconColor || '#000';
     modal.classList.add('show');
     var newBtn = confirmBtn.cloneNode(true);
     confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
     newBtn.addEventListener('click', function(e) {
     e.preventDefault();
     confirmCallback && confirmCallback();
     modal.classList.remove('show');
     });
     };

     window.closeConfirmModal = function() {
     var modal = document.getElementById('confirmModal');
     if (modal) modal.classList.remove('show');
     };

     window.openConfirmModal = function(title, message, cb) {
     window.showConfirmModal(title, message, 'delete', '#ef4444', cb);
     };

     window.confirmDelete = function(event, name) {
     if (event && event.preventDefault) event.preventDefault();
     var form = (event && event.target) ? event.target : null;
     window.openConfirmModal('Confirm Delete', 'Are you sure you want to delete "' + name + '"?', function() {
     if (form) form.submit();
     });
     return false;
     };

     window.confirmAdd = function(event) {
     if (event && event.preventDefault) event.preventDefault();
     var form = (event && event.target) ? event.target : null;
     var name = form && form.querySelector('[name="Name"]') ? form.querySelector('[name="Name"]').value : 'item';
     window.openConfirmModal('Confirm Add', 'Are you sure you want to add "' + name + '"?', function() {
     if (form) form.submit();
     });
     return false;
     };

     window.showDynamicAlert = function(message, type) {
     var existing = document.getElementById('alertMessage');
     if (existing) existing.remove();
     var alertDiv = document.createElement('div');
     alertDiv.id = 'alertMessage';
     alertDiv.className = 'alert ' + (type === 'success' ? 'alert-success' : (type === 'warning' ? 'alert-warning' : 'alert-danger'));
     if (type === 'success') alertDiv.innerHTML = '<strong>✔️ Success:</strong> ' + message;
     else if (type === 'warning') alertDiv.innerHTML = message;
     else alertDiv.innerHTML = '<strong>❌ Error:</strong> ' + message;
     document.body.appendChild(alertDiv);
     setTimeout(function() { alertDiv.classList.add('fade-out'); setTimeout(function(){ if (alertDiv && alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv); },500); },5000);
     };
    })();
</script>
